 

 
 

 

 

 

 

 

 

 

 

 

 

 
 

 

 

 

 

 

 

 

 

 

 

 

 

 

 

 

 

 

 

インシデント調査のための攻撃ツール等の実行痕跡調査に関する 

報告書 

 

一般社団法人 JPCERT コーディネーションセンター 

2016 年 6 月 28 日 

インシデント調査のための攻撃ツール等の実行痕跡調査に関する報告書

目次

1. はじめに ............................................................................................................................ 4 
2. 調査方法 ........................................................................................................................... 5 

2.1.  調査実施内容 ......................................................................................................................... 5 
2.2.  調査したツール ........................................................................................................................ 6 
2.3.  調査の実施環境 ...................................................................................................................... 8 

3. 調査結果 ........................................................................................................................... 9 

3.1.  本章の構成 ............................................................................................................................. 9 
3.2.  コマンド実行 ........................................................................................................................... 11
3.2.1.  PsExec ........................................................................................................................... 11 
3.2.2.  wmic .............................................................................................................................. 13 
3.2.3.  PowerShell .................................................................................................................... 14 
3.2.4.  wmiexec.vbs ................................................................................................................. 15 
3.2.5.  BeginX .......................................................................................................................... 17 
3.2.6.  WinRM .......................................................................................................................... 18 
3.2.7.  WinRS ........................................................................................................................... 20 
3.2.8. 
at ................................................................................................................................... 22 
3.2.9.  BITS .............................................................................................................................. 24 
3.3.  パスワード、ハッシュの入手 ................................................................................................... 25 
3.3.1.  PWDump7 .................................................................................................................... 25 
3.3.2.  PWDumpX .................................................................................................................... 26 
3.3.3.  Quarks PwDump .......................................................................................................... 28 
3.3.4.  Mimikatz (パスワードハッシュ入手) ............................................................................ 29 
3.3.5.  Mimikatz (チケット入手) .............................................................................................. 30 
3.3.6.  WCE.............................................................................................................................. 31 
gsecdump ..................................................................................................................... 32 
3.3.7. 
3.3.8. 
lslsass ........................................................................................................................... 33 
3.3.9.  Find-GPOPasswords.ps1 ............................................................................................. 34 
3.3.10.  Mail PassView ........................................................................................................... 35 
3.3.11.  WebBrowserPassView .............................................................................................. 36 
3.3.12. 
Remote Desktop PassView ...................................................................................... 37 
3.4.  通信の不正中継 .................................................................................................................... 38 
3.4.1.  Htran ............................................................................................................................. 38 
3.4.2.  Fake wpad .................................................................................................................... 39 
3.5.  リモートログイン ..................................................................................................................... 41 
3.5.1.  リモートディスクトップ  (RDP) .................................................................................. 41
3.6.  Pass-the-hash, Pass-the-ticket ............................................................................................ 42 
3.6.1.  WCE (リモートログイン) ............................................................................................. 42 

11インシデント調査のための攻撃ツール等の実行痕跡調査に関する報告書

3.10. 

3.10.1. 
3.10.2. 

3.11.1. 

3.6.2.  Mimikatz(リモートログイン) ........................................................................................ 44 
3.7.  SYSTEM 権限に昇格 ........................................................................................................... 45 
3.7.1.  MS14-058 Exploit ......................................................................................................... 45 
3.7.2.  MS15-078 Exploit ......................................................................................................... 46 
3.8.  権限昇格 ............................................................................................................................... 47 
3.8.1.  SDB UAC Bypass ......................................................................................................... 47 
3.9.  ドメイン管理者権限,  アカウントの奪取 ................................................................................... 49 
3.9.1.  MS14-068 Exploit ......................................................................................................... 49 
3.9.2.  Mimikatz (Golden Ticket) .............................................................................................. 51 
3.9.3.  Mimikatz (Silver Ticket) ................................................................................................. 52 
Active Directory データベースの奪取 ................................................................................ 53 
ntdsutil ....................................................................................................................... 53 
vssadmin ................................................................................................................... 54 
3.11.  ローカルユーザー・グループの追加・削除 .......................................................................... 55 
net user ..................................................................................................................... 55 
3.12.  ファイル共有 ...................................................................................................................... 56 
net use ...................................................................................................................... 56 
net share ................................................................................................................... 57 
icacls ......................................................................................................................... 58 
3.13.  痕跡の削除 ....................................................................................................................... 59 
sdelete ....................................................................................................................... 59 
timestomp.................................................................................................................. 60 
3.14.  イベントログの消去 ............................................................................................................ 61 
wevtutil ...................................................................................................................... 61 
3.15.  アカウント情報の取得 ........................................................................................................ 62 
csvde ......................................................................................................................... 62 
ldifde .......................................................................................................................... 64 
dsquery ..................................................................................................................... 65 
3.16.  ツールの実行成功時に見られる痕跡 ................................................................................. 66 

3.15.1. 
3.15.2. 
3.15.3. 

3.12.1. 
3.12.2. 
3.12.3. 

3.13.1. 
3.13.2. 

3.14.1. 

4. 追加ログ取得について ..................................................................................................... 68 

4.1.  追加ログ取得の重要性 .......................................................................................................... 68 
4.2.  追加ログ取得設定の影響 ...................................................................................................... 68 

5. インシデント調査における本報告書の活用方法 ................................................................ 69 

5.1.  本報告書を使用したインシデント調査 .................................................................................... 69 

6. おわりに .......................................................................................................................... 70 
7. 付録  A ............................................................................................................................ 71 

7.1.  Sysmon のインストール方法 ................................................................................................. 71 
7.2.  監査ポリシーの有効化方法 ................................................................................................... 71 

8. 付録  B ............................................................................................................................ 75 

22インシデント調査のための攻撃ツール等の実行痕跡調査に関する報告書

索引 ........................................................................................................................................ 77 

33インシデント調査のための攻撃ツール等の実行痕跡調査に関する報告書

1. はじめに

近年のサイバー攻撃では、マルウエアに感染したマシンを侵入の起点として、他のマシンへの感

染拡大や、内部サーバへの侵入など、組織内の至るところを侵害する事例が多く確認されている。

こうした事案においては調査対象ポイントが多数になるので、それらを重大な事象を見落とすこと

なく迅速に調査して、できる限り正確に被害の全体像を掌握し、善後策の立案に必要な事実を収集

するための手立てが求められている。

一方、攻撃対象であるネットワークの構成は組織によって様々だが、攻撃の手口にはよく見られ

る共通したパターンが存在する。ネットワーク内部に侵入した攻撃者は、まず侵入した端末の情報
を、ipconfig や systeminfo  などの Windows で標準的に準備されているツールを使用して収集し、
次に、net 等のツールを利用してネットワークに接続されている他の端末の情報や、ドメイン情報、
アカウント情報などを調査する。調査した情報を基に次に侵入する端末を選んだら、ユーザのパス
ワード情報を盗み出すためにパスワードダンプツール mimikatz や PwDump 等のツールを使用し、
パスワード情報を入手する。そして、net や at 等のツールを駆使して他の端末に侵入し、機密情報
を収集するのである。

このような常套的な攻撃手口の中で使用されるツールも同じものが使用されることが多い。この

ような攻撃者によって使われることが多い代表的なツールがどのようなものか、さらに、それらが

使用されると、どこにどのような痕跡が残るのかを把握していれば、多数の調査対象ポイントを体

系的かつ迅速に調査できるようになると考えられる。

このような利用を想定した上で、JPCERT コーディネーションセンター  (以下「JPCERT/CC」と
いう。)  では、近年確認されている組織内ネットワークでのインシデント調査を通じて、多くの攻
撃者が使用するツールを抽出し、それらツールの実行でサーバやクライアントにどのようなログが

残るのか、またどのような設定をすれば十分な情報を含むログを取得できるようになるのかを調査

した。本報告書は、その調査結果をまとめたものである。

    本書の構成は次のとおりである。まず、第 2 章では、本調査を行った環境や実際に調査したツー
ルについて説明する。続いて第 3 章では、本調査の結果について説明する。第 4 章には、第 3 章で
記載した調査結果を基にインシデント調査をする方法について説明する。

44インシデント調査のための攻撃ツール等の実行痕跡調査に関する報告書

2. 調査方法

本章では、本調査の方法について記載する。

2.1.  調査実施内容 

本調査の目的は、インシデント調査のためのログ分析において、多くの攻撃者が使用するツール

の実行痕跡を読み解くことによって、攻撃の実像に迫ろうとする分析者のために参考となる、基礎

的な情報を整理して提供することにある。すなわち、ログに記録された情報から、どのツールが実

行されたのかを割り出し、また逆に、あるツールが実行された場合に、どのような情報がどのログ

に記録されるのかを提示することにより、効果的なログ調査をガイドできるような辞書づくりを目

指した。

本調査では、多くの攻撃者によって使用されていると我々が考えたツールについて調査している。

どのようなツールを多くの攻撃者が使用していると我々が考えたかに関しては次節で述べる。調査

するログなどの対象は、インシデント調査の専門家ではない人でも比較的容易に調べることができ

る次の項目を対象とした。

 イベントログ

 実行履歴

 レジストリエントリ

なお、Windows の標準設定では調査のために十分なイベントログを取得できない。本調査では、次
の設定をした場合とデフォルト設定のままの場合について記録されるログを調査した。

 監査ポリシーの有効化

 Sysmon のインストール

監査ポリシーとは、Windows に標準で搭載されているログオン・ログオフやファイルアクセスな
どの詳細なログを取得するための設定である。監査ポリシーは、ローカル  グループ  ポリシーから
確認、設定変更することができる。

また、Sysmon はマイクロソフトが提供するツールで、プロセスの起動、ネットワーク通信、ファ
イルの変更などをイベントログに記録することができる。Sysmon をインストールすると以下のよ
うにイベントビューアーから記録されたログを確認することができるようになる。

55インシデント調査のための攻撃ツール等の実行痕跡調査に関する報告書 

図  2-1:  イベント  ビューアーから Sysmon のログを確認 

 

 

本調査では、2.2 節で記載したツールを Windows のドメインコントローラおよびクライアントか
らなる仮想環境ネットワーク上で実際に実行し、実行の前後でのシステムの変化を調べる方法によ
り、実行履歴とイベントログ、レジストリエントリの記録を調査して、3 章にまとめた。調査に利
用したネットワーク環境の詳細は 2.3 節で述べる。 

2.2.  調査したツール 

JPCERT/CC が対応したインシデント調査で、複数の事案で攻撃者による使用が確認されたものの
中から、コマンド実行やパスワードハッシュの入手、リモートログインなどの攻撃動作に直接つな
がるものを中心に 44 種類を、インシデント調査において鍵となる、多くの攻撃者が使用するツール
として選定した。それらをツールの攻撃者による使用目的ごとに分類して表  2-1 に示す。 

表  2-1:  調査したツール一覧 

  攻撃者がツールを使用する目的 

コマンド実行 

ツール 
PsExec 
wmic 

PowerShell 
wmiexec.vbs 

BeginX 
winrm 

 
 

章番号 
3.2.1 
3.2.2 
3.2.3 
3.2.4 
3.2.5 
3.2.6 

66インシデント調査のための攻撃ツール等の実行痕跡調査に関する報告書

攻撃者がツールを使用する目的

パスワード、ハッシュの入手

通信の不正中継

（パケットトンネリング）

リモートログイン
Pass-the-hash 
Pass-the-ticket 

SYSTEM 権限に昇格 

権限昇格

ドメイン管理者権限

アカウントの奪取

ツール

at 

winrs 
BITS 

PWDump7 
PWDumpX 

Quarks PwDump 

Mimikatz(パスワードハッシュ入手) 

Mimikatz(チケット入手) 

WCE 

gsecdump 

lslsass 

Find-GPOPasswords.ps1 

Mail PassView 

WebBrowserPassView 

Remote Desktop PassView 

Htran 

Fake wpad 

RDP 

WCE (リモートログイン) 

Mimikatz (リモートログイン) 

MS14-058 Exploit 
MS15-078 Exploit 
SDB UAC Bypass 
MS14-068 Exploit 

Golden Ticket (Mimikatz) 

Silver Ticket (Mimikatz) 

Active Directory データベースの奪取 

（ドメイン管理者ユーザの作成、もしくは

管理者グループに追加）

ローカルユーザー・グループの追加・削除

ファイル共有

痕跡の削除

イベントログの削除

ntdsutil 

vssadmin 

net user 
net use 
net share 

icacls 
sdelete 

timestomp 
wevtutil 

章番号
3.2.7 
3.2.8 
3.2.9 
3.3.1 
3.3.2 
3.3.3 
3.3.4 
3.3.5 
3.3.6 
3.3.7 
3.3.8 
3.3.9 
3.3.10 
3.3.11 
3.3.12 
3.4.1 
3.4.2 
3.5.1 
3.6.1 
3.6.2 
3.7.1 
3.7.2 
3.8.1 
3.9.1 
3.9.2 

3.9.3 

3.10.1 

3.10.2 

3.11.1 
3.12.1 
3.12.2 
3.12.3 
3.13.1 
3.13.2 
3.14.1 

77インシデント調査のための攻撃ツール等の実行痕跡調査に関する報告書

攻撃者がツールを使用する目的

アカウント情報の取得

ツール
csvde 
ldifde 
dsquery 

章番号
3.15.1 
3.15.2 
3.15.3 

2.3.  調査の実施環境

本調査では、攻撃の対象となるシステムを単純化した一対のクライアントとサーバからなるシス

テムを仮想環境ネットワーク上に構築し、この上でツールを実行して、実行に伴うファイルやレジ
ストリ等の変化を観測した。クライアントとサーバには、それぞれの次のバージョンの Windows OS
を搭載した、合計 4 通りのシステム構成について調査した。また、サーバ上には Active Directory を
稼働させてクライアントを管理する構成をとった。

 クライアントの搭載 OS

 Windows 7 Professional Service Pack 1

 Windows 8.1 Pro

 サーバの搭載 OS

 Windows Server 2008 R2 Service Pack 1

 Windows Server 2012 R2

88インシデント調査のための攻撃ツール等の実行痕跡調査に関する報告書

3. 調査結果

本章では、本調査で検証したツールの機能等の基本情報と、当該ツールを実行した時に記録され

るログ情報をまとめている。基本情報については、攻撃者の視点を交えて一連の攻撃の中でのツー
ルの意味合いを理解しやすいように努めた。また、本章では、2.1 節で記載した設定を行った上で取
得可能なログの詳細について記載している。（なお、監査ポリシーの設定および Sysmon のインスト
ール方法については、7 章に記載している。）

3.1.  本章の構成 

以降では、44 種類の各ツールについて、以下のような表形式で解説している。 

図  3-1:  次節以降の記載内容 

9インシデント調査のための攻撃ツール等の実行痕跡調査に関する報告書

各項目で記載している内容について以下で説明する。

① ツールについての解説

 ツールを使用された場合の影響やツールを使用する際の権限、通信方式、関連するサー

ビスについて記載

② 検証環境

 接続元および接続先の OS 情報

③ ログ保存場所

 レジストリ、イベントログの保存場所

④ 実行成功時に確認できる痕跡

 ツールの実行が、成功したことを確認する方法を記載

⑤ イベントログ、レジストリ、ファイルに記載される情報

 この項目の記載内容に一致しているものがある場合は、当該ツールの実行によって記録

された可能性があるため、調査する必要がある

⑥ ログの中で確認できる重要な情報

 対象のログで記録される調査に活用できる重要な情報を記載（すべての記録される情報

を記載しているわけではない）

⑦ 当該ログの取得に追加設定が必要かどうか

 標準設定で取得可能な場合「-」、追加設定が必要な場合「必要」

⑧ 記載のもの以外で出力される可能性のあるイベントログ

 その他に記録される可能性があるログがある際のみ記載

1010コマンド実行 > PsExec

 凡例
・取得出来る情報
・イベントID・項目名
・フィールド名
・"フィールドの値"

追加
設定

必要

必要

-

-

必要

3.2.1. PsExec

<基本情報>

ツール

ツール名称

カテゴリ

ツール概要

攻撃時における

想定利用例

権限

対象OS

動作条件

ドメインへの参加

通信プロトコル

サービス

標準設定

追加設定

ログから

得られる情報

実行成功時に確認できる痕跡

<確認ポイント>

PsExec
コマンド実行
リモートシステム上でプロセスを実行する
ドメイン内の端末やサーバーに対して、リモートでコマンドを実行する
・接続元： PsExecコマンド実行元
・接続先： PsExecコマンドによってログインされた先
・接続元： 標準ユーザー
・接続先： 管理者ユーザー
Windows
不要
135/tcp、445/tcp、ランダムなHigh Port
※ ドメイン環境下で実行する場合は、ドメインコントローラとのKerberos認証通信が発生する
-
・接続元： PsExecの使用許諾契約に同意した旨のレジストリが記録される
・接続先： "PSEXESVC"サービスがインストールされ、開始・終了したことが記録される
・実行履歴（Sysmon・監査ポリシー）

・接続元： PsExecプロセスを実行したこと、接続先にネットワーク接続したこと、リモート実行されたコマンド名及び引数が記録される
・接続先： PSEXESVCのバイナリが作成・アクセスされたこと、接続元からネットワーク接続されたこと、リモート実行されたコマンド名及び引数が記録される

以下が確認できた場合、PsExecが実行された可能性がある
・接続元： イベントログに以下のログがある場合

・イベントログ「セキュリティ」にpsexec.exeのイベントID 4689 （プロセスが終了しました）が記録され、実行結果（戻り値）が"0x0"となっている

・接続先： PSEXESVC.exeがインストールされている

通信

ログの生成場所

ログ種別・名称

取得情報の詳細

イベントログ

-

セキュリティ

イベントログ

-

Sysmon

接続元

イベントID： 4688 （新しいプロセスが作成されました）

 4689 （プロセスが終了しました）

・プロセス情報 -> プロセス名：   "[実行ファイル（psexec.exe）]"

・確認できる情報

・プロセスの開始・終了日時 ：
・プロセスを実行したユーザー名 ：
・プロセスを実行したユーザーのドメイン ：  サブジェクト -> アカウント ドメイン
・プロセス実行時の権限昇格の有無 ：
・プロセスの戻り値 ：

 プロセス情報 -> トークン昇格の種類
  プロセス情報 -> 終了状態

ログの日付
サブジェクト -> アカウント名

イベントID： 1 （Process Create）

 5 （Process Terminated）

・Image： "[実行ファイル（psexec.exe）]"

・確認できる情報

・プロセスの開始・終了日時（UTC） ：
・プロセスのコマンドライン ：
・実行ユーザ名 ：
・プロセスID ：

 UtcTime
 CommandLine ※ コマンドライン内の引数に、リモート実行されたコマンドが記録される
 User

   ProcessId

実行履歴

レジストリエントリ： HKEY_USERS\[SID]\Software\Sysinternals\PsExec

-

レジストリ

・EulaAccepted
※ 過去にPsExecを実行したことが無い場合、使用許諾契約に同意した旨のレジストリが出力される

 (過去に実行している場合、レジストリの内容は変化しない)

イベントID： 7045 （サービスがシステムにインストールされました）

イベントログ

-

システム

・確認できる情報

・プロセス名： "PSEXESVC"
・パス：

 "%SystemRoot%\PSEXESVC.exe"

イベントID： 7036 （サービスの状態が移行しました）

※ サービス"PSEXESVC"が、リモートプロセス実行前に"実行中"となり、実行後に"停止"となる

イベントID： 5156 （フィルタリング プラットフォームによる接続の許可）

※ 接続元から接続先に対して、宛先ポートを135及び445とした通信が発生する

(例： 192.168.0.10:49210から192.168.0.2:445への通信がWindows フィルタリング プラットフォームにより、接続が許可されました）

※ 接続元から接続先に対して、ランダムなHigh Port（1024以上のポート）を宛先ポートとした通信が発生する

OS：Windows

ユーザー

↓

OS：Windows

管理者ユーザー

イベントID： 5140 （ネットワーク共有オブジェクトにアクセスしました）

・確認できる情報

・接続された日時：
・接続に使用されたアカウント： サブジェクト -> セキュリティID及びアカウント名
・接続元端末：
・接続された共有：

 ネットワーク情報 -> 接続元IPアドレス及び接続元ポート
  "\??\C:\Windows" （管理共有）

ログの日付  ※ PSEXESVC.exeの開始より前の日時となる

接続先

イベントログ

-

セキュリティ

イベントID： 4672 （新しいログオンに特権を割り当てました）    ※ このイベントが発生する前に、イベント 4624が発生する

イベント4624でログオンしたアカウントに対して、特権が割り当てられる

・確認できる情報

・接続に使用されたアカウント： サブジェクト -> セキュリティID及びアカウント名
・割り当てられた特権：

 特権

イベントID： 4656 （オブジェクトに対するハンドルが要求されました）、4663 （オブジェクトへのアクセスが試行されました）

・オブジェクト -> オブジェクト名:"C:\Windows\PSEXESVC.exe"

イベントID： 5140 （ネットワーク共有オブジェクトにアクセスしました）

・確認できる情報

・接続に使用されたアカウント： サブジェクト -> セキュリティID及びアカウント名
・接続元端末：
・接続された共有：

 ネットワーク情報 -> 接続元IPアドレス及び接続元ポート
  "\\*\IPC$" （管理共有）

イベントID： 5145 （ネットワーク共有オブジェクトに対する、クライアントのアクセス権をチェックしました） ※ 同イベントIDは数度記録される

・確認できる情報

・接続に使用されたアカウント： サブジェクト -> セキュリティID及びアカウント名
・接続元端末：
・対象となる共有：

 ネットワーク情報 -> 接続元IPアドレス及び接続元ポート
 共有情報 -> 対象パス  ※ 対象パスに含まれるものには、"PSEXESVC"及び"\\??\C:\Windows"がある

イベントID： 4656 （オブジェクトに対するハンドルが要求されました）

 4660 （オブジェクトが削除されました）
 4658 （オブジェクトに対するハンドルが閉じました）

・プロセス情報 -> プロセスID： "0x4" (SYSTEM)

・確認できる情報

・対象ファイル： オブジェクト -> オブジェクト名 （"C:\Windows\PSEXESVC.exe"）
・ハンドルID：    オブジェクト -> ハンドル ID   ※ 他ログとの紐付けに使用する
・処理内容：
・成否：

  アクセス要求情報 -> アクセス （"DELETE"、"ReadAttributes"）
 キーワード （"成功の監査"）

1111通信

ログの生成場所

ログ種別・名称

取得情報の詳細

イベントID： 1 （Process Create）
                5 （Process Terminated）
      ・Image："C:\Windows\PSEXESVC.exe"
      ・User："SYSTEM"

      ・確認できる情報
            ・PSEXESVC.exeが実行された日時： ログの日付

接続先

（続）

イベントログ

-

Sysmon

イベントID： 1 （Process Create）
                5 （Process Terminated）

OS：Windows

ユーザー

↓

OS：Windows

管理者ユーザー

（続）

      ・確認できる情報
            ・リモート実行されたプロセス：             Image
            ・引数：                                            CommandLine
            ・プロセスの開始・終了日時（UTC）：    UtcTime   ※ PSEXESVC.exeの開始より後、終了より前の日時となる
            ・リモート実行に使用されたアカウント： 実行ユーザー

<備考>

記載のもの以外で出力される

可能性のあるイベントログ

PsExecを用いて実行されたプロセスに関連する情報が、「接続先」に記録される可能性がある

コマンド実行 > PsExec

追加
設定

必要

12123.2.2. WMIC (Windows Management Instrumentation Command Line)

<基本情報>

ツール

動作条件

ログから

得られる情報

ツール名称

カテゴリ

ツール概要

攻撃時における

想定利用例

権限

対象OS

ドメインへの参加
通信プロトコル

サービス
標準設定
追加設定

WMIC (Windows Management Instrumentation Command Line)
コマンド実行
Windowsのシステム管理に使用するツール
WMIを用いて、リモートシステムの情報を取得することや、コマンドを実行することが考えられる
・接続元： wmicコマンド実行元
・接続先： wmicコマンドによってアクセスされた端末
標準ユーザー  ※ リモート側で実行するコマンドによっては、管理者権限が必要な場合もある
Windows
不要
135/tcp, 445/tcp, 1024以上のランダムに選択されるTCPポート
Windows Management Instrumentation、Remote Procedure Call (RPC)
・実行履歴（Prefetch）
・プロセスの実行内容（wmicへの引数）、及び実行成否（戻り値）（Sysmon・監査ポリシー）
「接続元」「接続先」において、同時刻に以下のログが確認できる場合、リモート接続が行われた可能性がある
・接続元： イベントログに以下のログがある場合

実行成功時に確認できる痕跡

・イベントログ「セキュリティ」にWMIC.exeのイベントID 4689 （プロセスが終了しました）が記録され、実行結果（戻り値）が"0x0"となっている

・接続先： Sysmonに以下のログがある場合

・イベントログ「Sysmon」でイベントID 1、5でWmiPrvSE.exeが実行されたことが記録されている

<確認ポイント>

通信

ログの生成場所

ログ種別・名称

取得情報の詳細

OS：Windows

ユーザー

↓

OS：Windows

管理者ユーザー

接続元

接続先

イベントログ

-

セキュリティ

イベントログ

-

Sysmon

実行履歴

-

Prefetch

イベントログ

-

Sysmon

実行履歴

-

Prefetch

イベントID： 4688 （新しいプロセスが作成されました）

 4689 （プロセスが終了しました）

・プロセス情報 -> プロセス名：   "C:\Windows\System32\wbem\WMIC.exe"

・確認できる情報

・プロセスの開始・終了日時 ：
・プロセスを実行したユーザー名 ：
・プロセスを実行したユーザーのドメイン ：  サブジェクト -> アカウント ドメイン
・プロセス実行時の権限昇格の有無 ：
・プロセスの戻り値 ：

 プロセス情報 -> トークン昇格の種類
  プロセス情報 -> 終了状態

ログの日付
サブジェクト -> アカウント名

イベントID： 1 （Process Create）

 5 （Process Terminated）

・Image： "C:\Windows\System32\wbem\WMIC.exe"

・確認できる情報

・プロセスの開始・終了日時（UTC） ：
・プロセスのコマンドライン ：
・実行ユーザ名 ：
・プロセスID ：

 UtcTime
 CommandLine  ※ wmic.exeの引数より、リモートホストと実行コマンドが確認可能
 User
  ProcessId

ファイル名： C:\Windows\Prefetch\WMIC.EXE-98223A30.pf

・確認できる情報 (ツールを利用して下記を確認できる ツール：WinPrefetchView)

・最終実行日時 ：

 Last Run Time

イベントID： 1 （Process Create）

 5 （Process Terminated）

・Image： "C:\Windows\System32\wbem\WmiPrvSE.exe"

・確認できる情報

・プロセスの開始・終了日時（UTC） ：
・プロセスのコマンドライン ：
・実行ユーザ名 ：
・プロセスID ：

 UtcTime
 CommandLine  （"C:\Windows\System32\wmiprvse.exe -secured -Embedding"）
 User  （"NT AUTHORITY\NETWORK SERVICE"）
  ProcessId

ファイル名： C:\Windows\Prefetch\WMIPRVSE.EXE-1628051C.pf

・確認できる情報 (ツールを利用して下記を確認できる ツール：WinPrefetchView)

・最終実行日時 ：

 Last Run Time

<備考>

記載のもの以外で出力される

可能性のあるイベントログ

・wmicで呼び出された処理によっては、処理特有のログが記録される可能性がある
・ユーザがActive Directory上に存在する場合、認証要求がドメインコントローラに記録される可能性がある

しかし、wmicにより発生した認証要求であるか、それ以外のものであるかを断定することは出来ない

コマンド実行 > wmic

 凡例
・取得出来る情報
・イベントID・項目名
・フィールド名
・"フィールドの値"

追加
設定

必要

必要

-

必要

-

13133.2.3. PowerShell (リモートコマンド実行)

<基本情報>

ツール名称

カテゴリ

ツール概要

ツール

攻撃時における

想定利用例

実行例

(検証時に使用した

コマンド)

権限

対象OS

動作条件

ドメインへの参加
通信プロトコル

ログから

得られる情報

サービス
標準設定

追加設定

実行成功時に確認できる痕跡

<確認ポイント>

PowerShell (リモートコマンド実行)
コマンド実行
Windowsの管理や設定に利用可能なコマンドラインツール (Windows 7以降では標準で利用が可能)
PowerShellを実行したホストのみでなく、ネットワークを介して他のホストに対してコマンドを実行することも可能
ネットワーク内の、ドメインコントローラや他ホストに対して、管理者権限が必要な動作を可能とするよう設定を変更する
・接続元： PowerShellコマンド実行元
・接続先： PowerShellコマンドによってログインされた先
以下のコマンドを実行  ※ 接続先で、Windows Remote Management (WS-Management)サービスを起動しておく必要がある
> Enable-PSRemoting -force
> Set-Item WSMan:\localhost\Client\TrustedHosts -Value *
> Enter-PSSession "[接続先]" -Credential Administrator
PowerShellは一般ユーザーでも利用可能  ※ 設定を変更するスクリプトを実行する場合、設定変更対象となるホストにおいて適切な権限が必要
Windows
不要
ローカル端末内を管理する場合は不要  ※ 他端末を管理する場合、HTTPでは80/tcp又は5985/tcp、HTTPSでは443/tcp又は5986/tcpを使用する
接続先: Windows Remote Management (WS-Management)
実行履歴（Prefetch）
実行履歴（Sysmon・監査ポリシー）  ※ PowerShellの終了イベントより、実行結果を確認可能
監査ポリシーにより、接続元から、接続先の5985/tcp（HTTP）又は5986/tcp（HTTPS）への通信が発生していることを確認可能
以下のログが同じ時刻に確認できた場合、リモートコマンド実行が行われた可能性がある  ※ Prefetchの場合も同様
・接続元： イベントログに以下のログがある場合
              ・イベントログ「セキュリティ」にPowerShellのイベントID 4689 （プロセスが終了しました）が記録され、実行結果（戻り値）が"0x0"となっている
・接続先： イベントログに以下のログがある場合
              ・イベントログ「セキュリティ」にwsmprovhost.exeのイベントID 4689 （プロセスが終了しました）が記録され、実行結果（戻り値）が"0x0"となっている

通信

ログの生成場所

ログ種別・名称

取得情報の詳細

イベントID： 4688 （新しいプロセスが作成されました）
                4689 （プロセスが終了しました）
      ・プロセス情報 -> プロセス名：   "C:\Windows\System32\Windows PowerShell\v1.0\powershell.exe"

      ・確認できる情報
            ・プロセスの開始・終了日時 ：                   ログの日付
            ・プロセスを実行したユーザー名 ：            サブジェクト -> アカウント名
            ・プロセスを実行したユーザーのドメイン ：  サブジェクト -> アカウント ドメイン
            ・プロセス実行時の権限昇格の有無 ：       プロセス情報 -> トークン昇格の種類
            ・プロセスの戻り値 ：                               プロセス情報 -> 終了状態

イベントログ

-

セキュリティ

イベントID： 5156 （フィルタリング プラットフォームによる接続の許可）
      ・プロセス名： "\device\harddiskvolume2\windows\system32\windowspowershell\v1.0\powershell.exe"
      ・ネットワーク情報 -> 方向：                          "送信"
      ・ネットワーク情報 -> 宛先アドレス：               "::1"
      ・ネットワーク情報 -> 宛先ポート・プロトコル： "47001"・"6"（TCP）

接続元

イベントID： 5156 （フィルタリング プラットフォームによる接続の許可）
      ・プロセス名： "\device\harddiskvolume2\windows\system32\windowspowershell\v1.0\powershell.exe"
      ・ネットワーク情報 -> 方向：                          "送信"
      ・ネットワーク情報 -> 宛先アドレス：               "[接続先ホスト]"
      ・ネットワーク情報 -> 宛先ポート・プロトコル：  "5985"（HTTP）又は"5986"（HTTPS）・"6"（TCP）
                                                                        ※ポート番号は、接続先側で指定することで変更が可能

イベントログ

-

Sysmon

実行履歴

-

Prefetch

OS：Windows

ユーザー

↓

OS：Windows

管理者ユーザー

イベントID： 1 （Process Create）
                5 （Process Terminated）
      ・Image： "C:\Windows\System32\Windows PowerShell\v1.0\powershell.exe"

      ・確認できる情報
            ・プロセスの開始・終了日時（UTC） ：     UtcTime
            ・プロセスのコマンドライン ：                  CommandLine: "C:\Windows\System32\Windows PowerShell\v1.0\powershell.exe"
            ・実行ユーザ名 ：                                 User
            ・プロセスID ：                                      ProcessId

ファイル名： C:\Windows\Prefetch\POWERSHELL.EXE-920BBA2A.pf

      ・確認できる情報 (ツールを利用して下記を確認できる ツール：WinPrefetchView)
            ・最終実行日時 ：                            Last Run Time

イベントID： 5156 （フィルタリング プラットフォームによる接続の許可）
      ・プロセスID：                     "4"
      ・アプリケーション名：          "System"
      ・ネットワーク情報 -> 方向： "着信"

      ・確認できる情報
            ・接続元ホスト： ネットワーク情報 -> 送信元アドレス
            ・着信ポート：    ネットワーク情報 -> ソース ポート （HTTPの場合"5985"、HTTPSの場合 "5986"）
            ・プロトコル：     ネットワーク情報 -> プロトコル （"6"）

イベントログ

-

セキュリティ

イベントID： 4624 （アカウントが正常にログオンしました）
      ・ログオン タイプ： "3"

      ・確認できる情報
            ・ログオンが成功した日時：                                       ログの日付
                                                 ※ 接続元における、wsmprovhost.exeプロセス作成（イベントID 4688）直後、終了（イベントID 4689）より前となる
            ・接続先端末においてプロセスを実行したアカウント名： 新しいログオン -> セキュリティID・アカウント名

接続先

イベントID： 4634 （アカウントが正常にログオフしました）

      ・確認できる情報
            ・ログオフした日時： ログの日付    ※ 接続元における、wsmprovhost.exeプロセス終了（イベントID 4689）後となる

イベントID： 1 （Process Create）
                5 （Process Terminated）
      ・Image： "C:\Windows\System32\at.exe"

      ・確認できる情報
            ・プロセスの開始・終了日時（UTC） ：     UtcTime
            ・プロセスのコマンドライン ：                  CommandLine: "C:\Windows\System32\wsmprovhost.exe -Embedding"
            ・実行ユーザ名 ：                                 User
            ・プロセスID ：                                      ProcessId

ファイル名： C:\Windows\Prefetch\WSMPROVHOST.EXE-EF06207C.pf

      ・確認できる情報 (ツールを利用して下記を確認できる ツール：WinPrefetchView)
            ・最終実行日時 ：                            Last Run Time

イベントログ

-

Sysmon

実行履歴

-

Prefetch

<備考>

記載のもの以外で出力される

可能性のあるイベントログ

実行されたコマンドによっては、そのコマンドが出力するログが接続先に記録される可能性がある

コマンド実行 > PowerShell

  凡例
・取得出来る情報
・イベントID・項目名
・フィールド名
・"フィールドの値"

追加
設定

必要

必要

-

必要

-

必要

-

14143.2.4. wmiexec.vbs

<基本情報>

ツール

動作条件

ログから

得られる情報

ツール名称

カテゴリ

ツール概要

攻撃時における

想定利用例

権限

対象OS

ドメインへの参加
通信プロトコル

サービス
標準設定

追加設定

実行成功時に確認できる痕跡

<確認ポイント>

wmiexec.vbs
コマンド実行
Windowsのシステム管理に使用するツール
他端末に対して、スクリプト処理を実行する
・接続元： wmiexec.vbs実行元
・接続先： wmiexec.vbsによってアクセスされた端末
標準ユーザー
Windows
不要
135/tcp, 445/tcp
-
・実行履歴（Prefetch）
・ファイルの作成・削除履歴（監査ポリシー）
・実行履歴（Sysmon）
接続先： "WMI_SHARE"共有が作成され、削除されている

通信

ログの生成場所

ログ種別・名称

取得情報の詳細

イベントID： 4688 （新しいプロセスが作成されました）
                4689 （プロセスが終了しました）
      ・プロセス情報 -> プロセス名：   "C:\Windows\System32\cscript.exe"

      ・確認できる情報
            ・プロセスの開始・終了日時 ：                   ログの日付
            ・プロセスを実行したユーザー名 ：            サブジェクト -> アカウント名
            ・プロセスを実行したユーザーのドメイン ：  サブジェクト -> アカウント ドメイン
            ・プロセス実行時の権限昇格の有無 ：       プロセス情報 -> トークン昇格の種類
            ・プロセスの戻り値 ：                               プロセス情報 -> 終了状態

イベントログ

-

セキュリティ

イベントID： 5156 （Windows フィルターリング プラットフォームで、接続が許可されました）
      ・プロセス名： "\device\harddiskvolume2\windows\system32\cscript.exe"

接続元

      ・確認できる情報
            ・送信元ポート： ネットワーク情報 -> 宛先ポート  ※ ポート番号は、接続先側で指定することで変更が可能

イベントID： 1 （Process Create）
                5 （Process Terminated）
      ・Image： "C:\Windows\System32\cscript.exe"

      ・確認できる情報
            ・プロセスの開始・終了日時（UTC）： UtcTime
            ・プロセスのコマンドライン：             CommandLine
            ・実行ユーザー名：                        User
            ・プロセスID：                                ProcessId

ファイル名： C:\Windows\Prefetch\CSCRIPT.EXE-D1EF4768.pf

      ・確認できる情報 (ツールを利用して下記を確認できる ツール：WinPrefetchView)
            ・最終実行日時 ：                            Last Run Time

イベントログ

-

Sysmon

実行履歴

-

Prefetch

OS：Windows

ユーザー

↓

OS：Windows

ユーザー

イベントID： 4656 （オブジェクトへのハンドルが要求されました）
                4663 （オブジェクトへのアクセスが試行されました）
                4658 （オブジェクトに対するハンドルが閉じました）
      ・オブジェクト -> オブジェクト名：                     "(C:\Windows\Temp\wmi.dll)"
      ・アクセス要求情報 -> アクセス・アクセス理由： ("WriteData (または AddFile)"、"AppendData (または AddSubdirectory
                                                                                                                                    または CreatePipeInstance)")
      ・確認できる情報
            ・プロセス名： "C:\Windows\System32\cmd.exe"
            ・ハンドルID： オブジェクト -> ハンドルID    ※ 他のログとの紐付けに使用する

イベントID： 5142 （ネットワーク共有オブジェクトが追加されました）

      ・確認できる情報
            ・プロセスの開始日時：                        ログの日付
            ・プロセスを実行したユーザー名：        サブジェクト -> アカウント名
            ・プロセスを実行したユーザのドメイン： サブジェクト -> アカウント ドメイン
            ・共有名：                                         共有情報 -> 共有名 :　("\\*\WMI_SHARE")
            ・共有パス：                                      共有情報 -> 共有パス: ("C:\Windows\Temp")

イベントID： 5145 （クライアントに必要なアクセスを付与できるかどうかについて、ネットワーク共有オブジェクトがチェックされました）

イベントログ

-

セキュリティ

      ・確認できる情報
            ・プロセスの開始日時：                        ログの日付
            ・プロセスを実行したユーザー名：        サブジェクト -> アカウント名
            ・プロセスを実行したユーザのドメイン： サブジェクト -> アカウント ドメイン
            ・共有名：                                          共有情報 -> 共有名 ("\\*\WMI_SHARE")
            ・共有パス：                                       共有情報 -> 共有パス ("\??\C:\windows\temp")
            ・共有パス：                                       共有情報 -> 相対ターゲット名: ("wmi.dll")

接続先

イベントID： 4656 （オブジェクトに対するハンドルが要求されました）
                 4660 （オブジェクトが削除されました）
                 4658 （オブジェクトに対するハンドルが閉じました）
      ・オブジェクト -> オブジェクト名：                      "(C:\Windows\Temp\wmi.dll)"
      ・アクセス要求情報 -> アクセス・アクセス理由： "DELETE"

      ・確認できる情報
            ・プロセス名： "（C:\Windows\System32\cmd.exe）"

イベントID： 5144 （ネットワーク共有オブジェクトが削除されました。）

      ・確認できる情報
            ・共有名：    共有情報 -> 共有名 ("\\*\WMI_SHARE")
            ・共有パス： 共有情報 -> 共有パス: ("C:\Windows\Temp")

イベントログ

-

Sysmon

イベントID： 1 （Process Create）
                5 （Process Terminated）
      ・Image： "C:\Windows\System32\wbem\WmiPrvSE.exe"
                    "C:\Windows\System32\cmd.exe"

      ・確認できる情報
            ・プロセスの開始・終了日時（UTC）： UtcTime
            ・プロセスのコマンドライン：             CommandLine
            ・実行ユーザー名：                        User
            ・プロセスID：                                ProcessId

コマンド実行 > wmiexec.vbs

  凡例
・取得出来る情報
・イベントID・項目名
・フィールド名
・"フィールドの値"

追加
設定

必要

必要

-

必要

必要

15通信

ログの生成場所

ログ種別・名称

取得情報の詳細

OS：Windows

ユーザー

↓

OS：Windows

ユーザー

（続）

<備考>

接続先

（続）

実行履歴

-

Prefetch

ファイル名： C:\Windows\Prefetch\CSCRIPT.EXE-D1EF4768.pf
                  C:\Windows\Prefetch\WMIPRVSE.EXE-1628051C.pf

      ・確認できる情報 (ツールを利用して下記を確認できる ツール：WinPrefetchView)
            ・最終実行日時 ：                            Last Run Time

記載のもの以外で出力される

可能性のあるイベントログ

-

コマンド実行 > wmiexec.vbs

追加
設定

-

16163.2.5. BeginX

<基本情報>

ツール

動作条件

ログから

得られる情報

ツール名称

カテゴリ

ツール概要

攻撃時における

想定利用例

参考情報

権限

対象OS

ドメインへの参加
通信プロトコル

サービス

標準設定

追加設定

BeginX
コマンド実行
クライアントからサーバに対してリモートコマンド実行をする
リモートホストの設定を変更したり、情報を取得したりする
・接続元： BeginXクライアント実行元
・接続先： BeginXサーバ実行元
https://www.jpcert.or.jp/present/2015/20151028_codeblue_ja.pdf
一般ユーザー
Windows
不要
tcpまたはudpでポート番号は検体毎に異なる
-
・両ホスト： 実行履歴（Prefetch）
・接続先：  Windowsファイアウォールの設定変更が実施される
・両ホスト： 実行履歴（Sysmon・監査ポリシー）

 所定のポートを経由して通信したことが記録されている

実行成功時に確認できる痕跡

・接続元： 接続先で意図せず許可されているポートと通信をしたことが記録されている
・接続先： 意図しない通信がWindows Firewallで許可されており、該当のポートでリッスンしている検体が存在する

<確認ポイント>

通信

ログの生成場所

ログ種別・名称

取得情報の詳細

イベントID： 4688 （新しいプロセスが作成されました）

 4689 （プロセスが終了しました）

・プロセス情報 -> プロセス名： "[検体]"

・確認できる情報

接続元

接続先

OS：Windows

ユーザー

↓

OS：Windows

ユーザー

イベントログ

-

セキュリティ

イベントログ

-

Sysmon

実行履歴

-

Prefetch

イベントログ

-

セキュリティ

イベントログ

-

Sysmon

実行履歴

-

Prefetch

実行履歴

-

レジストリ

・プロセスの開始・終了日時：
・プロセスを実行したユーザー名：
・プロセスを実行したユーザーのドメイン： サブジェクト -> アカウント ドメイン
・プロセス実行時の権限昇格の有無：
・プロセスの戻り値：

 プロセス情報 -> トークン昇格の種類
  プロセス情報 -> 終了状態

ログの日付
サブジェクト -> アカウント名

イベントID： 5156 （Windowsフィルターリング プラットフォームで、接続が許可されました）

・アプリケーション名： "[検体]"

・確認できる情報

・通信の方向：  ネットワーク情報 -> 方向 （"送信"）
・ソースポート： ネットワーク情報 -> ソース ポート
・宛先ホスト：    ネットワーク情報 -> 宛先アドレス （検体名を実行時に指定したホスト）
・宛先ポート：    ネットワーク情報 -> 宛先ポート ・プロトコル

イベントID： 1 （Process Create）

 5 （Process Terminated）

・Image： "[検体]"

・確認できる情報

・プロセスの開始・終了日時（UTC）： UtcTime
・プロセスのコマンドライン：
・実行ユーザー名：
・プロセスID：

  CommandLine   ※ イベントID 1に記録される
 User
 ProcessId

ファイル名： C:\Windows\Prefetch\[検体]-[文字列].pf

・確認できる情報 (ツールを利用して下記を確認できる ツール：WinPrefetchView)

・最終実行日時：

 Last Run Time

検体が実行された直後に、以下が記録される

イベントID： 5154 （Windows フィルターリング プラットフォームで、アプリケーションまたはサービスによるポートでの着信接続のリッスンが許可されました）

・アプリケーション名： "[検体]"

・確認できる情報

・ソースポート：    ネットワーク情報 -> ソース ポート
・利用プロトコル： ネットワーク情報 -> プロトコル

イベントID： 5447 （Windows フィルターリング プラットフォームのフィルターが変更されました）  ※ ファイアウォールへの設定変更反映

 4946 （Windows ファイアウォールの例外の一覧が変更されました）  ※ ファイアウォールへの設定変更反映

接続元がコマンドを実行する際に、以下が記録される

イベントID： 5156 （Windowsフィルターリング プラットフォームで、接続が許可されました）

・アプリケーション名： "[検体]"

・確認できる情報

・通信の方向：  ネットワーク情報 -> 方向 （"着信"）
・ソースポート： ネットワーク情報 -> ソース ポート
・宛先ホスト：   ネットワーク情報 -> 宛先アドレス （リモート接続元のホスト）
・宛先ポート：   ネットワーク情報 -> 宛先ポート ・プロトコル

イベントID： 1 （Process Create）

 5 （Process Terminated）

・Image： "[検体]","netsh.exe","rundll32.exe"

・確認できる情報

・プロセスの開始・終了日時（UTC）： UtcTime
・プロセスのコマンドライン：
・実行ユーザー名：
・プロセスID：

  CommandLine   ※ 各Imageごとに実行した内容が記載されている
 User
 ProcessId

ファイル名： C:\Windows\Prefetch\CMD.EXE-4A81B364.pf

 C:\Windows\Prefetch\[検体]-[文字列].pf

・確認できる情報 (ツールを利用して下記を確認できる ツール：WinPrefetchView)

・最終実行日時：

 Last Run Time

レジストリエントリ： HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\services\SharedAccess\Parameters\FirewallPolicy\FirewallRules

※ 検体実行時にWindowsファイアウォールの設定が変更されるため、レジストリの値が変更される

ルール内に、検体の実行ファイル名が含まれる

<備考>

記載のもの以外で出力される

可能性のあるイベントログ

-

コマンド実行 > beginX

 凡例
・取得出来る情報
・イベントID・項目名
・フィールド名
・"フィールドの値"

追加
設定

-

必要

-

-

必要

-

-

17173.2.6. WinRM

<基本情報>

ツール

動作条件

ログから

得られる情報

ツール名称

カテゴリ

ツール概要

攻撃時における

想定利用例

権限

対象OS

ドメインへの参加
通信プロトコル

サービス
標準設定

追加設定

実行成功時に確認できる痕跡

<確認ポイント>

WinRM
コマンド実行
リモートの端末から情報を搾取する
リモートコマンドを実行する前に調査のため実施する
・接続元： WinRMマンド実行元
・接続先： WinRMコマンドによってアクセスされた端末
管理ユーザー
Windows
-
5985/tcp (HTTP) 又は 5986/tcp (HTTPS)
接続先： Windows Remote Management (WS-Management)
・実行履歴（Prefetch）
・接続元： 実行履歴（Sysmon・監査ポリシー）
・接続先： 接続元からの着信接続
・接続元： 以下のログがある場合、WinRMが実行された可能性がある
             ・イベントログ「Sysmon」のイベントID:1、5でcscript.exeが接続先にアクセスしたログが記録されている

通信

ログの生成場所

ログ種別・名称

取得情報の詳細

イベントID： 4688 （新しいプロセスが作成されました）
                4689 （プロセスが終了しました）
      ・プロセス情報 -> プロセス名：   "C:\Windows\System32\cscript.exe"

      ・確認できる情報
            ・プロセスの開始・終了日時 ：                   ログの日付
            ・プロセスを実行したユーザー名 ：            サブジェクト -> アカウント名
            ・プロセスを実行したユーザーのドメイン ：  サブジェクト -> アカウント ドメイン
            ・プロセス実行時の権限昇格の有無 ：       プロセス情報 -> トークン昇格の種類
            ・プロセスの戻り値 ：                               プロセス情報 -> 終了状態

イベントログ

-

セキュリティ

イベントID： 5156 （Windowsフィルターリング プラットフォームで、接続が許可されました）
      ・アプリケーション名： "\device\harddiskvolume2\windows\system32\cscript.exe"

      ・確認できる情報
            ・通信の方向：    方向 （"送信"）
            ・送信先ホスト：  ネットワーク情報 -> 宛先アドレス
            ・送信先ポート： 宛先ポート （"5958"（HTTP） 又は "5986"（HTTPS））、プロトコル （"6" = TCP）

イベントログ

-

Sysmon

イベントID： 1 （Process Create）
                5 （Process Terminated）
      ・Image： "C:\Windows\System32\cscript.exe"

      ・確認できる情報
            ・プロセスの開始・終了日時（UTC） ：     UtcTime
            ・指定時刻、実行プロセス、対象ホスト :  CommandLine
            ・実行ユーザ名 ：                                 User
            ・プロセスID ：                                      ProcessId

接続元

イベント ログ

-

アプリケーションと

サービス

Microsoft\Windows
\Windows Remote

Management

イベントID： 166 （選択された認証機構）

      ・確認できる情報
            ・認証方式： 認証機構 (選択された認証機構は Kerberos です)

イベントID： 80 （操作 Get の要求を送信しています）

      ・確認できる情報
            ・送信先コンピューターおよびポート： "[ホスト名]:[ポート]"

イベントID： 143 （ネットワーク レイヤーから応答を受信しました）

      ・確認できる情報
            ・ステータス： 状態 (200 (HTTP_STATUS_OK))

イベントID： 132 （WSMan の操作 Get が正常に完了しました）

      ・確認できる情報
            ・完了日時（UTC）： UtcTime

OS：Windows

管理者ユーザー

↓

OS：Windows

管理者ユーザー

実行履歴

-

Prefetch

ファイル名： C:\Windows\Prefetch\CSCRIPT.EXE-D1EF4768.pf

      ・確認できる情報 (ツールを利用して下記を確認できる ツール：WinPrefetchView)
            ・最終実行日時 ：                            Last Run Time

イベントID： 5156 （Windows フィルターリング プラットフォームで、接続が許可されました）
      ・アプリケーション情報 -> アプリケーション名： "SYSTEM"
      ・ネットワーク情報 -> 方向：                           "着信"
      ・ネットワーク情報 -> ソースポート：                "5985"（HTTP） 又は "5986"（HTTPS）
      ・ネットワーク情報 -> プロトコル：                    "6" （TCP）

      ・確認できる情報
            ・接続元ホスト： ネットワーク情報 -> 宛先アドレス
            ・接続元ポート： ネットワーク情報 -> 宛先ポート

接続先

イベントログ

-

セキュリティ

イベントID： 4624 （アカウントが正常にログオンしました）
      ・ログオン タイプ： "3"

      ・確認できる情報
            ・使用されたセキュリティID： 新しいログオン -> セキュリティID
            ・ログオンID：                     サブジェクト -> ログオンID
            ・アカウント：                      アカウント名・アカウント ドメイン

イベントID： 4656 （オブジェクトに対するハンドルが要求されました）
                 4658 （オブジェクトに対するハンドルが閉じました）
      ・プロセス情報 -> プロセス名： "C:\Windows\System32\svchost.exe"
      ・オブジェクト -> オブジェクト名:"\REGISTRY\MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\WSMAN\Client"
      ・オブジェクト -> オブジェクト名:"\REGISTRY\MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\WSMAN\Service"

      ・確認できる情報
            ・ハンドルID：            オブジェクト -> ハンドルID
            ・アクセス要求内容： アクセス要求情報 -> アクセス
                                                                 ("READ_CONTROL"、"キー値の照会"、"サブキーの列挙"、"キー変更に関する通知")
    ※ 複数回この処理を実施する。

コマンド実行 > winrmによるリモート実行

  凡例
・取得出来る情報
・イベントID・項目名
・フィールド名
・"フィールドの値"

追加
設定

必要

必要

-

-

必要

1818通信

ログの生成場所

ログ種別・名称

取得情報の詳細

イベントID： 5156 （Windowsフィルターリング プラットフォームで、接続が許可されました）
      ・アプリケーション情報 -> アプリケーション名： "\device\harddiskvolume2\windows\system32\lsass.exe"
      ・ネットワーク情報 -> 方向：                          "着信"
      ・ネットワーク情報 -> ソース ポート：              "88"

OS：Windows

管理者ユーザー

↓

OS：Windows

管理者ユーザー

（続）

<備考>

Active Directory

ドメイン

コントローラー

イベントログ

-

セキュリティ

      ・確認できる情報
            ・接続元ホスト： ネットワーク情報 -> 宛先アドレス

イベントID： 4769 （Kerberosサービス チケットが要求されました）
      ・ネットワーク情報 -> クライアント アドレス： "[接続元ホスト]"

      ・確認できる情報
            ・利用されたユーザー： アカウント情報 -> アカウント名

記載のもの以外で出力される

可能性のあるイベントログ

-

コマンド実行 > winrmによるリモート実行

追加
設定

必要

19193.2.7. WinRS

<基本情報>

ツール

動作条件

ログから

得られる情報

ツール名称

カテゴリ

ツール概要

攻撃時における

想定利用例

権限

対象OS

ドメインへの参加
通信プロトコル

サービス

標準設定

追加設定

実行成功時に確認できる痕跡

<確認ポイント>

WinRS
コマンド実行
リモートホスト上でコマンドを実行する
BITSなどによりツールを送り込み、winrsを用いてツールをリモートから実行する
・接続元： WinRSコマンド実行元
・接続先： WinRSコマンドによってアクセスされた端末
・接続元： 標準ユーザー
・接続先： 管理者ユーザー
Windows
不要
5985/tcp (HTTP) 又は 5986/tcp (HTTPS)
接続先： Windows Remote Management (WS-Management)
・WinRMの実行ログ
・実行履歴（Prefetch）
・実行履歴（Sysmon・監査ポリシー）
・Windowsフィルターリングプラットフォームを経由した、通信の記録
・イベントログ「アプリケーションとサービス\Microsoft\Windows\Windows Remote Management\Operational」に、WinRSの実行が記録されている

通信

ログの生成場所

ログ種別・名称

取得情報の詳細

イベントID： 4688 （新しいプロセスが作成されました）
                4689 （プロセスが終了しました）
      ・プロセス情報 -> プロセス名：   "C:\Windows\System32\winrs.exe"

      ・確認できる情報
            ・プロセスの開始・終了日時 ：                   ログの日付
            ・プロセスを実行したユーザー名 ：            サブジェクト -> アカウント名
            ・プロセスを実行したユーザーのドメイン ：  サブジェクト -> アカウント ドメイン
            ・プロセス実行時の権限昇格の有無 ：       プロセス情報 -> トークン昇格の種類
            ・プロセスの戻り値 ：                               プロセス情報 -> 終了状態

イベントログ

-

セキュリティ

イベントID： 4648 （明示的な資格情報を使用してログオンが試行されました）
      ・プロセス情報 -> プロセス名： "C:\Windows\System32\winrs.exe"

      ・確認できる情報
            ・使用されたアカウント： 資格情報が使用されたアカウント -> アカウント名・アカウント ドメイン
            ・接続先ホスト：            ターゲット サーバー -> ターゲット サーバー名
            ・使用されたプロトコル： ターゲット サーバー -> 追加情報 （"[プロトコル]/[ターゲット サーバー名]"）

・イベントID： 5156 （Windows フィルターリング プラットフォームで、接続が許可されました）
      ・アプリケーション情報 -> アプリケーション名： "\device\harddiskvolume2\windoows\system32\winrs.exe"
      ・ネットワーク情報 -> 方向：                           "送信"
      ・ネットワーク情報 -> 宛先ポート：                   "5985"（HTTP） 又は "5986"（HTTPS）
      ・ネットワーク情報 -> プロトコル：                    "6" （TCP）

接続元

      ・確認できる情報
            ・接続先ホスト： ネットワーク情報 -> 宛先アドレス

イベントID： 1 （Process Create）
                5 （Process Terminated）
      ・Image： "C:\Windows\System32\winrs.exe"

イベントログ

-

Sysmon

      ・確認できる情報
            ・プロセスの開始・終了日時（UTC） ：     UtcTime
            ・プロセスのコマンドライン ：                  CommandLine  ※ 接続先ホスト、使用されたアカウント、実行されたコマンドなどが記録される
            ・実行ユーザ名 ：                                 User
            ・プロセスID ：                                      ProcessId

OS：Windows
標準ユーザー

↓

OS：Windows

管理者ユーザー

イベントログ

WinRSが実行されたことが記録されている

-

アプリケーションと

サービス

イベントID： 80 （要求の処理）

\Microsoft\Windows
\Windows Remote

Management
\Operational

      ・確認できる情報
            ・接続先ホスト： 詳細タブ -> EventData\url
            ・接続先ポート： 詳細タブ -> EventData\port

実行履歴

-

Prefetch

ファイル名： C:\Windows\Prefetch\WINRS.EXE-483CEB0F.pf

      ・確認できる情報 (ツールを利用して下記を確認できる ツール：WinPrefetchView)
            ・最終実行日時 ：                            Last Run Time

接続先

イベントログ

-

セキュリティ

イベントID： 4688 （新しいプロセスが作成されました）
                4689 （プロセスが終了しました）
      ・プロセス情報 -> プロセス名：   "C:\Windows\System32\winrshost.exe"

      ・確認できる情報
            ・プロセスの開始・終了日時 ：                   ログの日付
            ・プロセスを実行したユーザー名 ：            サブジェクト -> アカウント名
            ・プロセスを実行したユーザーのドメイン ：  サブジェクト -> アカウント ドメイン
            ・プロセス実行時の権限昇格の有無 ：       プロセス情報 -> トークン昇格の種類
            ・プロセスの戻り値 ：                               プロセス情報 -> 終了状態

イベントID： 4688 （新しいプロセスが作成されました）
                4689 （プロセスが終了しました）
      ・プロセス情報 -> プロセス名：   "[接続元から指定されたコマンド]"

      ・確認できる情報
            ・プロセスの開始・終了日時 ：                   ログの日付
            ・プロセスを実行したユーザー名 ：            サブジェクト -> アカウント名
            ・プロセスを実行したユーザーのドメイン ：  サブジェクト -> アカウント ドメイン
            ・プロセス実行時の権限昇格の有無 ：       プロセス情報 -> トークン昇格の種類
            ・プロセスの戻り値 ：                               プロセス情報 -> 終了状態

イベントID： 5156 （Windows フィルターリング プラットフォームで、接続が許可されました）
      ・アプリケーション情報 -> アプリケーション名： "System"
      ・ネットワーク情報 -> 方向：                          "着信"
      ・ネットワーク情報 -> ソースポート：                "5985"（HTTP） 又は "5986"（HTTPS）
      ・ネットワーク情報 -> プロトコル：                   "6" （TCP）

      ・確認できる情報
            ・接続元ホスト： ネットワーク情報 -> 宛先アドレス

コマンド実行 > WinRS

  凡例
・取得出来る情報
・イベントID・項目名
・フィールド名
・"フィールドの値"

追加
設定

必要

必要

-

-

必要

2020通信

ログの生成場所

ログ種別・名称

取得情報の詳細

OS：Windows
標準ユーザー

↓

OS：Windows

管理者ユーザー

（続）

接続先

（続）

イベントログ

-

Sysmon

イベントID： 1 （Process Create）
                5 （Process Terminated）
      ・Image： "C:\Windows\System32\winrshost.exe"

      ・確認できる情報
            ・プロセスの開始・終了日時（UTC） ：     UtcTime
            ・プロセスのコマンドライン ：                  CommandLine
            ・実行ユーザ名 ：                                 User
            ・プロセスID ：                                      ProcessId

イベントID： 1 （Process Create）
                5 （Process Terminated）
      ・Image： "[接続元から指定されたコマンド]"

      ・確認できる情報
            ・プロセスの開始・終了日時（UTC） ：     UtcTime
            ・プロセスのコマンドライン ：                  CommandLine
            ・実行ユーザ名 ：                                 User
            ・プロセスID ：                                      ProcessId

イベントログ

-

アプリケーションとサービス

\Microsoft\Windows
\Windows Remote

Management\Operational

実行履歴

-

Prefetch

接続元のログに対応する、WinRSの処理が実行されたことが記録されている

イベントID： 81 （要求の処理）

ファイル名： C:\Windows\Prefetch\WINRSHOST.EXE-ECE7169D.pf

      ・確認できる情報 (ツールを利用して下記を確認できる ツール：WinPrefetchView)
            ・最終実行日時 ：                            Last Run Time

<備考>

記載のもの以外で出力される

可能性のあるイベントログ

WinRS経由で実行されたコマンドによる、ログが出力される可能性がある

コマンド実行 > WinRS

追加
設定

必要

-

-

2121コマンド実行 > at

3.2.8. atコマンド

<基本情報>

ツール

動作条件

ログから

得られる情報

ツール名称

カテゴリ

ツール概要

攻撃時における

想定利用例

権限

対象OS

ドメインへの参加
通信プロトコル

サービス

標準設定

追加設定

実行成功時に確認できる痕跡

<確認ポイント>

at
コマンド実行
指定した時刻にタスクを実行する
予めアプリケーションやスクリプトを、ユーザに気付かれないように配置し、任意のタイミングで実行する
・接続元： atコマンド実行元
・接続先： atコマンドによってタスクが登録された端末
管理者ユーザー
※ リモートホストのタスクを設定する場合、ローカル側は標準ユーザーでも可
Windows 7 / Server 2008
Windows 8以降、及びServer 2012以降では、atコマンドは廃止となっている
不要
445/tcp
Task Scheduler
・接続元： 実行履歴（Prefetch）
・接続先： タスクスケジューラ イベントログにおけるタスクの作成・実行履歴
・実行履歴（Sysmon・監査ポリシー）
・接続元： イベントログに以下のログがある場合、タスクが登録されたと考えられる
              ・イベントログ「セキュリティ」にat.exeのイベントID 4689 （プロセスが終了しました）が記録され、実行結果（戻り値）が"0x0"となっている
・接続先： イベントログに以下のログがある場合、タスクが実行されていると考えられる
              ・イベントログ「\Microsoft\Windows\TaskScheduler\Operational」にイベントID 106（タスクが登録されました）が記録されている
              ・イベントログ「\Microsoft\Windows\TaskScheduler\Operational」にイベントID 200（開始された操作）、201（操作が完了しました）が記録され、イベントID 201における戻り値が成功となっている

  凡例
・取得出来る情報
・イベントID・項目名
・フィールド名
・"フィールドの値"

追加
設定

必要

必要

-

必要

通信

ログの生成場所

ログ種別・名称

取得情報の詳細

イベントID： 4688 （新しいプロセスが作成されました）
                4689 （プロセスが終了しました）
      ・プロセス情報 -> プロセス名：   "C:\Windows\System32\at.exe"

イベントログ

-

セキュリティ

      ・確認できる情報
            ・プロセスの開始・終了日時 ：                   ログの日付
            ・プロセスを実行したユーザー名 ：            サブジェクト -> アカウント名
            ・プロセスを実行したユーザーのドメイン ：  サブジェクト -> アカウント ドメイン
            ・プロセス実行時の権限昇格の有無 ：       プロセス情報 -> トークン昇格の種類
            ・プロセスの戻り値 ：                               プロセス情報 -> 終了状態

接続元

(Windows 7)

イベントID： 1 （Process Create）
                5 （Process Terminated）
      ・Image： "C:\Windows\System32\at.exe"

OS：Windows 7

ユーザー

↓

OS：Windows

Server 2008 R2
管理者ユーザー

イベントログ

-

Sysmon

実行履歴

-

Prefetch

      ・確認できる情報
            ・プロセスの開始・終了日時（UTC） ：     UtcTime
            ・プロセスのコマンドライン ：                  CommandLine
            ・指定時刻、実行プロセス、対象ホスト :  CommandLine  ※ リモートホストに対して実行した場合、記録される
            ・実行ユーザ名 ：                                 User
            ・プロセスID ：                                      ProcessId

ファイル名： C:\Windows\Prefetch\AT.EXE-BB02E639.pf

      ・確認できる情報 (ツールを利用して下記を確認できる ツール：WinPrefetchView)
            ・最終実行日時 ：                            Last Run Time

タスク登録が行われた場合、以下のログが出力される

イベントID： 4656 （オブジェクトへのハンドルが要求されました）
                4663 （オブジェクトへのアクセスが試行されました）
                4658 （オブジェクトに対するハンドルが閉じました）
      ・オブジェクト -> オブジェクト名： "C:\Windows\Tasks\[タスク名].job"
                                                     "C:\Windows\System32\Tasks\[タスク名]"

      ・確認できる情報
            ・ハンドルID（他ログとの紐付けに使用する） ：  オブジェクト -> ハンドルID
            ・ハンドルを要求したプロセスのプロセスID ：    プロセス情報 -> プロセスID （イベント4688で作成されたプロセスのIDと一致する）
            ・処理内容 ：                                                アクセス要求情報 -> アクセス・アクセス理由 （"WriteData (または AddFile)"
                                                                                                    "AppendData (または AddSubdirectoryまたは CreatePipeInstance)"）
            ・成否 ：                                                       キーワード （"成功の監査"）

イベントID： 4698 （スケジュールされたタスクが作成されました）
      ・タスク情報 -> タスク名

      ・確認できる情報
            ・タスクの詳細 ：          タスク情報内、タスク コンテンツ。XML形式にて記述されている。
            ・実行トリガー ：          Triggers
            ・優先度などの設定 ：  Principals
            ・実行内容 ：               Actions

タスクが実行された場合、以下のログが出力される。

接続先

(Windows Server

2008 R2)

イベントログ

-

セキュリティ

イベントID： 4688 （新しいプロセスが作成されました）
      ・プロセス情報 -> プロセス名： "C:\Windows\System32\taskeng.exe"

      ・確認できる情報
            ・プロセスの開始日時 ：                           ログの日付
            ・プロセスを実行したユーザー名 ：           サブジェクト -> アカウント名
            ・プロセスを実行したユーザーのドメイン ： サブジェクト -> アカウント ドメイン
            ・プロセスID ：                                        プロセス情報 -> 新しいプロセスID  ※ 後に実行されるプロセスの親プロセスとなる
            ・プロセス実行時の権限昇格の有無 ：      プロセス情報 -> トークン昇格の種類

イベントID： 4688 （新しいプロセスが作成されました）
                4689 （プロセスが終了しました）
      ・プロセス情報 -> プロセス名： タスクで実行されるプロセス

      ・確認できる情報
            ・プロセスの開始・終了日時 ：                   ログの日付
            ・プロセスを実行したユーザー名 ：           サブジェクト -> アカウント名
            ・プロセスを実行したユーザーのドメイン ： サブジェクト -> アカウント ドメイン
            ・プロセスID ：                                        プロセス情報 -> 新しいプロセスID
                                                                                               ※ タスク中で別の子プロセスが実行される場合、このプロセスが親プロセスとなる
            ・プロセス実行時の権限昇格の有無：        プロセス情報 -> トークン昇格の種類
            ・親プロセスID ：                                     プロセス情報 -> クリエーター プロセスID ※ 親プロセスが、先に実行されているtaskeng.exeとなる
            ・プロセスの戻り値 ：                              プロセス情報 -> 終了状態

イベントID： 4656 （オブジェクトに対するハンドルが要求されました）
                4663 （オブジェクトへのアクセスが試行されました）
      ・オブジェクト -> オブジェクト名： "C:\Windows\Tasks\[タスク名].job"
      ・アクセス要求情報 -> アクセス・アクセス理由： "WriteData (または AddFile)"・"AppendData (または AddSubdirectory または
                                                                                                                                                      CreatePipeInstance)"
      ・確認できる情報
            ・ハンドルID ：    オブジェクト -> ハンドルID  ※ 他のログとの紐付けに使用する

2222通信

ログの生成場所

ログ種別・名称

取得情報の詳細

タスク登録に関しては、有益な情報は出力されない。タスクが実行された際には、以下のログが登録される。

イベントログ

-

Sysmon

イベントID： 1 （Process Create）
                5 （Process Terminated）
      ・ParentImage名： "C:\Windows\System32\taskeng.exe"

      ・確認できる情報
            ・プロセスの開始・終了日時（UTC） ：  UtcTime
            ・プロセスのコマンドライン ：              CommandLine   ※ 実行プロセスや引数が記録される
            ・プロセスID ：                                  ProcessId       ※ タスクにより実行されたプロセスに対する、実行・アクセス履歴の調査に使用できる

OS：Windows 7

ユーザー

↓

OS：Windows

Server 2008 R2
管理者ユーザー

（続）

接続先

(Windows Server

2008 R2)

（続）

イベントログ

-

アプリケーションと

サービスログ

\Microsoft\Windows

\TaskScheduler

\Operational

タスク登録が行われた場合、以下のログが出力される

イベントID： 106 （タスクが登録されました）

      ・確認できる情報
            ・タスクを登録したユーザー ： 詳細タブ -> EventData\UserContext
            ・タスク名 ：                          詳細タブ -> EventData\TaskName

タスクが実行された場合、以下のログが出力される

イベントID： 200 （開始された操作）

      ・確認できる情報
            ・タスク名 ：                    詳細タブ -> EventData\TaskName
            ・実行されたコマンド ：      詳細タブ -> EventData\ActionName
            ・タスクのインスタンスID ： 詳細タブ -> EventData\TaskInstanceId

イベントID： 129 （タスクのプロセスが作成されました）
      ・詳細タブ -> EventData\TaskNameが、開始イベント（イベントID 200）に出力されているTaskNameと一致する

      ・確認できる情報
            ・実行されたプロセス ： 詳細タブ -> EventData\Path
            ・プロセスID ：             詳細タブ -> EventData\ProcessID※タスクにより実行されたプロセスに対する実行・アクセス履歴の調査に使用できる

イベントID： 201 （操作が完了しました）
      ・詳細タブ -> EventData\InstanceId が、開始イベント（イベントID 200）に出力されているTaskInstanceIdと一致する

      ・確認できる情報
            ・タスク名 ：                 詳細タブ -> EventData\TaskName
            ・実行されたコマンド ：  詳細タブ -> EventData\TaskActionName
            ・実行結果（戻り値） ：   詳細タブ -> EventData\ResultCode    ※ 戻り値の意味は、実行された処理により異なる

<備考>

記載のもの以外で出力される

可能性のあるイベントログ

タスクから呼び出されたコマンドに関連するログが出力される可能性がある

コマンド実行 > at

追加
設定

必要

-

23233.2.9. BITS

<基本情報>

ツール

動作条件

ログから

得られる情報

ツール名称

カテゴリ

ツール概要

攻撃時における

想定利用例

権限

対象OS

ドメインへの参加
通信プロトコル

サービス

標準設定

追加設定

実行成功時に確認できる痕跡

<確認ポイント>

BITS
コマンド実行
バックグラウンドでファイルを送受信する (送受信の際、優先度などを設定することが可能)
他の通信と比較して目立たない程度の帯域で、ファイルを送受信する
・接続元： BITSによってファイルを送信、受信しようとする端末
・接続先： ファイルの送受信先
標準ユーザー
Windows
不要
445/tcp
Background Intelligent Transfer Service
・接続元： Background Intelligent Transfer Service の実行状態が変わることで、BITSの使用を判断出来る可能性がある  ※ 但し、BITSが既に動作している場合は判断できない
・接続先： 有益な情報は記録されない
・接続元： BITSにより作成される一時ファイル"BITF[ランダム数字].tmp" に対する書き込みが記録される
・接続先： 有益な情報は記録されない
イベントログに以下のログがある場合、ファイルの転送が行われたと考えられる
      ・イベントログ「アプリケーションとサービスログ\Microsoft\Windows\Bits-Client」にイベントID: 60が記録されており、状態コードが"0x0"となっている

通信

ログの生成場所

ログ種別・名称

取得情報の詳細

イベントログ

-

セキュリティ

イベントログ

-

Sysmon

イベントID： 4656 （オブジェクトへのハンドルが要求されました）
                4663 （オブジェクトへのアクセスが試行されました）
                4658 （オブジェクトに対するハンドルが閉じました）
      ・オブジェクト -> オブジェクト名： "[ファイルが作成されたパス]\BITF[ランダム数字].tmp"
                                                      ※ "BITF"で名前が始まる一時ファイルが作成されることから、BITSによるファイル転送が発生したことが分かる
      ・確認できる情報
            ・ハンドルID（他ログとの紐付けに使用する）： オブジェクト -> ハンドルID
            ・ハンドルを要求したプロセスのプロセスID：   プロセス情報 -> プロセスID （イベント4688で作成されたプロセスのIDと一致する）
            ・処理内容：                                              アクセス要求情報 -> アクセス・アクセス理由 （"WriteData (または AddFile)"・
                                                                                               "AppendData (または AddSubdirectoryまたは CreatePipeInstance)"・"DELETE"）
            ・成否：                                                    キーワード （"成功の監査"）

イベントID： 2 （File creation time changed）
      ・Image名： "C:\Windows\system32\svchost.exe"

      ・確認できる情報
            ・タイムスタンプが変更された一時ファイル： "[ファイルが作成されたパス]\BITF[ランダム数字].tmp"

イベントID： 7036  （サービスの状態が移行しました）
      ・詳細タブ -> System\Provider\Name が "Service Control Manager" となっている
      ・詳細タブ -> EventData\param1 が "Background Intelligent Transfer Service" となっている

接続元

イベントログ

-

システム

      ・確認できる情報
            ・サービスの実行： 詳細タブ -> EventData\param2 （"実行中" ）

・備考
      ・端末を最後に起動してから、BITSを利用する処理を実行したことがある場合、ログが出力されない可能性がある
        (例えば、Windows Updateで使用されているため、Windows Updateでファイルをダウンロードした場合は出力されない可能性がある)

OS：Windows

ユーザー

↓

OS：Windows

ユーザー

イベントログ

-

アプリケーションと

サービスログ

\Microsoft\Windows

\Bits-Client

イベントID： 60

      ・確認できる情報
            ・対象ファイル：  詳細タブ -> ventData\url
            ・成否：             全般タブ -> 状態コード

レジストリエントリ： HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\BITS

      ・確認できる情報
            ・サービスの状態： StateIndex

実行履歴

-

レジストリ

・備考
      ・BITSの状態が「実行中」となることで変動する
      ・コマンド実行時にBITSが既に実行状態であった場合、値が変動しない

接続先

イベントログ

-

セキュリティ

イベントID： 5145 （クライアントに必要なアクセスを付与できるかどうかについて、ネットワーク共有オブジェクトがチェックされました）
      ・ネットワーク情報 -> 送信元アドレス： "[接続元ホスト]"
      ・ネットワーク情報 -> ソースアドレス： "[接続元ポート]"

      ・確認できる情報
            ・共有名：                     共有情報 -> 共有名
            ・共有パス：                  共有情報 -> 共有パス
            ・配置されたファイル名： 共有情報 -> 相対ターゲット名

<備考>

記載のもの以外で出力される

可能性のあるイベントログ

・オブジェクトの読み取りに対する監査を実施した場合、転送されたファイルに対する読み取りが記録される

コマンド実行 > BITS

  凡例
・取得出来る情報
・イベントID・項目名
・フィールド名
・"フィールドの値"

追加
設定

必要

必要

-

-

-

必要

24243.3.1. PwDump7

<基本情報>

ツール

動作条件

ログから

サービス
標準設定
追加設定
実行成功時に確認できる痕跡

得られる情報

ツール名称

カテゴリ

ツール概要

PwDump7
パスワード、ハッシュの入手
システム内のパスワードハッシュ一覧を表示する

攻撃時における

想定利用例

権限

対象OS

ドメインへの参加
通信プロトコル

取得したハッシュ情報を用い、他の端末に対するログオン認証をおこなう

管理者ユーザー
Windows
不要
-
-
・実行履歴（Prefetch）
・実行履歴（Sysmon・監査ポリシー）
イベントログ、実行履歴等では判断できない

<確認ポイント>

通信

ログの生成場所

ログ種別・名称

取得情報の詳細

-

端末

(Windows)

イベントID： 4688 （新しいプロセスが作成されました）
                4689 （プロセスが終了しました）
      ・プロセス情報 -> プロセス名： "[検体(PwDump7.exe)]"

・確認ポイント
            ・プロセスの開始・終了日時：                   ログの日付
            ・プロセスを実行したユーザー名：           サブジェクト -> アカウント名
            ・プロセスを実行したユーザーのドメイン： サブジェクト -> アカウント ドメイン
            ・プロセス実行時の権限昇格の有無：       プロセス情報 -> トークン昇格の種類
            ・プロセスの戻り値：                              プロセス情報 -> 終了状態

イベントID： 1 （Process Create）
                5 （Process Terminated）
      ・Image： "[検体(PwDump7.exe)]"

      ・確認できる情報
            ・プロセスの開始・終了日時（UTC）： UtcTime
            ・プロセスのコマンドライン：             CommandLine   ※ 使用されたオプションが引数として記録される
            ・実行ユーザー名：                        User
            ・プロセスID：                                ProcessId

ファイル名： C:\Windows\Prefetch\[実行ファイル（PWDUMP7.EXE）]-[文字列].pf

      ・確認できる情報 (ツールを利用して下記を確認できる ツール：WinPrefetchView)
            ・最終実行日時：                             Last Run Time

イベントログ

-

セキュリティ

イベントログ

-

Sysmon

実行履歴

-

Prefetch

<備考>

記載のもの以外で出力される

可能性のあるイベントログ

-

パスワード、ハッシュの入手 > PwDump7

  凡例
・取得出来る情報
・イベントID・項目名
・フィールド名
・"フィールドの値"

追加
設定

必要

必要

-

25253.3.2. PWDumpX

<基本情報>

ツール

動作条件

ログから

得られる情報

ツール名称

カテゴリ

ツール概要

攻撃時における

想定利用例

権限

対象OS

ドメインへの参加
通信プロトコル

サービス

標準設定

追加設定

実行成功時に確認できる痕跡

<確認ポイント>

PWDumpX
パスワード、ハッシュの入手
リモートホストからパスワードハッシュを取得する
取得したハッシュを用いて、pass-the-hashなどの攻撃をおこなう
・接続元： PWDumpX実行元
・接続先： PWDumpXによってログインされた先
・接続元： 標準ユーザー
・接続先： 管理者ユーザー
Windows
不要
135/tcp, 445/tcp
-
・両ホスト： 実行履歴（Prefetch）
・接続先： PWDumpXサービスがインストールされ、実行されたことが記録される
・接続元から接続先へ、PWDumpXサービスが送信され、実行されたことが記録される
・ハッシュ情報の作成・受領に、テキストファイルが利用されていることが記録される
・接続元： "[検体のパス]\[宛先アドレス]-PWHashes.txt"が作成されている場合、実行が成功したものと考えられる

通信

ログの生成場所

ログ種別・名称

取得情報の詳細

イベントID： 4688 （新しいプロセスが作成されました）
                4689 （プロセスが終了しました）
      ・プロセス情報 -> プロセス名：   " [検体（PWDumpX.exe）]"

      ・確認できる情報
            ・プロセスの開始・終了日時 ：                   ログの日付
            ・プロセスを実行したユーザー名 ：            サブジェクト -> アカウント名
            ・プロセスを実行したユーザーのドメイン ：  サブジェクト -> アカウント ドメイン
            ・プロセス実行時の権限昇格の有無 ：       プロセス情報 -> トークン昇格の種類
            ・プロセスの戻り値 ：                               プロセス情報 -> 終了状態

一時ファイルが作成される

イベントID： 4663 （オブジェクトへのアクセスが試行されました）
      ・プロセス情報 -> プロセス名：   " [検体（PWDumpX.exe）]"
      ・オブジェクト -> オブジェクト名：" [検体のパス]\[宛先アドレス]-PWHashes.txt"
　　         ※ 複数回上記ファイルに対して書き込みを実施する

イベントID： 4663 （オブジェクトへのアクセスが試行されました）
      ・プロセス情報 -> プロセス名：   " [検体（PWDumpX.exe）]"
      ・オブジェクト -> オブジェクト名：" [検体のパス]\[宛先アドレス]-PWHashes.txt.Obfuscated"

      ・確認できる情報
            ・ハンドルID：     オブジェクト -> ハンドル ID ※ 他ログとの紐付けに使用する
　　         ※ 複数回上記ファイルに対して書き込みを実施する

イベントログ

-

セキュリティ

接続元

一時ファイルが削除される

OS：Windows

ユーザー

↓

OS：Windows

管理者ユーザー

イベントログ

-

Sysmon

実行履歴

-

Prefetch

イベントID： 4663 （オブジェクトへのアクセスが試行されました）
      ・プロセス情報 -> プロセス名： " [検体（PWDumpX.exe）]"
      ・オブジェクト -> オブジェクト名：" [検体のパス]\[宛先アドレス]-PWHashes.txt.Obfuscated"

      ・確認できる情報
            ・ハンドルID： オブジェクト -> ハンドル ID ※ 他ログとの紐付けに使用する
            ・処理内容： アクセス要求情報 -> アクセス （"DELETE"）

イベントID： 1 （Process Create）
                5 （Process Terminated）
      ・Image： "[検体（PWDumpX.exe）]"

      ・確認できる情報
            ・プロセスの開始・終了日時（UTC） ：     UtcTime
            ・プロセスのコマンドライン ：                  CommandLine  ※ 接続先ホストや使用されたアカウントが引数に入る
            ・実行ユーザ名 ：                                 User
            ・プロセスID ：                                      ProcessId

ファイル名： C:\Windows\Prefetch\[検体（PWDUMPX.EXE）]-[検体].pf

      ・確認できる情報 (ツールを利用して下記を確認できる ツール：WinPrefetchView)
            ・最終実行日時 ：                            Last Run Time

イベントID： 4688 （新しいプロセスが作成されました）
                4689 （プロセスが終了しました）
      ・プロセス情報 -> プロセス名：   "[検体（DumpSvc.exe）]"

      ・確認できる情報
            ・プロセスの開始・終了日時 ：                   ログの日付
            ・プロセスを実行したユーザー名 ：            サブジェクト -> アカウント名
            ・プロセスを実行したユーザーのドメイン ：  サブジェクト -> アカウント ドメイン
            ・プロセス実行時の権限昇格の有無 ：       プロセス情報 -> トークン昇格の種類
            ・プロセスの戻り値 ：                               プロセス情報 -> 終了状態

イベントID： 5145 （クライアントに必要なアクセスを付与できるかどうかについて、ネットワーク共有オブジェクトがチェックされました）
      ・ネットワーク情報 -> 送信元アドレス： "[接続元]"
      ・共有情報 -> 共有名：                     "\\*\ADMIN$"
      ・共有情報 -> 相対ターゲット名：        "system32\DumpSvc.exe"・"system32\DumpExt.dll"

接続先

イベントログ
セキュリティ

イベントID： 4663 （オブジェクトへのアクセスが試行されました）
      ・プロセス情報 -> プロセス名：   "C:\Windows\System32\lsass.exe"
      ・オブジェクト -> オブジェクト名："C:\Windows\System32\PWHashes.txt"
                                                     "C:\Windows\System32\PWHashes.txt.Obfuscated"

      ・確認できる情報
            ・ハンドルID（他ログとの紐付けに使用する）： オブジェクト -> ハンドル ID
　　         ※ 複数回上記ファイルに対して書き込みを実施する

イベントID： 4663 （オブジェクトへのアクセスが試行されました）
      ・プロセス情報 -> プロセス名：   "C:\Windows\System32\lsass.exe"
      ・オブジェクト -> オブジェクト名："C:\Windows\System32\PWHashes.txt.Obfuscated"・"C:\Windows\System32\PWHashes.txt"
                                                     "C:\Windows\System32\DumpExt.dll"・"C:\Windows\System32\DumpSvc.exe"

      ・確認できる情報
            ・ハンドルID：    オブジェクト -> ハンドル ID ※ 他ログとの紐付けに使用する
            ・処理内容：      アクセス要求情報 -> アクセス （"DELETE"）

パスワード、ハッシュの入手 > PWDumpX

  凡例
・取得出来る情報
・イベントID・項目名
・フィールド名
・"フィールドの値"

追加
設定

必要

必要

-

必要

2626通信

ログの生成場所

ログ種別・名称

取得情報の詳細

OS：Windows

ユーザー

↓

OS：Windows

管理者ユーザー

（続）

接続先

（続）

イベントID： 1 （Process Create）
                5 （Process Terminated）
      ・Image： "C:\Windows\System32\DumpSvc.exe"

イベントログ

-

Sysmon

      ・確認できる情報
            ・プロセスの開始・終了日時（UTC） ：     UtcTime
            ・プロセスのコマンドライン ：                  CommandLine
            ・実行ユーザ名 ：                                 User
            ・プロセスID ：                                      ProcessId

イベントID： 8 （CreateRemoteThread detected:）
      ・Image：         "C:\Windows\System32\DumpSvc.exe"
      ・TargetImage: "C:\Windows\System32\lsass.exe"

イベントID： 7045 （サービスがシステムにインストールされました）
      ・サービス名：               （"PWDumpX Service"）
      ・サービス ファイル名： （"%windir%\system32\DumpSvc.exe"）

イベントID： 7036 （サービスの状態が移行しました）
      ・サービス名：               （"PWDumpX Service"）
     ※ サービス"PWDumpX Service"が、リモートプロセス実行前に"実行中"となり、実行後に"停止"となる

ファイル名： C:\Windows\Prefetch\DUMPSVC.EXE-DB3A90FA.pf

      ・確認できる情報 (ツールを利用して下記を確認できる ツール：WinPrefetchView)
            ・最終実行日時 ：                            Last Run Time

イベントログ

-

システム

実行履歴
Prefetch

<備考>

記載のもの以外で出力される

可能性のあるイベントログ

-

パスワード、ハッシュの入手 > PWDumpX

追加
設定

必要

-

-

27273.3.3. Quarks PwDump

<基本情報>

ツール

動作条件

ログから

得られる情報

実行成功時に確認できる痕跡

<確認ポイント>

ツール名称

カテゴリ

ツール概要

Quarks PwDump
パスワード、ハッシュの入手
ローカル・ドメインアカウントのNTLMハッシュや、キャッシュされたドメインパスワードを取得する
端末内の情報に加え、NTDS.DITファイルを指定して解析することも可能

攻撃時における

想定利用例

権限

対象OS

ドメインへの参加
通信プロトコル

サービス
標準設定

追加設定

取得したハッシュ情報を用い、他の端末に対するログオン認証をおこなう

管理者ユーザー
Windows
不要
-
-
・実行履歴（Prefetch）
・実行履歴（Sysmon・監査ポリシー）
・一時ファイル（"SAM-[ランダム数字].dmp"）が作成されたことの記録
・一時ファイル（"SAM-[ランダム数字].dmp"）が作成され、削除されている

パスワード、ハッシュの入手 > Quarks PwDump

  凡例
・取得出来る情報
・イベントID・項目名
・フィールド名
・"フィールドの値"

通信

ログの生成場所

ログ種別・名称

取得情報の詳細

-

端末

(Windows)

イベントID： 4688 （新しいプロセスが作成されました）
                4689 （プロセスが終了しました）
      ・プロセス情報 -> プロセス名：   "[検体（QuarksPwDump.exe）]"

      ・確認できる情報
            ・プロセスの開始・終了日時 ：                   ログの日付
            ・プロセスを実行したユーザー名 ：            サブジェクト -> アカウント名
            ・プロセスを実行したユーザーのドメイン ：  サブジェクト -> アカウント ドメイン
            ・プロセス実行時の権限昇格の有無 ：       プロセス情報 -> トークン昇格の種類
            ・プロセスの戻り値 ：                               プロセス情報 -> 終了状態 ※ 成功の場合は"0x0"、失敗の場合はそれ以外の値となる

イベントID： 4656 （オブジェクトへのハンドルが要求されました）
                4663 （オブジェクトへのアクセスが試行されました）
                4658 （オブジェクトに対するハンドルが閉じました）
      ・プロセス情報 -> プロセス名：  "[検体（QuarksPwDump.exe）]"

      ・確認できる情報
            ・対象ファイル： オブジェクト -> オブジェクト名 （"C:\Users\[ユーザー名]\AppData\Local\Temp\SAM-[ランダム数字].dmp"）
            ・ハンドルID：    オブジェクト -> ハンドル ID   ※ 他ログとの紐付けに使用する
            ・処理内容：     アクセス要求情報 -> アクセス （"WriteData (または AddFile)"）

イベントID： 4656 （オブジェクトへのハンドルが要求されました）
                4660 （ファイルが削除されました）
                4658 （オブジェクトに対するハンドルが閉じました）
      ・プロセス情報 -> プロセス名：    "[検体（QuarksPwDump.exe）]"
      ・プロセス情報 -> プロセスID：    "[検体のプロセスID]"
      ・オブジェクト -> オブジェクト名： "C:\Users\[ユーザー名]\AppData\Local\Temp\SAM-[ランダム数字].dmp"

      ・確認できる情報
            ・ハンドルID：         オブジェクト -> ハンドル ID    ※ 他ログとの紐付けに使用する
            ・要求された処理： アクセス要求情報 -> アクセス・アクセス理由 （"DELETE"）
            ・成否：                 キーワード （"成功の監査"）

イベントID： 1 （Process Create）
                5 （Process Terminated）
      ・Image： "[検体（QuarksPwDump.exe）]"

      ・確認できる情報
            ・プロセスの開始・終了日時（UTC）： UtcTime
            ・プロセスのコマンドライン：              CommandLine ※ 指定されたオプション（取得されたパスワードの種類）が引数に記録される
            ・実行ユーザー名：                         User
            ・プロセスID：                                 ProcessId

ファイル名： C:\Windows\Prefetch\[検体（QUARKSPWDUMP.EXE）]-[文字列].pf

      ・確認できる情報 (ツールを利用して下記を確認できる ツール：WinPrefetchView)
            ・最終実行日時 ：                            Last Run Time

イベントログ

-

セキュリティ

イベントログ

-

Sysmon

実行履歴

-

Prefetch

<備考>

記載のもの以外で出力される

可能性のあるイベントログ

-

追加
設定

必要

必要

-

28283.3.4. Mimikatz (パスワードハッシュ入手)

<基本情報>

ツール

動作条件

ツール名称

カテゴリ

ツール概要

攻撃時における

想定利用例

権限

対象OS

ドメインへの参加
通信プロトコル

ログから

サービス
標準設定
追加設定
実行成功時に確認できる痕跡

得られる情報

mimikatz > sekurlsa::logonpasswords
mimikatz > lsadump::sam
パスワード、ハッシュの入手
記憶された認証情報を搾取

パスワードを取得したり、ドメインAdministrator権限に昇格する際に実行する

管理者ユーザー
Windows
不要
-
-
・実行履歴（Prefetch）
・実行履歴（Sysmon・監査ポリシー）
イベントログ、実行履歴等では判断できない

<確認ポイント>

通信

ログの生成場所

ログ種別・名称

取得情報の詳細

-

端末

(Windows)

イベントログ

-

セキュリティ

イベントログ

-

Sysmon

実行履歴

-

Prefetch

イベントID： 4688 （新しいプロセスが作成されました）

 4689 （プロセスが終了しました）

・プロセス情報 -> プロセス名： "[検体（mimikatz.exe）]"

・確認できる情報

・プロセスの開始・終了日時：
・プロセスを実行したユーザー名：
・プロセスを実行したユーザーのドメイン： サブジェクト -> アカウント ドメイン
・プロセス実行時の権限昇格の有無：
・プロセスの戻り値：

  プロセス情報 -> トークン昇格の種類
 プロセス情報 -> 終了状態

  サブジェクト -> アカウント名

ログの日付

イベントID： 1 （Process Create）

 5 （Process Terminated）
・Image： "[検体（mimikatz.exe）]"

・確認できる情報

・プロセスの開始・終了日時（UTC）： UtcTime
・プロセスのコマンドライン：
・実行ユーザー名：
・プロセスID：

  CommandLine   ※ 使用されたオプションが引数として記録される
 User
 ProcessId

ファイル名： C:\Windows\Prefetch\[実行ファイル（MIMIKATZ.EXE）]-[文字列].pf

・確認できる情報 (ツールを利用して下記を確認できる ツール：WinPrefetchView)

・最終実行日時：

 Last Run Time

<備考>

記載のもの以外で出力される

可能性のあるイベントログ

-

パスワード、ハッシュの入手  > mimikatz
・mimikatz > sekurlsa::logonpasswords
・mimikatz > lsadump::sam

 凡例
・取得出来る情報
・イベントID・項目名
・フィールド名
・"フィールドの値"

追加
設定

必要

必要

-

29293.3.5. Mimikatz (チケット入手)

<基本情報>

ツール

動作条件

ログから

サービス
標準設定
追加設定
実行成功時に確認できる痕跡

得られる情報

ツール名称

カテゴリ

ツール概要

mimikatz > sekurlsa::tickets
パスワード、ハッシュの入手
端末が全てのセッションのチケットを取得する

攻撃時における

想定利用例

権限

対象OS

ドメインへの参加
通信プロトコル

リモートでコマンドを実行するためにチケットを取得する

管理者ユーザー
Windows
不要
-
-
・実行履歴（Prefetch）
・実行履歴（Sysmon・監査ポリシー）  ※ チケットを出力したファイルが生成されたことが記録される
・チケットを出力したファイルが生成された場合、処理が成功したものと考えられる

<確認ポイント>

通信

ログの生成場所

ログ種別・名称

取得情報の詳細

イベントID： 4688 （新しいプロセスが作成されました）
                4689 （プロセスが終了しました）
      ・プロセス情報 -> プロセス名： "[検体（mimikatz.exe）]"

      ・確認できる情報
            ・プロセスの開始・終了日時：                   ログの日付
            ・プロセスを実行したユーザー名：           サブジェクト -> アカウント名
            ・プロセスを実行したユーザーのドメイン： サブジェクト -> アカウント ドメイン
            ・プロセス実行時の権限昇格の有無：       プロセス情報 -> トークン昇格の種類
            ・プロセスの戻り値：                              プロセス情報 -> 終了状態

全チケットを処理するまで以下イベントID:4656、4663、4658の処理を繰り返す

イベントID： 4656 （オブジェクトに対するハンドルが要求されました）
      ・プロセス情報 -> プロセス名： "[検体（mimikatz.exe）]"

パスワード、ハッシュの入手 > mimikatz
・mimikatz > sekurlsa::tickets

  凡例
・取得出来る情報
・イベントID・項目名
・フィールド名
・"フィールドの値"

追加
設定

イベントログ

-

セキュリティ

      ・確認できる情報
            ・対象ファイル： オブジェクト -> オブジェクト名 （"[チケットファイル名]"）
            ・ハンドルID：    オブジェクト -> ハンドル ID   ※ 他ログとの紐付けに使用する
            ・処理内容：      アクセス要求情報 -> アクセス （"READ_CONTROL"、"SYNCHRONIZE"、"WriteData (または AddFile)"、"AppendData (または
                                                                     AddSubdirectory または CreatePipeInstance)"、"WriteEA"、"ReadAttributes"、"WriteAttributes"）

必要

-

端末

(Windows)

イベントID： 4663 （オブジェクトへのアクセスが試行されました）

      ・確認できる情報
            ・ハンドルID： オブジェクト -> ハンドル ID   ※ 他ログとの紐付けに使用する
            ・処理内容：   アクセス要求情報 -> アクセス （"WriteData (または AddFile)"、"AppendData (または AddSubdirectory または
                                                                                                                                                           CreatePipeInstance)"）

イベントID： 4658 （オブジェクトに対するハンドルが閉じました）

      ・確認できる情報
            ・ハンドルID： オブジェクト -> ハンドル ID

イベントID： 1 （Process Create）
                5 （Process Terminated）
     ・Image： "[検体（mimikatz.exe）]"

イベントログ

-

Sysmon

実行履歴

-

Prefetch

      ・確認できる情報
            ・プロセスの開始・終了日時（UTC）： UtcTime
            ・プロセスのコマンドライン：             CommandLine   ※ 使用されたオプションが引数として記録される （イベントID 1に記録される）
            ・実行ユーザー名：                        User
            ・プロセスID：                                ProcessId

ファイル名： C:\Windows\Prefetch\[実行ファイル（MIMIKATZ.EXE）]-[文字列].pf

      ・確認できる情報 (ツールを利用して下記を確認できる ツール：WinPrefetchView)
            ・最終実行日時：                             Last Run Time

必要

-

<備考>

記載のもの以外で出力される

可能性のあるイベントログ

-

30303.3.6. WCE (Windows Credentials Editor)　

<基本情報>

ツール

動作条件

ログから

得られる情報

実行成功時に確認できる痕跡

<確認ポイント>

ツール名称

カテゴリ

ツール概要

WCE (Windows Credentials Editor)
パスワード、ハッシュの入手
ログイン端末のメモリ内に存在する、パスワードハッシュ情報を取得する

攻撃時における

想定利用例

権限

対象OS

ドメインへの参加
通信プロトコル

サービス
標準設定

追加設定

取得したハッシュ情報を用いて、pass-the-hashなどの攻撃を実施する

管理者ユーザー
Windows
不要
-
-
・実行履歴（Prefetch）
・検体が実行されたこと、及び検体実行時に使用されたオプション（Sysmon）
・検体による、lsass.exeの参照（Sysmon）
・ファイルの作成・削除（監査ポリシー）
・"C:\Users\[ユーザー名]\AppData\Local\Temp\wceaux.dll"ファイルが作成、削除されている

パスワード、ハッシュの入手 > WCE (Windows Credentials Editor)

  凡例
・取得出来る情報
・イベントID・項目名
・フィールド名
・"フィールドの値"

通信

ログの生成場所

ログ種別・名称

取得情報の詳細

イベントID： 4688 （新しいプロセスが作成されました）
                4689 （プロセスが終了しました）
      ・プロセス情報 -> プロセス名：   "[検体（ｗｃｅ.exe）]"

      ・確認できる情報
            ・プロセスの開始・終了日時 ：                   ログの日付
            ・プロセスを実行したユーザー名 ：            サブジェクト -> アカウント名
            ・プロセスを実行したユーザーのドメイン ：  サブジェクト -> アカウント ドメイン
            ・プロセス実行時の権限昇格の有無 ：       プロセス情報 -> トークン昇格の種類
            ・プロセスの戻り値 ：                               プロセス情報 -> 終了状態

イベントID： 4656 （オブジェクトへのハンドルが要求されました）
                4663 （オブジェクトへのアクセスが試行されました）
                4658 （オブジェクトに対するハンドルが閉じました）
      ・プロセス情報 -> プロセス名：  "[検体（ｗｃｅ.exe）]"

イベントログ

-

セキュリティ

      ・確認できる情報
            ・対象ファイル： オブジェクト -> オブジェクト名：("C:\Users\[ユーザー名]\AppData\Local\Temp\wceaux.dll")
            ・ハンドルID：    オブジェクト -> ハンドル ID  ※ 他ログとの紐付けに使用する
            ・処理内容：      アクセス要求情報 -> アクセス （"READ_CONTROL"、"SYNCHRONIZE"、"ReadData (または ListDirectory)"、
                                                                    "WriteData (またはAddFile)"、"AppendData (または AddSubdirectory または CreatePipeInstance)"、
                                                                    "ReadEA"、"WriteEA"、"ReadAttributes"、"WriteAttributes"）
            ・成否：             キーワード （"成功の監査"）

－

端末

(Windows)

イベントID： 4656 （オブジェクトに対するハンドルが要求されました）
                 4660 （オブジェクトが削除されました）
                 4658 （オブジェクトに対するハンドルが閉じました）
  ・プロセス情報 -> プロセス名：  "[検体（ｗｃｅ.exe）]"

      ・確認できる情報
            ・対象ファイル： オブジェクト -> オブジェクト名：("C:\Users\[ユーザー名]\AppData\Local\Temp\wceaux.dll")
            ・ハンドルID：    オブジェクト -> ハンドル ID  ※ 他ログとの紐付けに使用する
            ・処理内容：     アクセス要求情報 -> アクセス （"DELETE"）
            ・成否：           キーワード （"成功の監査"）

イベントID： 1 （Process Create）
                5 （Process Terminated）
      ・Image： "[検体（ｗｃｅ.exe）]"

      ・確認できる情報
            ・プロセスの開始・終了日時（UTC） ：     UtcTime
            ・プロセスのコマンドライン ：                  CommandLine
            ・実行ユーザ名 ：                                 User
            ・プロセスID ：                                      ProcessId

イベントログ

-

Sysmon

イベントID： 8 （CreateRemoteThread detected）
      ・Image：           "[検体（ｗｃｅ.exe）]"
      ・TargetImage： "C:\Windows\System32\lsass.exe"

      ・確認できる情報
            ・プロセスの開始日時（UTC）： UtcTime

実行履歴

-

Prefetch

ファイル名： C:\Windows\Prefetch\[検体（WCE.EXE）]-[文字列].pf

      ・確認できる情報 (ツールを利用して下記を確認できる ツール：WinPrefetchView)
            ・最終実行日時 ：                            Last Run Time

<備考>

記載のもの以外で出力される

可能性のあるイベントログ

-

追加
設定

必要

必要

-

31313.3.7. gsecdump

<基本情報>

ツール

動作条件

ログから

サービス
標準設定
追加設定
実行成功時に確認できる痕跡

得られる情報

ツール名称

カテゴリ

ツール概要

gsecdump
パスワード、ハッシュの入手
SAM/ADやログオンセッションから、ハッシュを抽出するツール

攻撃時における

想定利用例

権限

対象OS

ドメインへの参加
通信プロトコル

取得したハッシュ情報を用い、他の端末に対してログオンする

管理者ユーザー
Windows 32ビット (64ビット環境で動作する検体は未確認)
不要
-
-
・実行履歴（Prefetch）
・実行履歴（Sysmon・監査ポリシー）
イベントログ、実行履歴等では判断できない

<確認ポイント>

通信

ログの生成場所

ログ種別・名称

取得情報の詳細

-

端末

(Windows)

イベントID： 4688 （新しいプロセスが作成されました）
                4689 （プロセスが終了しました）
      ・プロセス情報 -> プロセス名： "[検体]"

      ・確認できる情報
            ・プロセスの開始・終了日時：                   ログの日付
            ・プロセスを実行したユーザー名：           サブジェクト -> アカウント名
            ・プロセスを実行したユーザーのドメイン： サブジェクト -> アカウント ドメイン
            ・プロセス実行時の権限昇格の有無：       プロセス情報 -> トークン昇格の種類
            ・プロセスの戻り値：                              プロセス情報 -> 終了状態

イベントID： 1 （Process Create）
                5 （Process Terminated）
     ・Image： "[検体]"

      ・確認できる情報
            ・プロセスの開始・終了日時（UTC）： UtcTime
            ・プロセスのコマンドライン：             CommandLine   ※ 使用されたオプションが引数として記録される
            ・実行ユーザー名：                        User
            ・プロセスID：                                ProcessId

ファイル名： C:\Windows\Prefetch\[検体(GSECDUMP.EXE)]-[文字列].pf

      ・確認できる情報 (ツールを利用して下記を確認できる ツール：WinPrefetchView)
            ・最終実行日時：                             Last Run Time

イベントログ

-

セキュリティ

イベントログ

-

Sysmon

実行履歴

-

Prefetch

<備考>

記載のもの以外で出力される

可能性のあるイベントログ

-

パスワード、ハッシュの入手 > gsecdump

  凡例
・取得出来る情報
・イベントID・項目名
・フィールド名
・"フィールドの値"

追加
設定

必要

必要

-

32323.3.8. lslsass

<基本情報>

ツール

動作条件

ログから

サービス
標準設定
追加設定
実行成功時に確認できる痕跡

得られる情報

ツール名称

カテゴリ

ツール概要

lslsass
パスワード、ハッシュ入手
lsassプロセスから、有効なログオンセッションのパスワードハッシュを取得する

攻撃時における

想定利用例

権限

対象OS

ドメインへの参加
通信プロトコル

取得したハッシュ情報を用い、他の端末に対するログオン認証をおこなう

管理者ユーザー
Windows
不要
-
-
・実行履歴（Prefetch）
・実行履歴（Sysmon・アクセス履歴）
イベントログ、実行履歴等では判断できない

<確認ポイント>

通信

ログの生成場所

ログ種別・名称

取得情報の詳細

-

端末

(Windows)

イベントログ

-

セキュリティ

イベントログ

-

Sysmon

実行履歴
Prefetch

イベントID： 4688 （新しいプロセスが作成されました）
                4689 （プロセスが終了しました）
      ・プロセス情報 -> プロセス名： "[検体（lslsass[ビット数].exe）]"

      ・確認できる情報
            ・プロセスの開始・終了日時：                   ログの日付
            ・プロセスを実行したユーザー名：           サブジェクト -> アカウント名
            ・プロセスを実行したユーザーのドメイン： サブジェクト -> アカウント ドメイン
            ・プロセスの戻り値：                              プロセス情報 -> 終了状態

イベントID： 1 （Process Create）
                5 （Process Terminated）
     ・Image： "[検体（lslsass[ビット数].exe）]"

      ・確認できる情報
            ・プロセスの開始・終了日時（UTC）： UtcTime
            ・プロセスのコマンドライン：             CommandLine   ※ 使用されたオプションが引数として記録される
            ・実行ユーザー名：                        User
            ・プロセスID：                                ProcessId

ファイル名： C:\Windows\Prefetch\[実行ファイル（LSLSASS[ビット数].EXE）]-[文字列].pf

      ・確認できる情報 (ツールを利用して下記を確認できる ツール：WinPrefetchView)
            ・最終実行日時：                             Last Run Time

<備考>

記載のもの以外で出力される

可能性のあるイベントログ

パスワード、ハッシュ入手 > lslsass

  凡例
・取得出来る情報
・イベントID・項目名
・フィールド名
・"フィールドの値"

追加
設定

必要

必要

-

33333.3.9. Find-GPOPasswords.ps1

<基本情報>

ツール

動作条件

ログから

得られる情報

実行成功時に確認できる痕跡

<確認ポイント>

ツール名称

カテゴリ

ツール概要

Find-GPOPasswords.ps1
パスワード、ハッシュの入手
グループポリシーのファイルにパスワードの記載がある場合、それを取得する

攻撃時における

想定利用例

権限

対象OS

ドメインへの参加
通信プロトコル

サービス

標準設定

追加設定

取得したパスワードを用いて、他ホストへの侵入などを試みる (Active Directory上で実行する)

管理者ユーザー
Windows Server
本調査はドメインコントローラー上で実施
要
-
-
・実行履歴（Prefetch）
     ※ 通常時からPowerShellを使用している場合は参考にならない
・PowerShellを起動したことが記録される
・パスワードをダンプしたファイル（GPPDataReport-[ドメイン名]-[日時].csv）を出力したことが記録される
・パスワードをダンプした結果のファイル（GPPDataReport-[ドメイン名]-[日時].csv）が出力されている

パスワード、ハッシュの入手 > Find-GPOPasswords.ps1

  凡例
・取得出来る情報
・イベントID・項目名
・フィールド名
・"フィールドの値"

通信

ログの生成場所

ログ種別・名称

取得情報の詳細

追加
設定

イベントID： 4688 （新しいプロセスが作成されました）
                4689 （プロセスが終了しました）
      ・プロセス情報 -> プロセス名：   "C:\Windows\System32\WindowsPowerShell\v1.0\powershell.exe"

      ・確認できる情報
            ・プロセスの開始・終了日時 ：                   ログの日付
            ・プロセスを実行したユーザー名 ：            サブジェクト -> アカウント名
            ・プロセスを実行したユーザーのドメイン ：  サブジェクト -> アカウント ドメイン
            ・プロセス実行時の権限昇格の有無 ：       プロセス情報 -> トークン昇格の種類
            ・プロセスの戻り値 ：                               プロセス情報 -> 終了状態

イベントID： 4656 （オブジェクトに対するハンドルが要求されました）
      ・プロセス情報 -> プロセス名：   "C:\Windows\System32\WindowsPowerShell\v1.0\powershell.exe"

      ・確認できる情報
            ・対象ファイル： オブジェクト -> オブジェクト名：("C:\Users\[ユーザー名]\AppData\Local\Microsoft\Windows\SchCache
                                                                                                                                     \[ドメインコントローラーFQDN].sch")
            ・ハンドルID：    オブジェクト -> ハンドル ID   ※ 他ログとの紐付けに使用する
            ・処理内容：     アクセス要求情報 -> アクセス （"READ_CONTROL","SYNCHRONIZE","WriteData (または AddFile)","
                               AppendData (またはAddSubdirectory または CreatePipeInstance)","WriteEA","ReadAttributes","WriteAttributes"）

イベントID： 4663 （オブジェクトへのアクセスが試行されました）
      ・プロセス情報 -> プロセス名：   "C:\Windows\System32\WindowsPowerShell\v1.0\powershell.exe"

      ・確認できる情報
            ・ハンドルID： オブジェクト -> ハンドル ID  ※ 他ログとの紐付けに使用する
            ・処理内容：  アクセス要求情報 -> アクセス （"WriteData (または AddFile)"、"AppendData (または AddSubdirectory
                                                                                                                                          または CreatePipeInstance)")

イベントID： 4658 （オブジェクトに対するハンドルが閉じました）
      ・プロセス情報 -> プロセス名：   "C:\Windows\System32\WindowsPowerShell\v1.0\powershell.exe"

イベントログ

-

セキュリティ

      ・確認できる情報
            ・ハンドルID： オブジェクト内、ハンドル ID    ※ 先に出力される、イベント4663で記録されるハンドルIDと同じ

必要

-

Active Directory
ドメインコントロー

ラー

(Windows Server)

イベントID： 4656 （オブジェクトに対するハンドルが要求されました）
      ・プロセス情報 -> プロセス名：   "C:\Windows\System32\WindowsPowerShell\v1.0\powershell.exe"

      ・確認できる情報
            ・対象ファイル： オブジェクト -> オブジェクト名：("GPPDataReport-[ドメイン名]-[日時].csv")
            ・ハンドルID：    オブジェクト -> ハンドル ID   ※ 他ログとの紐付けに使用する
            ・処理内容：     アクセス要求情報 -> アクセス （"READ_CONTROL","SYNCHRONIZE","WriteData (または AddFile)","
                               AppendData (またはAddSubdirectory または CreatePipeInstance)","WriteEA","ReadAttributes","WriteAttributes"）

イベントID： 4663 （オブジェクトへのアクセスが試行されました）
      ・プロセス情報 -> プロセス名：   "C:\Windows\System32\WindowsPowerShell\v1.0\powershell.exe"

      ・確認できる情報
            ・対象ファイル： オブジェクト -> オブジェクト名：("GPPDataReport-[ドメイン名]-[日時].csv")
            ・ハンドルID：    オブジェクト -> ハンドル ID  ※ 他ログとの紐付けに使用する
            ・処理内容：      アクセス要求情報 -> アクセス （"WriteData (または AddFile)"、"AppendData (または AddSubdirectory
                                                                                                                                          または CreatePipeInstance)")

イベントID： 4658 （オブジェクトに対するハンドルが閉じました）
      ・プロセス情報 -> プロセス名：   "C:\Windows\System32\WindowsPowerShell\v1.0\powershell.exe"

      ・確認できる情報
            ・ハンドルID： オブジェクト -> ハンドル ID   ※ 先に出力される、イベント4663で記録されるハンドルIDと同じ

イベントID： 4689 （プロセスが終了しました）
      ・プロセス情報 -> プロセス名：   "C:\Windows\System32\WindowsPowerShell\v1.0\powershell.exe"

      ・確認できる情報
            ・プロセスの終了日時： ログの日付
            ・プロセスの戻り値：     プロセス情報 -> 終了状態

イベントログ

-

Sysmon

イベントID： 1 （Process Create）
                5 （Process Terminated）
      ・Image："C:\Windows\System32\Windows PowerShell\v1.0\powershell.exe"

      ・確認できる情報
            ・プロセスの開始・終了日時（UTC）： UtcTime
            ・実行ユーザー名：                         User
            ・プロセスID：                                 ProcessId

必要

<備考>

記載のもの以外で出力される

可能性のあるイベントログ

-

34343.3.10. Mail PassView

<基本情報>

ツール

ツール名称

カテゴリ

ツール概要

Mail PassView
パスワード、ハッシュの入手
端末上のメールクライアントの設定に保存されているアカウント情報を抽出する

攻撃時における

想定利用例

本ツールを使用して取得した情報を用いて、メールを送受信する
同じユーザ名・パスワードが他所でも使用されている場合、利用される可能性がある

パスワード、ハッシュの入手 > Mail PassView

  凡例
・取得出来る情報
・イベントID・項目名
・フィールド名
・"フィールドの値"

動作条件

ログから

得られる情報

権限

対象OS

ドメインへの参加
通信プロトコル

サービス
標準設定
追加設定

実行成功時に確認できる痕跡

標準ユーザー
Windows
不要
-
-
・実行履歴（Prefetch）
・実行履歴（Sysmon・監査ポリシー）
イベントログ、実行履歴等では判断できない   ※ 抽出したパスワードが保存されている場合は、成功したと判断できる
                                                              保存されている情報に対するパスワード保護がある場合などは本検体で解読できないため、実行の成功と情報収集の成功は必ずしも一致しない

<確認ポイント>

通信

ログの生成場所

ログ種別・名称

取得情報の詳細

-

端末

(Windows)

イベントID： 4688 （新しいプロセスが作成されました）
                4689 （プロセスが終了しました）
      ・プロセス情報 -> 新しいプロセス名： "[検体(mailpv.exe)]"

      ・確認できる情報
            ・プロセスの開始・終了日時 ：                ログの日付
            ・プロセスを実行したユーザー名 ：         サブジェクト -> アカウント名
            ・プロセスを実行したユーザのドメイン ：  サブジェクト -> アカウント ドメイン
            ・プロセス実行時の権限昇格の有無：      プロセス情報 -> トークン昇格の種類
            ・プロセスの戻り値 ：                            プロセス情報 -> 終了状態

イベントID： 4663 （オブジェクトへのアクセスが試行されました）
                 4656 （オブジェクトへのハンドルが要求されました）
                 4658 （オブジェクトに対するハンドルが閉じました）
      ・プロセス情報 -> プロセス名： "[検体(mailpv.exe)]"

      ・確認できる情報
            ・対象ファイル： オブジェクト -> オブジェクト名 ："[引数で指定したファイル]"
            ・ハンドルID：    オブジェクト -> ハンドル ID   ※ 他ログとの紐付けに使用する
            ・処理内容：     アクセス要求情報 -> アクセス （"WriteData (または AddFile)"）

イベントID： 1 （Process Create）
                 5 （Process Terminated）
      ・Image： "[検体(mailpv.exe)]"

      ・確認できる情報
            ・プロセスの開始・終了日時（UTC）：   UtcTime
            ・プロセスのコマンドライン：               CommandLine   ※ 出力先となるテキストファイル名を、引数で指定する
            ・実行ユーザー名：                          User
            ・プロセスID：                                  ProcessId

ファイル名： C:\Windows\Prefetch\[検体(MAILPV.EXE)]-[文字列].pf

      ・確認できる情報 (ツールを利用して下記を確認できる ツール：WinPrefetchView)
            ・最終実行日時：                             Last Run Time

イベントログ

-

セキュリティ

イベントログ

-

Sysmon

実行履歴

-

Prefetch

<備考>

記載のもの以外で出力される

可能性のあるイベントログ

Mail PassViewが対応しているメールクライアントのプロファイルに、読み取りアクセスが発生する可能性がある

追加
設定

必要

必要

-

35353.3.11. WebBrowserPassView

ツール名称

カテゴリ

ツール概要

WebBrowserPassView
パスワード、ハッシュの入手
端末のWebブラウザに保存されているユーザー名・パスワードを抽出する

イントラネットや外部サービスを利用する際に入力するアカウント情報を抽出し、利用する

<基本情報>

ツール

動作条件

ログから

得られる情報

攻撃時における

想定利用例

権限

対象OS

ドメインへの参加
通信プロトコル

サービス
標準設定
追加設定

実行成功時に確認できる痕跡

<確認ポイント>

パスワード、ハッシュの入手 > WebBrowserPassView

  凡例
・取得出来る情報
・イベントID・項目名
・フィールド名
・"フィールドの値"

標準ユーザー
Windows
不要
-
-
・実行履歴（Prefetch）
・実行履歴（Sysmon・監査ポリシー）
イベントログ、実行履歴等では判断できない   ※ 抽出したパスワードが保存されている場合は、成功したと判断できる
                                                              保存されている情報に対するパスワード保護がある場合などは本検体で解読できないため、実行の成功と情報収集の成功は必ずしも一致しない

通信

ログの生成場所

ログ種別・名称

取得情報の詳細

-

端末

(Windows)

イベントID： 4688 （新しいプロセスが作成されました）
                4689 （プロセスが終了しました）
      ・プロセス情報 -> プロセス名： "[検体(WebBrowserPassView.exe)]"

      ・確認できる情報
            ・プロセスの開始・終了日時 ：                ログの日付
            ・プロセスを実行したユーザー名 ：         サブジェクト -> アカウント名
            ・プロセスを実行したユーザのドメイン ：  サブジェクト -> アカウント ドメイン
            ・プロセス実行時の権限昇格の有無：      プロセス情報 -> トークン昇格の種類
            ・プロセスの戻り値 ：                            プロセス情報 -> 終了状態

イベントID： 4663 （オブジェクトへのアクセスが試行されました）
                 4656 （オブジェクトへのハンドルが要求されました）
                 4658 （オブジェクトに対するハンドルが閉じました）
      ・プロセス情報 -> プロセス名： "[検体(WebBrowserPassView.exe)]"

      ・確認できる情報
            ・対象ファイル： オブジェクト -> オブジェクト名 ："[引数で指定したファイル]"
            ・ハンドルID：    オブジェクト -> ハンドル ID   ※ 他ログとの紐付けに使用する
            ・処理内容：     アクセス要求情報 -> アクセス （"WriteData (または AddFile)"）

イベントID： 1 （Process Create）
                 5 （Process Terminated）
      ・Image： "[検体(WebBrowserPassView.exe)]"

      ・確認できる情報
            ・プロセスの開始・終了日時（UTC）：   UtcTime
            ・プロセスのコマンドライン：               CommandLine   ※ 出力先となるテキストファイル名を、引数で指定する
            ・実行ユーザー名：                          User
            ・プロセスID：                                  ProcessId

ファイル名： C:\Windows\Prefetch\[検体(WEBBROWSERPASSVIEW.EXE)]-[文字列].pf

      ・確認できる情報 (ツールを利用して下記を確認できる ツール：WinPrefetchView)
            ・最終実行日時：                             Last Run Time

イベントログ

-

セキュリティ

イベントログ

-

Sysmon

実行履歴
Prefetch

追加
設定

必要

必要

-

<備考>

記載のもの以外で出力される

可能性のあるイベントログ

・WebBrowserPassViewが対応しているブラウザがシステム上にインストールされている場合、各ブラウザのプロファイルに対する読み取りが発生する
・最新のWebBrowserPassViewはGUI用であり、実行後に設定を"[検体名].cfg"に保存する特徴がある

36363.3.12. Remote Desktop PassView

<基本情報>

ツール

動作条件

ログから

サービス
標準設定
追加設定
実行成功時に確認できる痕跡

得られる情報

ツール名称

カテゴリ

ツール概要

Remote Desktop PassView
パスワード、ハッシュの入手
端末上のRDPの設定に保存されているアカウント情報を抽出する

攻撃時における

想定利用例

権限

対象OS

ドメインへの参加
通信プロトコル

リモートデスクトップの設定ファイル内に保存されているパスワードを抽出し、そのパスワードを用いて他のホストへログインする

標準ユーザー
Windows
不要
-
-
・実行履歴（Prefetch）
・実行履歴（Sysmon・監査ポリシー）
イベントログ、実行履歴等では判断できない   ※ 抽出したパスワードが保存されている場合は、成功したと判断できる

パスワード、ハッシュの入手 > Remote Desktop PassView

  凡例
・取得出来る情報
・イベントID・項目名
・フィールド名
・"フィールドの値"

<確認ポイント>

通信

ログの生成場所

ログ種別・名称

取得情報の詳細

イベントID： 4688 （新しいプロセスが作成されました）
                4689 （プロセスが終了しました）
      ・プロセス情報 -> プロセス名： "[検体（rdpv.exe）]"

      ・確認できる情報
            ・プロセスの開始・終了日時：                   ログの日付
            ・プロセスを実行したユーザー名：           サブジェクト -> アカウント名
            ・プロセスを実行したユーザーのドメイン： サブジェクト -> アカウント ドメイン
            ・プロセス実行時の権限昇格の有無：       プロセス情報 -> トークン昇格の種類
            ・プロセスの戻り値：                              プロセス情報 -> 終了状態

イベントID： 4656 （オブジェクトに対するハンドルが要求されました）
      ・プロセス情報内、プロセス名： "[検体（rdpv.exe）]"

イベントログ

-

セキュリティ

      ・確認できる情報
            ・対象ファイル： オブジェクト -> オブジェクト名：("対象検体のファイル名は検体に引数で指定")
            ・ハンドルID：    オブジェクト -> ハンドル ID  ※ 他ログとの紐付けに使用する
            ・処理内容：      アクセス要求情報 -> アクセス （"READ_CONTROL","SYNCHRONIZE","WriteData (または AddFile)","AppendData
                                                       (または AddSubdirectory または CreatePipeInstance)","WriteEA","ReadAttributes","WriteAttributes"）

-

端末

(Windows)

      ・確認できる情報
            ・ハンドルID： オブジェクト -> ハンドル ID  ※ 他ログとの紐付けに使用する
            ・処理内容：   アクセス要求情報 -> アクセス （"WriteData (または AddFile)"、"AppendData (または AddSubdirectory または
                                                                                                                                                                    CreatePipeInstance)")

イベントID： 4663 （オブジェクトへのアクセスが試行されました）

イベントID： 4658 （オブジェクトに対するハンドルが閉じました）

      ・確認できる情報
            ・ハンドルID： オブジェクト -> ハンドル ID

イベントID： 1 （Process Create）
                5 （Process Terminated）
      ・Image： "[検体（rdpv.exe）]"

イベントログ

-

Sysmon

実行履歴

-

Prefetch

      ・確認できる情報
            ・プロセスの開始・終了日時（UTC）： UtcTime
            ・プロセスのコマンドライン：             CommandLine   ※ 使用されたオプションが引数として記録される （イベントID 1に記録される）
            ・実行ユーザー名：                         User
            ・プロセスID：                                 ProcessId

ファイル名： C:\Windows\Prefetch\[実行ファイル（RDPV.EXE）]-[文字列].pf

      ・確認できる情報 (ツールを利用して下記を確認できる ツール：WinPrefetchView)
            ・最終実行日時：                             Last Run Time

<備考>

記載のもの以外で出力される

可能性のあるイベントログ

-

追加
設定

必要

必要

-

37373.4.1. Htran

<基本情報>

ツール

動作条件

ログから

得られる情報

ツール名称

カテゴリ

ツール概要

攻撃時における

想定利用例

権限

対象OS

ドメインへの参加
通信プロトコル

サービス

標準設定

追加設定

実行成功時に確認できる痕跡

Htran
通信の不正中継
TCPセッションを作成し、他ポートの通信をトンネリングさせる
ファイアウォールなどで許可されているポートを経由して、許可されていないポートの通信を通過させる
・接続元： Htran実行元
・接続先： Htranによって接続した端末
標準ユーザー
Windows
不要
任意のTCPポート
-
・接続元： 実行履歴（Prefetch）
・接続先： トンネル経由で実行された通信を使用するアプリケーションに依存する
・接続元： 検体の実行 （プロセス追跡の監査）
             トンネルホスト（攻撃者）・トンネル先ホスト（接続先）との通信有無 （オブジェクトアクセスの監査）
・接続先： トンネル経由で実行された通信を使用するアプリケーションに依存する
・接続元： イベントログに以下のログがある場合、通信した可能性がある
              ・イベントログ「セキュリティ」にイベントID 5156でトンネルホスト・トンネル先ホストとそれぞれ通信したことが記録されている

<確認ポイント>
※ 本資料では「Htranが実行された端末」を「接続元」、「Htranを経由して接続された端末」を「接続先」とする。

通信

ログの生成場所

ログ種別・名称

取得情報の詳細

イベントID： 4688 （新しいプロセスが作成されました）
                4689 （プロセスが終了しました）
      ・プロセス情報 -> プロセス名：   "[検体]"

      ・確認できる情報
            ・プロセスの開始・終了日時 ：                   ログの日付
            ・プロセスを実行したユーザー名 ：            サブジェクト -> アカウント名
            ・プロセスを実行したユーザーのドメイン ：  サブジェクト -> アカウント ドメイン
            ・プロセス実行時の権限昇格の有無 ：       プロセス情報 -> トークン昇格の種類
            ・プロセスの戻り値 ：                               プロセス情報 -> 終了状態

「接続元」ホストから、2箇所に対する通信が発生する

イベントログ

-

セキュリティ

イベントID： 5156 （Windows フィルターリング プラットフォームで、接続が許可されました）
      ・アプリケーション情報 -> アプリケーション名： "[検体]"
      ・ネットワーク情報 -> 方向：                          "送信"
      ・ネットワーク情報 -> 送信元 アドレス：          "[接続元ホストのIPアドレス]"
      ・ネットワーク情報 -> プロトコル：                   "6"（TCP）

      ・確認できる情報
            ・トンネルホスト：                    宛先アドレス
            ・トンネルに利用されたポート： 宛先ポート

イベントID： 5156 （Windows フィルターリング プラットフォームで、接続が許可されました）
      ・アプリケーション情報 -> アプリケーション名： "[検体]"
      ・ネットワーク情報 -> 方向：                          "送信"
      ・ネットワーク情報 -> 送信元 アドレス：          "[接続元ホストのIPアドレス]"
      ・ネットワーク情報 -> プロトコル：                   "6"（TCP）

      ・確認できる情報
            ・トンネルホスト：                    宛先アドレス
            ・トンネルに利用されたポート： 宛先ポート

イベントID： 1 （Process Create）
                5 （Process Terminated）
      ・Image： "[検体]"

接続元

OS：Windows

ユーザー

↓

OS：Windows

ユーザー

イベントログ

-

Sysmon

実行履歴

-

Prefetch

      ・確認できる情報
            ・プロセスの開始・終了日時（UTC） ：     UtcTime
            ・プロセスのコマンドライン ：                  CommandLine
            ・指定時刻、実行プロセス、対象ホスト :  CommandLine  ※ 引数に、トンネルホスト（攻撃者）のIPアドレス及びポート番号
                                                                              トンネル先となるホスト（接続先）のIPアドレス及びポート番号が記録される
            ・実行ユーザ名 ：                                 User
            ・プロセスID ：                                      ProcessId

ファイル名： C:\Windows\Prefetch\[検体]-[文字列].pf

      ・確認できる情報 (ツールを利用して下記を確認できる ツール：WinPrefetchView)
            ・最終実行日時 ：                            Last Run Time

接続先

各種ログ

Htran経由で多く使用されるものとして、リモートデスクトップ（RDP）がある。この場合はトンネル先である「接続先」に、Htranが実行された「接続元」を
接続元IPアドレスとする、宛先ポート 3389/tcp の通信が記録される ※ RDPのログ詳細については、別途RDPの資料を参照

トンネル経由で実行された通信を使用するアプリケーションによって複数のログが記録される可能性がある

<備考>

記載のもの以外で出力される

可能性のあるイベントログ

HTTPプロキシ対応版が使用された場合、プロキシにHTTPS通信が記録される
HTTPSのため、SSLをデコード出来ない場合、CONNECTメソッドのみが記録される

通信の不正中継 > Htran

  凡例
・取得出来る情報
・イベントID・項目名
・フィールド名
・"フィールドの値"

追加
設定

必要

必要

-

必要

38383.4.2. Fake wpad

<基本情報>

ツール

動作条件

ログから

得られる情報

ツール名称

カテゴリ

ツール概要

攻撃時における

想定利用例

参考情報

権限

対象OS

ドメインへの参加
通信プロトコル

サービス

標準設定

追加設定

実行成功時に確認できる痕跡

<確認ポイント>

Fake wpad
通信の不正中継
wpadサーバとして動作し、通信内容を取得・変更する
ユーザーに気付かれないように、攻撃者のサイトを埋め込むよう、レスポンスを改変する
・接続元： 偽装されたwpadファイルを受信する
・接続先： 偽装されたwpadファイルを接続元に送信することで、接続元のプロキシとなる
https://www.jpcert.or.jp/present/2015/20151028_codeblue_ja.pdf
・接続先（wpadサーバ）： 80/tcp及び8888/tcpをlistenする。Windowsファイアウォールで受信を許可するなどの変更が必要なため、管理者権限が必要
・接続元： 標準ユーザー
Windows
不要
80/tcp、8888/tcp
-
・接続元： 最後に取得されたプロキシ設定（レジストリ）が記録される ※ 通常時からwpadを使用している場合は区別出来ない
・接続先： 実行履歴（Prefetch）
・接続元： 検体を実行しているホストに対して、80/tcp及び8888/tcpで通信していることが記録される（オブジェクトアクセスの監査）
             wpad.datのキャッシュが作成されたことが記録される（オブジェクトアクセスの監査）
・接続先： 80/tcp及び8888/tcpをリッスンしたことが記録される（オブジェクトアクセスの監査）
             wpad.datや、プロキシのログであるproxy.logに対するハンドルの要求が記録される（オブジェクトアクセスの監査）
・接続元： 本来プロキシやHTTPサーバーで無いはずのホストと、80/tcp及び8888/tcpによる通信をおこなっている
・接続先： 本来プロキシやHTTPサーバーで無いはずのホストが、80/tcp及び8888/tcpをリッスンしている
             wpad.dat、proxy.logが作成されている

通信

ログの生成場所

ログ種別・名称

取得情報の詳細

wpadを取得する際に、以下が記録される (以下はInternet Explorerの例であるため、他のブラウザでは保存場所や挙動が異なる)
なお、イベントID 4656・4663・4658 は、wpadを使用している場合に記録されるため、wpadを利用している場合は不正なものと区別がつかない

イベントID： 5156 （Windows フィルターリング プラットフォームで、接続が許可されました）
      ・アプリケーション情報 -> アプリケーション名： "\device\harddiskvolume2\program files\internet explorer\iexplore.exe"
      ・ネットワーク情報 -> 方向：                          "送信"
      ・ネットワーク情報 -> 宛先ポート・プロトコル：  "80"・"6"（TCP）

      ・確認できる情報
            ・接続したホスト： ネットワーク情報 -> 宛先アドレス

イベントID： 4656 （オブジェクトへのハンドルが要求されました）
                4663 （オブジェクトへのアクセスが試行されました）
                4658 （オブジェクトに対するハンドルが閉じました）

イベントログ

-

セキュリティ

      ・確認できる情報
            ・対象のファイル： オブジェクト -> オブジェクト名 （"C:\Users\[ユーザー名]\AppData\Local\Microsoft\Windows\Temporary Internet Files
                                                                                                                                                  \Content.IE5\[文字列]\wpad[1].htm"）
            ・ハンドルID：        オブジェクト -> ハンドルID  ※ 他ログとの紐付けに使用する
            ・処理内容：         アクセス要求情報 -> アクセス （"WriteAttributes"・"WriteData (またはAddFile)"・"AppendData (または AddSubdirectory
                                                                                                                                                             または CreatePipeInstance"）
            ・成否：                キーワード （"成功の監査"）

接続元

プロキシが利用されると、以下が記録される
wpad.dat 内で当該ホストをプロキシとして使用しない条件が書かれている場合、宛先アドレスは実際に接続する先のホストとなる

イベントID： 5156 （Windows フィルターリング プラットフォームで、接続が許可されました）
      ・アプリケーション情報 -> アプリケーション名： "\device\harddiskvolume2\program files\internet explorer\iexplore.exe"
      ・ネットワーク情報 -> 方向：                           "送信"
      ・ネットワーク情報 -> 宛先ポート・プロトコル：  "8888"・"6"（TCP）

      ・確認できる情報
            ・プロキシとして利用されたホスト： ネットワーク情報 -> 宛先アドレス

通信の不正中継 > Fake wpad

  凡例
・取得出来る情報
・イベントID・項目名
・フィールド名
・"フィールドの値"

追加
設定

必要

レジストリエントリ： HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Internet Settings\Connections\
                                                                                                                                                                SavedLegacySettings
                           HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Internet Settings\Connections\
                                                                                                                                                       DefaultConnectionSettings

-

アクセス履歴

-

レジストリ

      ・確認できる情報
            ・最後に取得されたプロキシ設定   ※ 通常時からwpadを使用している場合、区別出来ない

OS：Windows

ユーザー

↓

OS：Windows

ユーザー

イベントID： 4688 （新しいプロセスが作成されました）
                 4689 （プロセスが終了しました）
      ・プロセス情報 -> 新しいプロセス名： "[検体（wpad.exe）]"

      ・確認できる情報
            ・プロセスの開始・終了日時 ：                   ログの日付
            ・プロセスを実行したユーザー名 ：            サブジェクト -> アカウント名
            ・プロセスを実行したユーザーのドメイン ：  サブジェクト -> アカウント ドメイン
            ・プロセス実行時の権限昇格の有無 ：       プロセス情報 -> トークン昇格の種類
            ・プロセスの戻り値 ：                               プロセス情報 -> 終了状態

検体が実行された直後に、以下が記録される

イベントID： 5154 （Windowsフィルターリング プラットフォームで、アプリケーションまたはサービスによるポートでの着信接続のリッスンが許可されました）
      ・アプリケーション情報 -> プロセスID：             イベントID 4688で記録されたプロセスID
      ・アプリケーション情報 -> アプリケーション名： "\device\harddiskvolume2\[検体（wpad.exe）]"

接続先

イベントログ

-

セキュリティ

      ・確認できる情報
            ・ リッスンされたポート： ネットワーク情報 -> ソース ポート （"80"・"8888"）
            ・プロトコル：                ネットワーク情報 -> プロトコル （"6" = TCP）

必要

イベントID： 5156 （Windows フィルターリング プラットフォームで、接続が許可されました）
      ・アプリケーション情報 -> プロセスID：                                "4"
      ・アプリケーション情報 -> アプリケーション名：                     "System"
      ・ネットワーク情報 -> 方向：                                              "送信"
      ・ネットワーク情報 -> 送信元アドレス：                                "[検体を実行したホスト]"
      ・ネットワーク情報 -> 宛先ポート・ソース ポート・プロトコル： "137"（宛先・ソース共）・"17"

接続元がwpadを取得する際に、以下が記録される

イベントID： 5156 （Windows フィルターリング プラットフォームで、接続が許可されました）
      ・アプリケーション情報 -> プロセスID：                イベント4688で記録されたプロセスID
      ・アプリケーション情報 -> アプリケーション名：    "\device\harddiskvolume2\[検体（wpad.exe）]"
      ・ネットワーク情報 -> 方向：                              "着信"
      ・ネットワーク情報 -> ソース ポート・プロトコル：  "80"・"6"（TCP）

      ・確認できる情報
            ・接続したホスト： ネットワーク情報 -> 宛先アドレス

3939通信の不正中継 > Fake wpad

通信

ログの生成場所

ログ種別・名称

取得情報の詳細

OS：Windows

ユーザー

↓

OS：Windows

ユーザー

（続）

接続元

（続）

イベントID： 4656 （オブジェクトへのハンドルが要求されました）
                4663 （オブジェクトへのアクセスが試行されました）
                4658 （オブジェクトに対するハンドルが閉じました）
      ・プロセス情報 -> プロセス名： "[検体（wpad.exe）]"

      ・確認できる情報
            ・対象のファイル： オブジェクト -> オブジェクト名 （"[検体のパス]\wpad.dat"）
            ・ハンドルID：       オブジェクト -> ハンドルID  ※ 他ログとの紐付けに使用する
            ・処理内容：         アクセス要求情報 -> アクセス （"SYNCHRONIZE"・"ReadData (またはListDirectory)"・"WriteData (またはAddFile)"・
                             "AppendData (またはAddSubdirectoryまたはCreatePipeInstance)"・"ReadEA"・"WriteEA"・"ReadAttributes"・"WriteAttributes"）
            ・成否：               キーワード （"成功の監査"）

接続元がホストをプロキシとして利用する際に、以下が記録される
ログファイル（proxy.log）が、実行ファイルと同じパスに作成される (ログに対するハンドルは、都度要求され、閉じられる)

イベントID： 5156 （Windows フィルターリング プラットフォームで、接続が許可されました）
      ・アプリケーション情報 -> プロセスID：               イベント4688で記録されたプロセスID
      ・アプリケーション情報 -> アプリケーション名：   "\device\harddiskvolume2\[検体（wpad.exe）]"
      ・ネットワーク情報 -> 方向：                             "着信"
      ・ネットワーク情報 -> ソース ポート・プロトコル： "8888"・"6"（TCP）

イベントログ

-

セキュリティ

      ・確認できる情報
            ・接続したホスト： ネットワーク情報 -> 宛先アドレス

イベントID： 4656 （オブジェクトへのハンドルが要求されました）
                4663 （オブジェクトへのアクセスが試行されました）
                4658 （オブジェクトに対するハンドルが閉じました）
      ・プロセス情報 -> プロセス名： "[検体（wpad.exe）]"

      ・確認できる情報
            ・対象のファイル： オブジェクト -> オブジェクト名 （"[検体のパス]\proxy.log"）
            ・ハンドルID：       オブジェクト -> ハンドルID  ※ 他ログとの紐付けに使用する
            ・処理内容：         アクセス要求情報 -> アクセス （"WriteData (またはAddFile)"）
            ・成否：               キーワード （"成功の監査"）

イベントID： 5156 （Windows フィルターリング プラットフォームで、接続が許可されました）
      ・アプリケーション情報 -> プロセスID：                イベント4688で記録されたプロセスID
      ・アプリケーション情報 -> アプリケーション名：    "\device\harddiskvolume2\[検体（wpad.exe）]"
      ・ネットワーク情報 -> 方向：                              "送信"
      ・ネットワーク情報 -> 送信元アドレス：               "[検体を実行しているホスト]"
      ・ネットワーク情報 -> ソース ポート・プロトコル： "[宛先サーバのポート]（指定が無い場合は80）"・"6"（TCP）

      ・確認できる情報
            ・接続先： ネットワーク情報 -> 宛先アドレス

イベントID： 1 （Process Create）
                5 （Process Terminated）
      ・Image： "[検体（wpad.exe）]"

イベントログ

-

Sysmon

実行履歴
Prefetch

      ・確認できる情報
            ・プロセスの開始・終了日時（UTC）： UtcTime
            ・プロセスのコマンドライン：             CommandLine  ※  iframeなどが使用された場合、引数から読み取ることが可能
            ・実行ユーザ名：                            User
            ・プロセスID：                                 ProcessId

ファイル名： C:\Windows\Prefetch\WPAD.EXE-[文字列].pf

      ・確認できる情報 (ツールを利用して下記を確認できる ツール：WinPrefetchView)
            ・最終実行日時 ：                            Last Run Time

追加
設定

必要

必要

-

<備考>

記載のもの以外で出力される

可能性のあるイベントログ

-

40403.5.1. RDP (Remote Desktop Protocol)

<基本情報>

ツール

動作条件

ツール名称

カテゴリ

ツール概要

攻撃時における

想定利用例

権限

対象OS

ドメインへの参加
通信プロトコル

サービス

ログから

得られる情報

標準設定

追加設定

実行成功時に確認できる痕跡

<確認ポイント>

RDP (Remote Desktop Protocol)
リモートログイン
リモートデスクトップサービスが稼働しているサーバーに接続するためのプロトコル
・ログインされた端末上でファイルを閲覧
・他のサーバ・端末に接続するための情報を収集
・他の機器に接続する踏み台として利用
標準ユーザー
・接続元： Windows
・接続先： リモートデスクトップを有効化したWindows
不要
3389/tcp
・接続先： Remote Desktop Services
・接続先： RDPセッションの接続開始・終了日時
             接続元IPアドレス
             ログインされたユーザー名及びアカウントドメイン
             接続の成否
・接続元： mstsc.exeの実行履歴、ファイルのアクセス履歴
・接続先： イベントログに以下のログがある場合、接続が成功していると考えられる
             ・イベントログ「セキュリティ」にイベントID: 4624が記録されている
             ・イベントログ「Microsoft\Windows\TerminalServices-LocalSessionManager\Operational」にイベントID：21、24が記録されている

通信

ログの生成場所

ログ種別・名称

取得情報の詳細

接続元

OS：Windows

ユーザー

↓

OS：Windows

ユーザー

イベントID： 4688 （新しいプロセスが作成されました）
                 4689 （プロセスが終了しました）
      ・プロセス情報 -> 新しいプロセス名：   "C:\Windows\System32\mstsc.exe

      ・確認できる情報
            ・プロセスの開始・終了日時 ：                ログの日付
            ・プロセスを実行したユーザー名 ：         サブジェクト -> アカウント名
            ・プロセスを実行したユーザのドメイン ：  サブジェクト -> アカウント ドメイン
            ・プロセス実行時の権限昇格の有無 ：    プロセス情報 -> トークン昇格の種類
            ・プロセスの戻り値 ：                            プロセス情報 -> 終了状態

イベントID： 4663 （オブジェクトへのアクセスが試行されました）
                 4656 （オブジェクトへのハンドルが要求されました）
                 4658 （オブジェクトに対するハンドルが閉じました）
      ・プロセス情報 -> プロセス名： "C:\Windows\System32\mstsc.exe"

      ・確認できる情報
            ・対象のファイル ：                                        オブジェクト -> オブジェクト名 （例："C:\Users\[ユーザー名]\Documents\Default.rdp"）
            ・ハンドルID（他ログとの紐付けに使用する） ：  オブジェクト -> ハンドルID
            ・処理内容 ：                                               アクセス要求情報 -> アクセス （"WriteData (またはAddFile)"
                                                                                                                        "AppendData (またはAddSubdirectoryまたは
            ・成否 ：                                                     キーワード （"成功の監査"）

イベントID： 1 （Process Create）
                 5 （Process Terminated）
      ・Image： "C:\Windows\System32\mstsc.exe"

      ・確認できる情報
            ・プロセスの開始・終了日時（UTC）：   UtcTime
            ・プロセスのコマンドライン：               CommandLine
            ・実行ユーザー名：                          User
            ・プロセスID：                                  ProcessId

ファイル名： C:\Windows\Prefetch\MSTSC.EXE-76A46E8A.pf

      ・確認できる情報 (ツールを利用して下記を確認できる ツール：WinPrefetchView)
            ・最終実行日時：                             Last Run Time

レジストリエントリ： HKEY_USERS\[SID]\Software\Microsoft\Terminal Server Client\Default\

     ・確認できる情報
            ・リモートデスクトップの接続履歴：    値の名前 ="MRU0"～"MRU9"
                                                                  ※ 上記の値のデータとして、過去に接続したIPアドレスが記録される
                                                                       MRU0が最後に接続した履歴
                                                                       キーの最終書き込み時刻は、"MRU0"の値のデータが更新された日時(接続履歴にない接続先に
                                                                       対して初めて接続した時間)が記録される

レジストリエントリ： HKEY_USERS\[SID]\Software\Microsoft\Terminal Server Client\Servers\[接続先IPアドレス]\

     ・確認できる情報
          ・最後にアクセスしたアカウントドメイン及びユーザー名:   値の名前 = "UsernameHint"
                                                                                            ※ 値のデータとして、過去に接続したIPアドレスごとに最後にアクセスした
                                                                                                アカウントドメイン及びユーザー名が記録される

イベントID： 4624 （アカウントが正常にログオンしました）
      ・ログオン タイプ： "10"
      ・ネットワーク情報 -> ソース ネットワーク アドレス： イベント5156における、宛先アドレス
      ・ネットワーク情報 -> ソース ポート： イベント5156に記録された、宛先ポート
      ・詳細な認証情報 -> ログオン プロセス： "Kerberos"

      ・確認できる情報
            ・接続元ホスト：                                            ネットワーク情報 -> ソース ネットワークアドレス
            ・使用されたユーザー：                                  新しいログオン -> アカウント名・アカウント ドメイン
            ・新しいログオンID（他ログとの紐付けに使用）：  新しいログオン -> ログオンID

イベントログ

-

セキュリティ

実行履歴

-

Sysmon

実行履歴

-

Prefetch

アクセス履歴

-

レジストリ

アクセス履歴

-

監査ポリシー

接続先

イベントID:21 (リモートデスクトップ セッション ログオン成功)

イベントログ

-

アプリケーションと

サービス ログ

\Microsoft\Windows
\TerminalServices-
LocalSessionManager

\Operational

      ・確認できる情報
            ・セッションの接続開始日時：                                ログの日付
            ・ログインされたアカウントドメイン及びユーザー名：  ユーザー
            ・接続元IPアドレス：                                             ソースネットワークアドレス

イベントID:24 (リモートデスクトップ セッション 切断)

      ・確認できる情報
            ・セッションの接続開始日時：                                イベントID:21のセッションIDが同じイベントログのログの日付
            ・ログインされたアカウントドメイン及びユーザー名：  ユーザー
            ・接続元IPアドレス：                                             ソースネットワークアドレス

<備考>

記載のもの以外で出力される

可能性のあるイベントログ

接続先のイベントログ「セキュリティ」には環境によって下記のログが出力される可能性がある
イベントID： 4624 （アカウントが正常にログオンしました）
    ・ログオン タイプ："12"

リモートログイン > RDP

  凡例
・取得出来る情報
・イベントID・項目名
・フィールド名
・"フィールドの値"

追加
設定

必要

必要

-

-

必要

-

41413.6.1. WCE (リモートログイン)

<基本情報>

ツール

動作条件

ログから

得られる情報

ツール名称

カテゴリ

ツール概要

攻撃時における

想定利用例

権限

対象OS

ドメインへの参加
通信プロトコル

サービス

標準設定

追加設定

実行成功時に確認できる痕跡

<確認ポイント>

WCE (リモートログイン)
pass-the-hash, pass-the-ticket
取得したパスワードのハッシュを利用し、上位権限でコマンドを実行する
ADに所属する管理者ユーザ権限のハッシュを利用し、他端末にリモートでコマンド実行を行う
・接続元： WCE実行元
・接続先： WCEによってログインされた先
ローカルの管理者ユーザー
Windows
不要
ランダムな5桁のポート（WMIC）
-
・接続元： 実行履歴（Prefetch）
             WCESERVICEがインストールされ、実行されていることの記録
・両側：     WMIの実行履歴、及びWindowsフィルターリングプラットフォームのログ
・接続先： リモートからログインが発生していること
・接続元： WCESERVICEがインストール・実行されたことが記録されている
・接続先： リモートホストからログオンしたことが記録されている
・両側：     WMIを用いて通信したことが記録されている

通信

ログの生成場所

ログ種別・名称

取得情報の詳細

イベントID： 4656 （オブジェクトへのハンドルが要求されました）
                4663 （オブジェクトへのアクセスが試行されました）
                4658 （オブジェクトに対するハンドルが閉じました）
      ・オブジェクト -> オブジェクト名：                     "(C:\Windows\Temp\wceaux.dll)"
      ・アクセス要求情報 -> アクセス・アクセス理由： ("WriteData (またはAddFile)"）

      ・確認できる情報
            ・プロセス名： "[検体 （wce.exe）]"
            ・ハンドルID： オブジェクト -> ハンドルID

イベントID： 4656 （オブジェクトへのハンドルが要求されました）
                4660 （オブジェクトが削除されました）
                4658 （オブジェクトに対するハンドルが閉じました）
      ・オブジェクト -> オブジェクト名：                     "(C:\Windows\Temp\wceaux.dll)"
      ・アクセス要求情報 -> アクセス・アクセス理由： ("DELETE")

      ・確認できる情報
            ・プロセス名： "[検体 （wce.exe）]"
            ・ハンドルID： オブジェクト -> ハンドルID

イベントログ

-

セキュリティ

イベント4656・4663・4658の処理を、複数ファイルに対しておこなう

イベントID： 4656 （オブジェクトへのハンドルが要求されました）
                4663 （オブジェクトへのアクセスが試行されました）
                4658 （オブジェクトに対するハンドルが閉じました）
      ・オブジェクト -> オブジェクト名：                      "(C:\Users\[ユーザー名]\AppData\Local\Microsoft\Windows\
                                                                                                                                  Temporary Internet Files\Content.IE5）"
      ・アクセス要求情報 -> アクセス・アクセス理由： ("SYNCHRONIZE"、"WriteAttributes"、"WriteData (またはAddFile)")
      ・プロセス情報 -> プロセス名：                         "C:\Windows\System32\wbem\WMIC.exe"

      ・確認できる情報
            ・ハンドルID： オブジェクト -> ハンドルID  ※ 他のログとの紐付けに使用する

イベントID： 5156 （Windows フィルターリング プラットフォームで、接続が許可されました）
      ・アプリケーション情報 -> アプリケーション名：   ("C:\Windows\System32\wbem\WMIC.exe")
      ・ネットワーク情報 -> 方向：                              "送信"

      ・確認できる情報
            ・接続先ホスト： 宛先アドレス
            ・接続先ポート： 宛先ポート

イベントID： 7045 （サービスがシステムにインストールされました）
      ・サービス名： "WCESERVICE"

      ・確認できる情報
            ・プロセスの開始日時： ログの日付
            ・サービス ファイル名： "[検体 （wce.exe）] -S"

イベントID： 7036
      ・詳細タブ -> System\Provider\Name： "Service Control Manager"
      ・詳細タブ -> EventData\param1：         "WCESERVICE"

      ・確認できる情報
            ・サービスの実行： 詳細タブ -> EventData\param2 （"実行中" ）・（"停止"）

OS：Windows

管理者ユーザー

↓

OS：Windows

管理者ユーザー

接続元

(Windows)

イベントログ

-

システム

イベントID： 1 （Process Create）
                5 （Process Terminated）
      ・Image： "[検体 （wce.exe）]"
      ・Image： "C:\Windows\System32\wbem\WMIC.exe"

      ・確認できる情報
            ・プロセスの開始・終了日時（UTC） ：     UtcTime
            ・プロセスのコマンドライン ：                  CommandLine
            ・実行ユーザ名 ：                                 User
            ・プロセスID ：                                      ProcessId

イベントログ

-

Sysmon

イベントID： 8 （CreateRemoteThread detected）
      ・SourceImage："[検体 （wce.exe）]"
      ・TargetImage： ("C:\Windows\System32\lsass.exe")

      ・確認できる情報
            ・プロセスの開始日時（UTC）： UtcTime

イベントID： 9 （RawAccessRead detected）
      ・Image： "C:\Windows\System32\cmd.exe"

      ・確認できる情報
            ・プロセスの開始日時（UTC）： UtcTime
            ・アクセス先：                          Device

実行履歴

-

レジストリ

ファイル名： C:\Windows\Prefetch\[検体（WCE.EXE）]-[文字列].pf
                  C:\Windows\Prefetch\WMIC.EXE-A7D06383.pf

      ・確認できる情報 (ツールを利用して下記を確認できる ツール：WinPrefetchView)
            ・最終実行日時 ：                            Last Run Time

pass-the-hash, pass-the-ticket > WCE (リモートログイン)

  凡例
・取得出来る情報
・イベントID・項目名
・フィールド名
・"フィールドの値"

追加
設定

必要

-

必要

-

4242pass-the-hash, pass-the-ticket > WCE (リモートログイン)

通信

ログの生成場所

ログ種別・名称

取得情報の詳細

イベントID： 5156 （Windows フィルターリング プラットフォームで、接続が許可されました）
      ・アプリケーション情報 -> アプリケーション名：   ("\device\harddiskvolume2\windows\system32\svchost.exe")
      ・ネットワーク情報 -> 方向：                              "受信"

OS：Windows

管理者ユーザー

↓

OS：Windows

管理者ユーザー

（続）

接続先

(Windows)

      ・確認できる情報
            ・接続元ホスト： 宛先アドレス
            ・接続元ポート： 宛先ポート

イベントID： 4624 （アカウントが正常にログオンしました）
                 4634 （アカウントがログオフしました）

イベントログ

-

セキュリティ

      ・確認できる情報
            ・プロセスの開始日時： ログの日付
            ・接続元アカウント名： 新しいログオン -> アカウント名・ドメイン名
            ・接続元：                   ネットワーク情報 -> ソース ネットワーク アドレス

イベントID： 4688 （新しいプロセスが作成されました）
                4689 （プロセスが終了しました）
      ・プロセス情報 -> プロセス名：   "C:\Windows\System32\wbem\WmiPrvSE.exe"

      ・確認できる情報
            ・プロセスの開始・終了日時 ：                   ログの日付
            ・プロセスを実行したユーザー名 ：            サブジェクト -> アカウント名
            ・プロセスを実行したユーザーのドメイン ：  サブジェクト -> アカウント ドメイン
            ・プロセス実行時の権限昇格の有無 ：       プロセス情報 -> トークン昇格の種類
            ・プロセスの戻り値 ：                               プロセス情報 -> 終了状態
            ・親プロセス ID：                                      プロセス情報 -> クリエーター プロセス ID

イベントログ

-

Sysmon

イベントID： 1 （Process Create）
                5 （Process Terminated）
      ・Image： "C:\Windows\System32\wbem\WmiPrvSE.exe"

      ・確認できる情報
            ・プロセスの開始・終了日時（UTC） ：     UtcTime
            ・プロセスのコマンドライン ：                  CommandLine
            ・実行ユーザ名 ：                                 User
            ・プロセスID ：                                      ProcessId

イベントID： 9 （RawAccessRead detected）
      ・Image： "C:\Windows\System32\wbem\WmiPrvSE.exe"

      ・確認できる情報
            ・プロセスの開始日時（UTC）： UtcTime
            ・アクセス先：                          Device

実行履歴

-

Prefetch

ファイル名： C:\Windows\Prefetch\WMIPRVSE.EXE-1628051C.pf

      ・確認できる情報 (ツールを利用して下記を確認できる ツール：WinPrefetchView)
            ・最終実行日時 ：                            Last Run Time

<備考>

記載のもの以外で出力される

可能性のあるイベントログ

-

追加
設定

必要

必要

-

4343pass-the-hash, pass-the-ticket > Mimikatz (リモートログイン)

 凡例
・取得出来る情報
・イベントID・項目名
・フィールド名
・"フィールドの値"

3.6.2. Mimikatz (リモートログイン)

<基本情報>

ツール

動作条件

ログから

得られる情報

ツール名称

カテゴリ

ツール概要

攻撃時における

想定利用例

権限

対象OS

ドメインへの参加
通信プロトコル

サービス
標準設定

追加設定

実行成功時に確認できる痕跡

<確認ポイント>

Mimikatz (リモートログイン)
pass-the-hash, pass-the-ticket
取得したパスワードのハッシュを利用し、他ユーザーの権限でコマンドを実行する
管理者ユーザー権限のハッシュを利用し、他端末にリモートでコマンド実行を行う
・接続元： Mimikatz実行元
・接続先： Mimikatzによってログインされた先
接続元： 管理者ユーザー
接続先： ハッシュを利用されたユーザーの権限
Windows
不要
ランダムな5桁のポート（WMIC）
Windows Management Instrumentation
・実行履歴（Prefetch）
・リモート接続時の通信の発生ログ
・接続が発生した過程のログ
・接続先： イベントログに以下のログがある場合、リモートからログインされていると考えられる

・イベントログ「セキュリティ」にイベントID 4624が記録され、意図しない接続元からアクセスされている

通信

ログの生成場所

ログ種別・名称

取得情報の詳細

イベントID： 4688 （新しいプロセスが作成されました）

 4689 （プロセスが終了しました）

・プロセス情報 -> プロセス名：   "[検体（mimikatz.exe）]"

 "C:\Windows\System32\cmd.exe"
 "C:\Windows\System32\wbem\WMIC.exe"

・確認できる情報

・プロセスの開始・終了日時 ：
・プロセスを実行したユーザー名 ：
・プロセスを実行したユーザーのドメイン ：  サブジェクト -> アカウント ドメイン
・プロセス実行時の権限昇格の有無 ：
・プロセスの戻り値 ：

 プロセス情報 -> トークン昇格の種類
  プロセス情報 -> 終了状態

ログの日付
サブジェクト -> アカウント名

イベントログ

イベントID： 5156 （Windows フィルターリング プラットフォームで、接続が許可されました）

-

セキュリティ

・アプリケーション情報 -> アプリケーション名： "C:\Windows\System32\wbem\WMIC.exe"
・ネットワーク情報 -> 方向：

 "送信"

・確認できる情報

・接続元ポート： ソース ポート
・接続先ホスト： 宛先アドレス
・接続先ポート： 宛先ポート （5桁のポートとなる）

接続元

イベントID： 4648 （明示的な資格情報を使用してログオンが試行されました）

・プロセス情報 -> プロセス名： "C:\Windows\System32\wbem\WMIC.exe"

・確認できる情報

追加
設定

必要

必要

-

必要

必要

-

・プロセスの開始日時：
・接続先端末においてプロセスを実行したアカウント名： 資格情報が使用されたアカウント -> アカウント名・ドメイン名
・接続先：

 ターゲット サーバー -> ターゲット サーバー名

ログの日付

OS：Windows

管理者ユーザー

↓

OS：Windows

ユーザー

イベントID： 1 （Process Create）

 5 （Process Terminated）

・Image： "C:\Windows\System32\at.exe"

 "C:\Windows\System32\cmd.exe"
 "C:\Windows\System32\wbem\WMIC.exe"

・確認できる情報

・プロセスの開始・終了日時（UTC） ：
・プロセスのコマンドライン ：
・実行ユーザ名 ：
・プロセスID ：

 UtcTime
 CommandLine
 User
  ProcessId

ファイル名： C:\Windows\Prefetch\CMD.EXE-4A81B364.pf

 C:\Windows\Prefetch\[検体（MIMIKATZ.EXE）]-[文字列].pf
 C:\Windows\Prefetch\WMIC.EXE-A7D06383.pf

・確認できる情報 (ツールを利用して下記を確認できる ツール：WinPrefetchView)

・最終実行日時 ：

 Last Run Time

イベントID： 4624 （アカウントが正常にログオンしました）

・ログオン タイプ： "3"

・確認できる情報

・プロセスの開始日時： ログの日付
・接続元アカウント名：  新しいログオン -> アカウント名・ドメイン名
・接続元：

 ネットワーク情報 -> ソース ネットワーク アドレス

イベントログ

-

Sysmon

実行履歴

-

レジストリ

イベントログ

-

セキュリティ

イベントID： 5156 （Windows フィルターリング プラットフォームで、接続が許可されました）

・アプリケーション情報 -> アプリケーション名： "\device\harddiskvolume2\windows\system32\svchost.exe"
・ネットワーク情報 -> 方向：

 "受信"

接続先

・確認できる情報

・接続元ホスト： 宛先アドレス
・接続元ポート： 宛先ポート   ※ 接続元ホストにおけるソース ポートと一致する
・接続先ポート： ソース ポート   ※ 接続元ホストにおける宛先ポートと一致する

イベントログ

-

Sysmon

実行履歴

-

レジストリ

イベントID： 1 （Process Create）

・Image： "C:\Windows\System32\wbem\WmiPrvSE.exe"

・確認できる情報

・プロセスの開始日時（UTC）： UtcTime
・プロセスID：

 ProcessId

ファイル名： C:\Windows\Prefetch\WMIPRVSE.EXE-1628051C.pf

・確認できる情報 (ツールを利用して下記を確認できる ツール：WinPrefetchView)

・最終実行日時 ：

 Last Run Time

<備考>

記載のもの以外で出力される

可能性のあるイベントログ

-

44443.7.1. MS14-058 Exploit

ツール名称

カテゴリ

ツール概要

MS14-058 Exploit
SYSTEM権限に昇格
指定したコマンドを、SYSTEM権限で実行する

<基本情報>

ツール

動作条件

ログから

得られる情報

実行成功時に確認できる痕跡

<確認ポイント>

攻撃時における

想定利用例

権限

対象OS

ドメインへの参加
通信プロトコル

サービス
標準設定
追加設定

本来管理者権限が必要なコマンドを、標準権限しか持たないユーザーで実行する

標準ユーザー
Windows
不要
-
-
・実行履歴（Prefetch）
・検体、及び検体によりSYSTEM権限で実行されたプロセスのプロセス名・引数 （Sysmon・プロセス追跡の監査）
イベントログに以下のログがある場合、権限昇格が成功していると考えられる

・イベント: 4688においてSYSTEM権限で実行されているプロセスにおいて、親プロセスが検体やそのプロセスの親となり得ないものとなっている

通信

ログの生成場所

ログ種別・名称

取得情報の詳細

イベントID： 4688 （新しいプロセスが作成されました）

 4689 （プロセスが終了しました）

・プロセス情報 -> プロセス名：   "[検体]"

・確認できる情報

イベントログ

-

セキュリティ

・プロセスの開始・終了日時 ：
・プロセスを実行したユーザー名 ：
・プロセスを実行したユーザのドメイン ：  サブジェクト -> アカウント ドメイン
・プロセス実行時の権限昇格の有無 ：    プロセス情報 -> トークン昇格の種類
・プロセスの戻り値 ：

ログの日付
サブジェクト -> アカウント名

 プロセス情報 -> 終了状態

イベントID： 4688 （新しいプロセスが作成されました）

 4689 （プロセスが終了しました）

・プロセス情報 -> 新しいプロセス名：   "[SYSTEM権限で実行されたプロセス]"

・確認できる情報

・プロセスの開始・終了日時 ：
・プロセスを実行したユーザー名 ：
・プロセスを実行したユーザのドメイン ：  サブジェクト -> アカウント ドメイン
・プロセス実行時の権限昇格の有無 ：    プロセス情報 -> トークン昇格の種類
・プロセスの戻り値 ：

ログの日付
サブジェクト -> アカウント名 （"[コンピュータ名]$"）

 プロセス情報 -> 終了状態

-

端末

(Windows)

イベントID： 1 （Process Create）

 5 （Process Terminated）

・Image： "[検体]"

・確認できる情報

・プロセスの開始・終了日時（UTC）：   UtcTime
・プロセスのコマンドライン：
・実行ユーザー名：
・プロセスID：

 CommandLine   ※ SYSTEM権限で実行されたコマンドが、引数に記録される
 User
 ProcessId

イベントログ

-

Sysmon

イベントID： 1 （Process Create）

 5 （Process Terminated）

・Image： "[SYSTEM権限で実行されたプロセス]"

・確認できる情報

・プロセスの開始日時（UTC）：
・プロセスのコマンドライン：
・実行ユーザー名：
・プロセスID：
・親プロセス名：
・親プロセスに指定されたコマンドライン： ParentCommandLine

 UtcTime
 CommandLine   ※ コマンドに対する引数が記録される
 User （"NT AUTHORITY\SYSTEM"）
 ProcessId
 ParentImage （"[検体]"）

実行履歴

-

Prefetch

ファイル名： C:\Windows\Prefetch\[検体]-[文字列].pf

・確認できる情報 (ツールを利用して下記を確認できる ツール：WinPrefetchView)

・最終実行日時：

 Last Run Time

<備考>

記載のもの以外で出力される

可能性のあるイベントログ

SYSTEM権限で実行されたプロセスに関連する、他のログが出力される可能性がある

SYSTEM権限に昇格 > MS14-058 Exploit

 凡例
・取得出来る情報
・イベントID・項目名
・フィールド名
・"フィールドの値"

追加
設定

必要

必要

-

45453.7.2. MS15-078 Exploit

ツール名称

カテゴリ

ツール概要

MS15-078 Exploit
SYSTEM権限に昇格
指定したコマンドを、SYSTEM権限で実行する

<基本情報>

ツール

動作条件

ログから

得られる情報

実行成功時に確認できる痕跡

<確認ポイント>

攻撃時における

想定利用例

権限

対象OS

ドメインへの参加
通信プロトコル

サービス
標準設定
追加設定

本来管理者権限が必要なコマンドを、標準権限しか持たないユーザーで実行する

標準ユーザー
Windows 7・8・2008
本検証環境では、Windows Server 2012では実行不可
不要
-
-
・実行履歴（Prefetch）
・検体、及び検体によりSYSTEM権限で実行されたプロセスのプロセス名・引数 （Sysmon・プロセス追跡の監査）
イベントログに以下のログがある場合、権限昇格が成功していると考えられる

・イベント: 4688においてSYSTEM権限で実行されているプロセスにおいて、親プロセスが検体やそのプロセスの親となり得ないものとなっている

通信

ログの生成場所

ログ種別・名称

取得情報の詳細

イベントID： 4688 （新しいプロセスが作成されました）

 4689 （プロセスが終了しました）

・プロセス情報 -> 新しいプロセス名：   "[検体]"

・確認できる情報

イベントログ

-

セキュリティ

・プロセスの開始・終了日時 ：
・プロセスを実行したユーザー名 ：
・プロセスを実行したユーザのドメイン ：  サブジェクト -> アカウント ドメイン
・プロセス実行時の権限昇格の有無 ：    プロセス情報 -> トークン昇格の種類
・プロセスの戻り値 ：

ログの日付
サブジェクト -> アカウント名

 プロセス情報 -> 終了状態

イベントID： 4688 （新しいプロセスが作成されました）

 4689 （プロセスが終了しました）

・プロセス情報 -> 新しいプロセス名：   "[SYSTEM権限で実行されたプロセス]"

・確認できる情報

・プロセスの開始・終了日時 ：
・プロセスを実行したユーザー名 ：
・プロセスを実行したユーザのドメイン ：  サブジェクト -> アカウント ドメイン
・プロセス実行時の権限昇格の有無 ：    プロセス情報 -> トークン昇格の種類
・プロセスの戻り値 ：

ログの日付
サブジェクト -> アカウント名 （"[コンピュータ名]$"）

 プロセス情報 -> 終了状態

-

端末

(Windows)

イベントID： 1 （Process Create）

 5 （Process Terminated）

・Image： "[検体]"

・確認できる情報

・プロセスの開始・終了日時（UTC）：   UtcTime
・プロセスのコマンドライン：
・実行ユーザー名：
・プロセスID：

 CommandLine   ※ SYSTEM権限で実行されたコマンドが、引数に記録される
 User
 ProcessId

イベントログ

-

Sysmon

イベントID： 1 （Process Create）

 5 （Process Terminated）

・Image： "[SYSTEM権限で実行されたプロセス]"

・確認できる情報

・プロセスの開始日時（UTC）：
・プロセスのコマンドライン：
・実行ユーザー名：
・プロセスID：
・親プロセス名：
・親プロセスに指定されたコマンドライン： ParentCommandLine

 UtcTime
 CommandLine   ※ コマンドに対する引数が記録される
 User （"NT AUTHORITY\SYSTEM"）
 ProcessId
 ParentImage （"[検体]"）

実行履歴

-

Prefetch

ファイル名： C:\Windows\Prefetch\[検体]-[文字列].pf

・確認できる情報 (ツールを利用して下記を確認できる ツール：WinPrefetchView)

・最終実行日時：

 Last Run Time

<備考>

記載のもの以外で出力される

可能性のあるイベントログ

SYSTEM権限で実行されたプロセスに関連する、他のログが出力される可能性がある

SYSTEM権限に昇格 > MS15-078 Exploit

 凡例
・取得出来る情報
・イベントID・項目名
・フィールド名
・"フィールドの値"

追加
設定

必要

必要

-

46463.8.1. SDB UAC Bypass

<基本情報>

ツール

動作条件

ログから

得られる情報

ツール名称

カテゴリ

ツール概要

攻撃時における

想定利用例

参考情報

権限

対象OS

ドメインへの参加
通信プロトコル

サービス
標準設定

追加設定

実行成功時に確認できる痕跡

<確認ポイント>

SDB UAC Bypass
権限昇格
アプリケーション互換データベース（SDB）を用いて、本来UACにより制御されるアプリケーションを管理者権限で実行する
通常のアプリケーションを実行するように見せかけて、他のアプリケーションを実行させる
この際、本来は管理者権限が必要なアプリケーションを、ユーザーによる承諾を経ることなく実行できる
https://www.jpcert.or.jp/magazine/acreport-uac-bypass.html
管理者パスワードを入力することなく、UACにより管理者権限を利用することが可能な権限を持つユーザー
（クライアント端末における、Administratorsグループに所属するユーザ-）
Windows
不要
-
-
・実行履歴（Prefetch）
・実行履歴（Sysmon・監査ポリシー）
      ・親プロセス名に、本来は親プロセスとならないことが想定されるアプリケーションを含む、プロセスが開始される
      ・「回避に使用するアプリケーション」及び「回避実行されたアプリケーション」が記録される
・親プロセス名に、本来は親プロセスとならないことが想定されるアプリケーションを含む、プロセスが実行されたことが記録されている

通信

ログの生成場所

ログ種別・名称

取得情報の詳細

SDBファイルがインストールされる際、以下が記録される

イベントID： 4688 （新しいプロセスが作成されました）
                4689 （プロセスが終了しました）
      ・プロセス情報 -> プロセス名：   "C:\Windows\System32\sdbinst.exe"

      ・確認できる情報
            ・プロセスの開始・終了日時 ：                   ログの日付
            ・プロセスを実行したユーザー名 ：            サブジェクト -> アカウント名
            ・プロセスを実行したユーザーのドメイン ：  サブジェクト -> アカウント ドメイン
            ・プロセス実行時の権限昇格の有無 ：       プロセス情報 -> トークン昇格の種類
            ・プロセスの戻り値 ：                               プロセス情報 -> 終了状態

イベントID： 4656 （オブジェクトへのハンドルが要求されました）
                4663 （オブジェクトへのアクセスが試行されました）
                4658 （オブジェクトに対するハンドルが閉じました）
      ・プロセス情報 -> プロセス名： "C:\Windows\System32\sdbinst.exe"

      ・確認できる情報
            ・SDBファイル：                                          オブジェクト -> オブジェクト名 （"C:\Windows\AppPatch\Custom\{[GUID]}.sdb"）
            ・ハンドルID：                                             オブジェクト -> ハンドルID   ※ 他ログとの紐付けに使用する
            ・ハンドルを要求したプロセスのプロセスID：   プロセス情報 -> プロセスID （イベント4688で作成されたプロセスのIDと一致する）
            ・処理内容：                                              アクセス要求情報 -> アクセス・アクセス理由 （"WriteData (または AddFile)"・
                                                                                                      "AppendData (または AddSubdirectoryまたは CreatePipeInstance"）
            ・成否：                                                    キーワード （"成功の監査"）

イベントログ

-

セキュリティ

回避実行がされた場合、以下が記録される

イベントID： 4688 （新しいプロセスが作成されました）
                4689 （プロセスが終了しました）
      ・プロセス情報 -> プロセス名：   "[回避実行されたコマンド]"

      ・確認できる情報
            ・プロセスの開始・終了日時：                   ログの日付
            ・プロセスを実行したユーザー名：           サブジェクト -> アカウント名
            ・プロセスを実行したユーザーのドメイン： サブジェクト -> アカウント ドメイン
            ・プロセス実行時の権限昇格の有無：       プロセス情報 -> トークン昇格の種類
            ・このアプリケーションを実行した、回避用に使用されたアプリケーションのプロセスID： プロセス情報 -> クリエーター プロセスID
                                                                                                                     「回避に使用されるアプリケーション」のプロセスIDと一致する。
            ・プロセスの戻り値：                              プロセス情報 -> 終了状態
                                               成功の場合は"0x0"となる。失敗の場合、エラーに応じて異なる値が入る。コマンドプロンプト上で実行するものなど、
                                               回避に使用されるアプリケーションによっては、通常通りに実行しただけでは戻り値が"0x0"とならない可能性がある
                                               ため、場合によっては判断材料とすることが可能。

※ 「回避実行されたアプリケーション」は必ず「回避に使用されるアプリケーション」より後に開始されるが、終了については呼び出し方に応じて、前後関係
    が入れ替わる可能性がある。

-

端末

(Windows)

SDBファイルがインストールされる際、以下が記録される

イベントID： 1 （Process Create）
                5 （Process Terminated）
      ・Image： "C:\Windows\System32\sdbinst.exe"

      ・確認できる情報
            ・プロセスの開始・終了日時（UTC） ：    UtcTime
            ・プロセスのコマンドライン ：                CommandLine
            ・利用されたSDBファイル ：               CommandLine
            ・実行ユーザ名 ：                               User
            ・プロセスID ：                                    ProcessId

イベントログ

回避実行がされた場合、以下が記録される

-

Sysmon

イベントID： 1 （Process Create）
                5 （Process Terminated）
      ・Image： "[回避実行されたコマンド]"

      ・確認できる情報
            ・プロセスの開始日時（UTC）： UtcTime
            ・プロセスのコマンドライン：     CommandLine
            ・実行ユーザ名：                    User
            ・プロセスID：                        ProcessId
            ・親プロセス名：                     ParentImage ※ SDB内で指定されているアプリケーション
                                                                              本来は本プロセスの親とならないことが想定されるアプリケーションが、本プロセスの親となる
            ・親プロセスID：                     ParentProcessId  ※ 先に実行された、「SDB内で指定されているアプリケーション」のプロセスIDと一致する

※ このプロセスがバッチなどのスクリプト系ファイルであった場合、このプロセスが親プロセスとなって更に子プロセスが実行される
    順番にプロセスIDを追跡することで、実行されたアプリケーションのプロセスツリーを確認することが可能

アプリケーションと

サービス ログ

\Microsoft\Windows

\Application-

Experience

\Program-Telemetry

イベントID： 500 （互換性修正プログラムが適用されています）

      ・確認できる情報
            ・適用されたプログラム： 詳細タブ -> UserData\CompatibilityFixEvent\ExePath
            ・修正プログラム：          詳細タブ -> UserData\CompatibilityFixEvent\FixName

権限昇格 > SDB UAC Bypass

  凡例
・取得出来る情報
・イベントID・項目名
・フィールド名
・"フィールドの値"

追加
設定

必要

必要

-

4747通信

ログの生成場所

ログ種別・名称

取得情報の詳細

-

（続）

端末

(Windows)

（続）

実行履歴

-

Prefetch

実行履歴

-

レジストリ

ファイル名： C:\Windows\Prefetch\SDBINST.EXE-5CC2F88B.pf

・確認できる情報 (ツールを利用して下記を確認できる ツール：WinPrefetchView)

・最終実行日時 ：

 Last Run Time

・備考

・上記の他に、回避に使用されたアプリケーション、及び実行されたアプリケーションにおける最終実行日時が変化する

レジストリエントリ: HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall\{[GUID]}.sdb

・確認できる情報

・SDBの内容：  DisplayName （回避に使用されるアプリケーション名が入る）
・削除コマンド： UninstallString （"%windir%\system32\sdbinst.exe -u "C:\Windows\AppPatch\Custom\{[GUID]}.sdb"）

レジストリエントリ: HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\AppCompatFlags\Custom\

  {[UAC回避に使用されるアプリケーション名]}

・確認できる情報

・SDBをインストールしたタイムスタンプ： DatabaseInstallTimeStamp （16進数の値となる）

レジストリエントリ: HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\AppCompatFlags\InstalledSDB\{[GUID]}

・確認できる情報

・SDBファイルのパス：
・SDBの種類：
・SDBの内容：
・SDBをインストールしたタイムスタンプ： DatabaseInstallTimeStamp （16進数の値。上記 "Custom"配下の値と同じ）

 DatabasePath （"C:\Windows\AppPatch\Custom\{[GUID]}.sdb"）
 DatabaseType
 DatabaseDescription （回避に使用されるアプリケーション名が入る）

・備考

・上記レジストリの値は、SDBファイルをアンインストールすると削除されるため、必ずしも残存するとは限らない
・痕跡削除として、SDBファイルをアンインストールする検体が確認されている

<備考>

記載のもの以外で出力される

可能性のあるイベントログ

・上記以外に、「回避に使用されるアプリケーション」及び「回避実行されたアプリケーション」によるログが記録される可能性がある

権限昇格 > SDB UAC Bypass

追加
設定

-

-

4848ドメイン管理者権限、アカウントの奪取 > MS14-068 Exploit

 凡例
・取得出来る情報
・イベントID・項目名
・フィールド名
・"フィールドの値"

追加
設定

必要

3.9.1. MS14-068 Exploit

<基本情報>

ツール

動作条件

ログから

得られる情報

ツール名称

カテゴリ

ツール概要

攻撃時における

想定利用例

権限

対象OS

ドメインへの参加
通信プロトコル

サービス
標準設定

追加設定

実行成功時に確認できる痕跡

<確認ポイント>

MS14-068 Exploit
ドメイン管理者権限、アカウントの奪取
ドメインユーザーの権限を、他のユーザーに変更する
入手したドメインユーザのアカウントを用いて、管理者になりすまし、権限が必要な操作をおこなう
(検証では、Exploitを使用してアカウントのTGTチケットを入手し、mimikatzを利用してリモートログインしている)
・接続元： Exploit実行元
・接続先： 取得されたチケットによってリモートログインされた端末
標準ユーザー
Windows
要
88/tcp, 445/tcp
Active Directory Domain Services
・接続元： 実行履歴（Prefetch）
・接続元： 実行履歴（Sysmon・監査ポリシー）
・接続先： 本来の権限以上の特権が、他のアカウントに対して認可されていること（監査ポリシー）
・接続先： イベントログ「セキュリティ」のイベントID 4672において、標準ユーザーに対して上位の特権が認可されている

通信

ログの生成場所

ログ種別・名称

取得情報の詳細

チケットの生成に際し、以下のプロセスが実行される

イベントID： 4688 （新しいプロセスが作成されました）

 4689 （プロセスが終了しました）

・プロセス情報 -> プロセス名：   "[検体（ms14-068.exe）]"

・確認できる情報

・プロセスの開始・終了日時 ：
・プロセスを実行したユーザー名 ：
・プロセスを実行したユーザーのドメイン ：  サブジェクト -> アカウント ドメイン
・プロセス実行時の権限昇格の有無 ：
・プロセスの戻り値 ：

 プロセス情報 -> トークン昇格の種類
  プロセス情報 -> 終了状態

ログの日付
サブジェクト -> アカウント名

イベントID： 5156 （Windows フィルターリング プラットフォームで、接続が許可されました）

・アプリケーション情報 -> アプリケーション名：  "\\device\harddiskvolume2\[検体（ms14-068.exe）]"
・アプリケーション情報 -> プロセスID：
・ネットワーク情報 -> 方向：
・ネットワーク情報 -> 宛先アドレス：
・ネットワーク情報 -> 宛先ポート・プロトコル：  "88"・"6"（TCP）

  "[イベント4688で記録されたプロセスID]"
 "送信"
 "[ドメインコントローラのIPアドレス]"

・確認できる情報

・接続元ポート： ソース ポート   ※ ドメインコントローラ側ログとの紐付けに使用する

取得したチケットを使用する際に、以下のプロセスが実行される

イベントID： 4688 （新しいプロセスが作成されました）

 4689 （プロセスが終了しました）

・プロセス情報 -> プロセス名：   "[検体（mimikatz.exe）]"

・確認できる情報

・プロセスの開始・終了日時 ：
・プロセスを実行したユーザー名 ：
・プロセスを実行したユーザーのドメイン ：  サブジェクト -> アカウント ドメイン
・プロセス実行時の権限昇格の有無 ：
・プロセスの戻り値 ：

 プロセス情報 -> トークン昇格の種類
  プロセス情報 -> 終了状態

ログの日付
サブジェクト -> アカウント名

OS：Windows

ユーザー

↓

OS：Windows

Server

管理者ユーザー

接続元

イベントログ

-

セキュリティ

イベントID： 4656 （オブジェクトへのハンドルが要求されました）
 4663 （オブジェクトへのアクセスが試行されました）
 4658 （オブジェクトに対するハンドルが閉じました）
・プロセス情報 -> プロセス名： "[検体（ms14-068.exe）]"

・確認できる情報

・対象のファイル： オブジェクト -> オブジェクト名
・ハンドルID：
・処理内容：
・成否：

 オブジェクト -> ハンドルID  ※ 他ログとの紐付けに使用する
  アクセス要求情報 -> アクセス （"WriteData (またはAddFile)"・"AppendData (またはAddSubdirectoryまたは
 キーワード （"成功の監査"）

イベントID： 5156 （Windows フィルターリング プラットフォームで、接続が許可されました）

・アプリケーション情報 -> アプリケーション名： "System"
・ネットワーク情報 -> 方向：
・ネットワーク情報 -> 宛先アドレス：
・ネットワーク情報 -> 宛先ポート・プロトコル：  "445"・"6"（TCP）

 "送信"
 "[ドメインコントローラのIPアドレス]"

・確認できる情報

・接続元ポート： ソース ポート  ※ ドメインコントローラ側ログとの紐付けに使用する

イベントID： 5156 （Windows フィルターリング プラットフォームで、接続が許可されました）

・アプリケーション情報 -> アプリケーション名： "[\device\harddiskvolume2\windows\system32\lsass.exe"
・ネットワーク情報 -> 方向：
・ネットワーク情報 -> 宛先アドレス：
・ネットワーク情報 -> 宛先ポート・プロトコル：   "88"・"6"（TCP）

 "送信"
 "[ドメインコントローラのIPアドレス]"

・確認できる情報

・接続元ポート： ソース ポート  ※ ドメインコントローラ側ログとの紐付けに使用する

mimikatz.exeの場合、取得したチケットを使用する際に特権利用（失敗）が発生する (管理者権限で実行している場合は発生しない)

イベントID： 4673 （特権のあるサービスが呼び出されました）
・プロセス情報 -> プロセス名： "[検体（mimikatz.exe）]"
・プロセス情報 -> プロセスID： "[検体のプロセスID]"
・サービス要求情報 -> 特権：   "SeTcbPrivilege"
・キーワード：

 "失敗の監査"

・確認できる情報

・上記の動作を試みたアカウント： アカウント名

4949ドメイン管理者権限、アカウントの奪取 > MS14-068 Exploit

追加
設定

必要

-

必要

通信

ログの生成場所

ログ種別・名称

取得情報の詳細

イベントログ

-

Sysmon

接続元

（続）

イベントID： 1 （Process Create）
                5 （Process Terminated）
      ・Image： "[検体(ms14-068.exe)]"

      ・確認できる情報
            ・プロセスの開始・終了日時（UTC） ：     UtcTime
            ・プロセスのコマンドライン ：                  CommandLine
            ・実行ユーザ名 ：                                 User
            ・プロセスID ：                                      ProcessId

イベントID： 1 （Process Create）
                5 （Process Terminated）
      ・Image： "[検体(mimikatz.exe)]"

      ・確認できる情報
            ・プロセスの開始・終了日時（UTC） ：     UtcTime
            ・プロセスのコマンドライン ：                  CommandLine
            ・実行ユーザ名 ：                                 User
            ・プロセスID ：                                      ProcessId

実行履歴

-

Prefetch

ファイル名： C:\Windows\Prefetch\[検体（MS14-068.EXE）]-[文字列].pf
                  C:\Windows\Prefetch\[検体（MIMIKATZ.EXE）]-[文字列].pf

      ・確認できる情報 (ツールを利用して下記を確認できる ツール：WinPrefetchView)
            ・最終実行日時 ：                            Last Run Time

チケットの生成に際し、以下の通信・認証が発生する

イベントID： 5156 （Windows フィルターリング プラットフォームで、接続が許可されました）
      ・アプリケーション情報 -> アプリケーション名： "[\device\harddiskvolume2\windows\system32\lsass.exe"
      ・アプリケーション情報 -> プロセスID：             "[イベント4688で記録されたプロセスID]"
      ・ネットワーク情報 -> 方向：                           "送信"
      ・ネットワーク情報 -> 宛先アドレス：                "[ドメインコントローラのIPアドレス]"
      ・ネットワーク情報 -> 宛先ポート・プロトコル：   "88"・"6"（TCP）

      ・確認できる情報
            ・接続元ポート： ソース ポート  ※ ドメインコントローラ側ログとの紐付けに使用する

OS：Windows

ユーザー

↓

OS：Windows

Server

管理者ユーザー

（続）

イベントID： 4768 （Kerberos認証チケット(TGT)が要求されました）
      ・サービス情報 -> サービス名： "krbtgt"
      ・追加情報 -> チケット オプション： "0x50800000"

      ・確認できる情報
            ・実行アカウント： アカウント情報 -> アカウント名
            ・接続元ホスト：   ネットワーク情報 -> クライアント アドレス
            ・接続元ポート：   ネットワーク情報 -> クライアント ポート

イベントID： 4769 （Kerberosサービス チケットが要求されました）
      ・サービス情報 -> サービス名： "krbtgt"
      ・追加情報 -> チケット オプション： "0x50800000"

      ・確認できる情報
            ・実行アカウント： アカウント情報 -> アカウント名・アカウント ドメイン
            ・接続元ホスト：   ネットワーク情報 -> クライアント アドレス
            ・接続元ポート：   ネットワーク情報 -> クライアント ポート

取得したチケットを使用する際に、以下の通信が発生する

接続先

イベントログ

-

セキュリティ

イベントID： 5156 （Windows フィルターリング プラットフォームで、接続が許可されました）
      ・アプリケーション情報 -> アプリケーション名： "System"
      ・アプリケーション情報 -> プロセスID：            "[イベント4688で記録されたプロセスID]"
      ・ネットワーク情報 -> 方向：                           "送信"
      ・ネットワーク情報 -> 宛先アドレス：                "[ドメインコントローラのIPアドレス]"
      ・ネットワーク情報 -> 宛先ポート・プロトコル：  "445"・"6"（TCP）

      ・確認できる情報
            ・接続元ポート： ソース ポート  ※ ドメインコントローラ側ログとの紐付けに使用する

イベントID： 5156 （Windows フィルターリング プラットフォームで、接続が許可されました）
      ・アプリケーション情報 -> アプリケーション名： "[\device\harddiskvolume2\windows\system32\lsass.exe"
      ・アプリケーション情報 -> プロセスID：             "[イベント4688で記録されたプロセスID]"
      ・ネットワーク情報 -> 方向：                           "送信"
      ・ネットワーク情報 -> 宛先アドレス：                "[ドメインコントローラのIPアドレス]"
      ・ネットワーク情報 -> 宛先ポート・プロトコル：   "88"・"6"（TCP）

      ・確認できる情報
            ・接続元ポート： ソース ポート  ※ ドメインコントローラ側ログとの紐付けに使用する

イベントID： 4769 （Kerberos サービス チケットが要求されました）

      ・確認できる情報
            ・クライアントIPアドレス： ネットワーク情報 -> クライアント アドレス
            ・チケット要求の種類（異なる組のものが2つ出力される）
                  ・ サービス情報： "[ホスト名]$"、チケット オプション： "0x40810000"
                  ・ サービス情報： "krbtgt"、チケット オプション： "0x60810010"

イベントID： 4672 （新しいログオンに特権が割り当てられました）

      ・確認できる情報
            ・権限が昇格したアカウント： サブジェクト -> アカウント名・アカウント ドメイン
            ・利用可能な特権：              特権 （"SeSecurityPrivilege"・"SeRestorePrivilege"・"SeTakeOwnershipPrivilege"・"SeDebugPrivilege"・
                                        "SeSystemEnvironmentPrivilege"・"SeLoadDriverPrivilege"・"SeImpersonatePrivilege"・"SeEnableDelegationPrivilege"）

イベントID： 4624 （アカウントが正常にログオンしました）
      ・ログオン タイプ： "3"

      ・確認できる情報
            ・使用されたセキュリティID： 新しいログオン -> セキュリティID
                                                         ※ 使用されたセキュリティIDとアカウントが異なる場合、この値は奪取されたアカウントのセキュリティIDとなる
            ・アカウント： アカウント名・アカウント ドメイン
            ・ログオンを要求したホスト： ネットワーク情報 -> ソース ネットワーク アドレス

<備考>

記載のもの以外で出力される

可能性のあるイベントログ

昇格した権限を用いて実行されたコマンドのログが、接続先に記録される可能性がある

5050ドメイン管理者権限、アカウントの奪取 > Mimikatz (Golden Ticket)

 凡例
・取得出来る情報
・イベントID・項目名
・フィールド名
・"フィールドの値"

追加
設定

必要

必要

-

必要

3.9.2. Mimikatz (Golden Ticket)

<基本情報>

ツール

動作条件

ログから

得られる情報

ツール名称

カテゴリ

ツール概要

攻撃時における

想定利用例

権限

対象OS

ドメインへの参加
通信プロトコル

サービス
標準設定

追加設定

実行成功時に確認できる痕跡

<確認ポイント>

Mimikatz (Golden Ticket)
ドメイン管理者権限、アカウントの奪取
不正な、任意の期間で有効なKerberosチケットを発行し、再度の認証経ることなく接続を認可させる
認証要求の記録を隠蔽するホストに対して、Golden Ticketを用いて接続を認可させる
・接続元： Mimikatz実行元
・接続先： Mimikatzによってログインされた先
標準ユーザー
※ドメイン上のkrbtgtアカウントの、NTLMパスワードハッシュを取得済みであること
Windows
不要
-
Active Directory Domain Service
・接続元： 実行履歴（Prefetch）
・接続元： 実行履歴（Sysmon・監査ポリシー）

アクセス履歴（Sysmon - RawAccessRead、監査ポリシー - 重要な特権の使用）

・接続先： 不正なドメインを持つアカウントによるログオン
・接続先： イベントログに以下のログがある場合、不正ログオンが実行されていると考えられる

・イベントログ「セキュリティ」のイベントID 4672、4624、4634で、不正なドメインを持つアカウントによるログオンが記録されている

通信

ログの生成場所

ログ種別・名称

取得情報の詳細

イベントID： 4688 （新しいプロセスが作成されました）

 4689 （プロセスが終了しました）

・プロセス情報 -> プロセス名： "[検体（mimikatz.exe）]"

・確認できる情報

・プロセスの開始・終了日時：
・プロセスを実行したユーザー名：
・プロセスを実行したユーザーのドメイン： サブジェクト -> アカウント ドメイン
・プロセス実行時の権限昇格の有無：
・プロセスの戻り値：

  プロセス情報 -> トークン昇格の種類
 プロセス情報 -> 終了状態

ログの日付

  サブジェクト -> アカウント名

イベントID： 4673 （特権のあるサービスが呼び出されました）
・プロセス情報 -> プロセス名： "[検体(mimikatz.exe）]"
・プロセス情報 -> プロセスID： "[検体のプロセスID]"
・サービス要求情報 -> 特権：  "SeTcbPrivilege"
・キーワード：

 "失敗の監査"

イベントログ

-

セキュリティ

・確認できる情報

・上記の動作を試みたアカウント： アカウント名 （標準ユーザー）

・イベントID： 4663 （オブジェクトへのアクセスが試行されました）
 4656 （オブジェクトへのハンドルが要求されました）
 4658 （オブジェクトに対するハンドルが閉じました）

・プロセス情報 -> プロセス名： "[検体（mimikatz.exe）]"

・確認できる情報

・対象のファイル： オブジェクト -> オブジェクト名
・ハンドルID：
・処理内容：

  オブジェクト -> ハンドルID   ※ 他ログとの紐付けに使用する
 アクセス要求情報 -> アクセス （"WriteData (またはAddFile)"・"AppendData (またはAddSubdirectory

  またはCreatePipeInstance)"）

・成否：

 キーワード （"成功の監査"）

イベントID： 1 （Process Create）

 5 （Process Terminated）
・Image： "[検体（mimikatz.exe）]"

イベントログ

-

Sysmon

・確認できる情報

・プロセスの開始・終了日時（UTC）： UtcTime
・プロセスのコマンドライン：
・実行ユーザー名：
・プロセスID：

  CommandLine
 User
 ProcessId

イベントID： 9 （RawAccessRead detected）

・Process： イベント1で記録された、ProcessId
・Image：   "[検体（mimikatz.exe）]"
・Device： "\Device\HarddiskVolume2"

実行履歴

-

Prefetch

ファイル名： C:\Windows\Prefetch\[実行ファイル（MIMIKATZ.EXE）]-[文字列].pf

・確認できる情報 (ツールを利用して下記を確認できる ツール：WinPrefetchView)

・最終実行日時：

 Last Run Time

接続元

OS：Windows

ユーザー

↓

OS：Windows

Server

管理者ユーザー

接続先

イベントログ

-

セキュリティ

イベントID： 4769 （Kerberos サービス チケットの操作）

・確認できる情報

・クライアントIPアドレス： ネットワーク情報 -> クライアント アドレス
・チケット要求の種類（異なる組のものが2つ出力される）

・ サービス情報： "[ホスト名]$"、チケット オプション： "0x40810000"
・ サービス情報： "krbtgt"、チケット オプション： "0x60810010"

イベントID： 4672 （新しいログオンに特権が割り当てられました）

・確認できる情報

・Golden Ticketを取得されたアカウント： アカウント （実在するアカウント名）
・ドメイン：
・ログオンID：
・利用可能な特権：

 アカウント ドメイン （不正な値となる）
ログオンID   ※ 他ログとの紐付けに使用
特権

イベントID： 4624 （アカウントが正常にログオンしました）

・ログオン タイプ： "3"
・新しいログオン -> アカウント名・アカウント ドメイン： "[イベント4672で記録されたアカウント名・アカウント ドメイン]"
・新しいログオン -> ログオンID：

 "[イベント4672で記録されたログオンID]"

・確認できる情報

・使用されたセキュリティID： 新しいログオン -> セキュリティID
・認証情報を使用した端末：  ネットワーク情報 -> ソース ネットワーク アドレス

イベントID： 4634 （ログオフ）

・ログオン タイプ： "3"
・新しいログオン -> アカウント名・アカウント ドメイン： "[イベント4672で記録されたアカウント名・アカウント ドメイン]"
・新しいログオン -> ログオンID：

 "[イベント4672で記録されたログオンID]"

<備考>

記載のもの以外で出力される

可能性のあるイベントログ

Golden Ticketを用いてアクセスが認可されたホストにおいて、実行されたコマンドに関連するログが出力される可能性がある

5151ドメイン管理者権限、アカウントの奪取 > Mimikatz (Silver Ticket)

 凡例
・取得出来る情報
・イベントID・項目名
・フィールド名
・"フィールドの値"

追加
設定

必要

必要

-

必要

3.9.3. Mimikatz (Silver Ticket)

<基本情報>

ツール

動作条件

ログから

得られる情報

ツール名称

カテゴリ

ツール概要

攻撃時における

想定利用例

権限

対象OS

ドメインへの参加
通信プロトコル

サービス
標準設定

追加設定

実行成功時に確認できる痕跡

<確認ポイント>

Mimikatz (Silver Ticket)
ドメイン管理者権限、アカウントの奪取
不正な、任意の期間で有効なKerberosチケットを発行し、再度の認証を経ることなく接続を認可させる
認証要求の記録を隠蔽するホストに対して、Silver Ticketを用いて接続を認可させる
・接続元： Mimikatz実行元
・接続先： Mimikatzによってログインされた先
標準ユーザー
※ドメイン上のサービスアカウントの、NTLMパスワードハッシュを取得済みであること
Windows
不要
-
Active Directory Domain Services
・接続元： 実行履歴（Prefetch）
・接続元： 実行履歴（Sysmon・監査ポリシー）
・接続先： 不正なドメインを持つアカウントによるログオン
・接続先： イベントログに以下のログがある場合、不正ログオンが実行されていると考えられる

・イベントログ「セキュリティ」のイベントID 4672、4624、4634で、不正なドメインを持つアカウントによるログオンが記録されている

通信

ログの生成場所

ログ種別・名称

取得情報の詳細

イベントID： 4688 （新しいプロセスが作成されました）

 4689 （プロセスが終了しました）

・プロセス情報 -> プロセス名： "[検体（mimikatz.exe）]"

・確認できる情報

・プロセスの開始・終了日時：
・プロセスを実行したユーザー名：
・プロセスを実行したユーザーのドメイン： サブジェクト -> アカウント ドメイン
・プロセス実行時の権限昇格の有無：
・プロセスの戻り値：

  プロセス情報 -> トークン昇格の種類
 プロセス情報 -> 終了状態

ログの日付

  サブジェクト -> アカウント名

イベントログ

-

セキュリティ

イベントID： 4673 （特権のあるサービスが呼び出されました）
・プロセス情報 -> プロセス名： "[検体(mimikatz.exe）]"
・プロセス情報 -> プロセスID： "[検体のプロセスID]"
・サービス要求情報 -> 特権：  "SeTcbPrivilege"
・キーワード：

 "失敗の監査"

・確認できる情報

・上記の動作を試みたアカウント： アカウント名 （標準ユーザー）

接続元

イベントID： 1 （Process Create）

 5 （Process Terminated）
・Image： "[検体（mimikatz.exe）]"

イベントログ

-

Sysmon

・確認できる情報

・プロセスの開始・終了日時（UTC）： UtcTime
・プロセスのコマンドライン：
・実行ユーザー名：
・プロセスID：

  CommandLine
 User
 ProcessId

イベントID： 9 （RawAccessRead detected）

・Process： イベント1で記録された、ProcessId
・Image：   "[検体（mimikatz.exe）]"
・Device： "\Device\HarddiskVolume2"

実行履歴

-

Prefetch

ファイル名： C:\Windows\Prefetch\[実行ファイル（MIMIKATZ.EXE）]-[文字列].pf

・確認できる情報 (ツールを利用して下記を確認できる ツール：WinPrefetchView)

・最終実行日時：

 Last Run Time

・Golden Ticketとは異なり、チケット生成時にドメインコントローラへの通信は発生しない
・以下は、チケットを用いて通信が着信した際のログ

OS：Windows

ユーザー

↓

OS：Windows

Server
サービス
アカウント

イベントID： 4672 （新しいログオンに特権が割り当てられました）

・特権： "SeSecurityPrivilege"・"SeBackupPrivilege"・"SeRestorePrivilege"・"SeTakeOwnershipPrivilege"・"SeDebugPrivilege"・
 "SeSystemEnvironmentPrivilege"・"SeLoadDriverPrivilege"・"SeImpersonatePrivilege"・"SeEnableDelegationPrivilege"

・確認できる情報

・奪取されたアカウント名： アカウント （実在するアカウント名）
・ドメイン：
・ログオンID：
・利用可能な特権：

 アカウント ドメイン （不正な値となる）
ログオンID   ※ 他ログとの紐付けに使用
特権

接続先

イベントログ

-

セキュリティ

イベントID： 4624 （アカウントが正常にログオンしました）

・ログオン タイプ： "3"
・新しいログオン -> アカウント名・アカウント ドメイン： "[イベント4672で記録されたアカウント名・アカウント ドメイン]"
・新しいログオン -> ログオンID：

 "[イベント4672で記録されたログオンID]"

・確認できる情報

・使用されたセキュリティID： 新しいログオン -> セキュリティID
・認証情報を使用した端末：  ネットワーク情報 -> ソース ネットワーク アドレス

イベントID： 4634 （ログオフ）

・ログオン タイプ： "3"
・新しいログオン -> アカウント名・アカウント ドメイン： "[イベント4672で記録されたアカウント名・アカウント ドメイン]"
・新しいログオン -> ログオンID：

 "[イベント4672で記録されたログオンID]"

<備考>

記載のもの以外で出力される

可能性のあるイベントログ

Silver Ticketを用いてアクセスが認可されたホストにおいて、実行されたコマンドに関連するログが出力される可能性がある

52523.10.1. ntdsutil

<基本情報>

ツール

ツール名称

カテゴリ

ツール概要

ntdsutil
Active Directory データベースの取得
Active Directory データベースを保守するコマンド

攻撃時における

想定利用例

権限

対象OS

ドメインへの参加
通信プロトコル

サービス

標準設定

追加設定

動作条件

ログから

得られる情報

NTDSのデータベースであるNTDS.DITを抽出し、他のツールを用いてパスワードを解析する(Active Directoryで実行)

管理者ユーザー
Windows Server
要
-
Active Directory Domain Services
・サービスの開始、ストレージデバイスに対するドライバのインストールが発生したこと
・シャドウコピーを作成した履歴
・実行履歴（Sysmon・監査ポリシー）
以下が確認できた場合、情報収集が行われている可能性がある
・ntdsutil.exeが実行され、イベントログに以下のログがある場合

Active Directory データベースの取得 > ntdsutil

 凡例
・取得出来る情報
・イベントID・項目名
・フィールド名
・"フィールドの値"

実行成功時に確認できる痕跡

  ・イベントログ「セキュリティ」にイベントID: 8222が記録されている

・オブジェクト "[システムドライブ]\SNAP_[日時]_VOLUME[ドライブレター]$" に対するハンドルの要求が成功している

※ さらに、通常は読み出せない C:\Windows\NTDS 配下のファイルをコピーしたログ（イベントID: 4663）が記録されている場合、シャドウコピーを利用されている可能性がある

<確認ポイント>

通信

ログの生成場所

ログ種別・名称

取得情報の詳細

イベントID： 4688 （新しいプロセスが作成されました）

4689 （プロセスが終了しました）

・プロセス情報 -> プロセス名：   "C:\Windows\System32\ntdsutil.exe"

・確認できる情報

・プロセスの開始・終了日時 ：
・プロセスを実行したユーザー名 ：
・プロセスを実行したユーザーのドメイン ：  サブジェクト -> アカウント ドメイン
 プロセス情報 -> 新しいプロセスID
・プロセスID：
 プロセス情報 -> トークン昇格の種類
・プロセス実行時の権限昇格の有無 ：
・プロセスの戻り値 ：
  プロセス情報 -> 終了状態

ログの日付
サブジェクト -> アカウント名

イベントID： 4673 （特権のあるサービスが呼び出されました）
・プロセス -> プロセス名： "C:\Windows\explorer.exe"

・確認できる情報

・使用されている特権： サービス要求情報 -> 特権 （"SeTcbPrivilege"）

イベントログ

-

セキュリティ

イベントID： 8222 （シャドウ コピーが作成されました）

・確認できる情報

・シャドウコピー名： シャドウ デバイス名

※ 本ログは、追加設定せずとも記録される

イベントID： 4656 （オブジェクトに対するハンドルが要求されました）

・プロセス情報 -> プロセス名： "C:\Windows\System32\VSSVC.exe"

・確認できる情報

・マウントポイント： オブジェクト -> オブジェクト名 （"C\SNAP_[日時]_VOLUME[C]$"）
・成否：

 キーワード （"成功の監査"）

-

Active Directory

ドメインコントローラ

・備考

・通常は読み出せない C:\Windows\NTDS 配下のファイルをコピーしたログ（イベント4663）が成功していた場合、アクセスが成功していたと考えられる

なお、イベント4663の出力には、オブジェクトアクセスの監査が必要

イベントログ

-

Sysmon

イベントID： 1 （Process Create）

5 （Process Terminated）

・Image： "C:\Windows\System32\ntdsutil.exe"

・確認できる情報

・プロセスの開始・終了日時（UTC） ：
・プロセスのコマンドライン ：
・実行ユーザ名 ：
・プロセスID ：

 UtcTime
 CommandLine
 User
  ProcessId

イベントID： 7036

・詳細タブ -> EventData\param1 が以下のいずれかとなっている、サービスの開始が記録される可能性がある

・"Volume Shadow Copy"
・"Microsoft Software Shadow Copy Provider"
・"Windows Modules Installer"

※ 各サービスが既に実行中の場合、ログは出力されない

イベントログ

-

システム

イベントID： 20001

・詳細タブ -> System\Provider\Name が "Microsoft-Windows-UserPnp" となっている

・確認できる情報
・プロセスID：
・スナップショット名： UserData\InstallDeviceID\DeviceInstanceID

  System\Execution\ProcessID    ※ Sysmonログ中に出力される、drvinst.exeのプロセスIDと一致する

※ 一度同様のスナップショットをマウントしたことがある場合、出力されない可能性がある

実行履歴
レジストリ

レジストリエントリ: HKEY_LOCAL_MACHINE\CurrentControlSet\Enum\STORAGE\VolumeSnapshot\HarddiskVolumeSnapshot[Snapshot番号]

・drvinst.exeが実行された場合、新規にキーが作成される

追加
設定

必要

必要

-

-

<備考>

記載のもの以外で出力される

可能性のあるイベントログ

volsnap.inf にドライバのインストールが行われたことが差分として残る可能性がある (一度同様のスナップショットをマウントしたことがある場合、出力されない可能性がある)

53533.10.2. vssadmin

Active Directory データベースの取得 > vssadmin

<基本情報>

ツール

動作条件

ログから

得られる情報

攻撃時における

想定利用例

権限

対象OS

ドメインへの参加
通信プロトコル

サービス

標準設定

追加設定

実行成功時に確認できる痕跡

<確認ポイント>

ツール名称

カテゴリ

ツール概要

vssadmin
Active Directory データベースの取得
Volume Shadow Copyを作成し、NTDS.DITを抽出する

NTDSのデータベースであるNTDS.DITを抽出し、他のツールを用いてパスワードを解析する(Active Directoryで実行)

管理者ユーザー
Windows Server
要
-
Active Directory Domain Services
・サービスの開始、ストレージデバイスに対するドライバのインストールが発生したこと
・シャドウコピーを作成した履歴
・実行履歴（Sysmon・監査ポリシー）
イベントログに以下のログがある場合、シャドウコピーが作成されたと考えられる
              ・イベントログ「セキュリティ」にイベントID: 8222が記録されている
    ※ さらに、通常は読み出せない C:\Windows\NTDS 配下のファイルをコピーしたログ（イベントID: 4663）が記録されている場合、シャドウコピーを利用されている可能性がある

通信

ログの生成場所

ログ種別・名称

取得情報の詳細

-

Active Directory

ドメインコントローラ

イベントID： 4688 （新しいプロセスが作成されました）
                4689 （プロセスが終了しました）
      ・プロセス情報 -> プロセス名：   "C:\Windows\System32\vssadmin.exe"

      ・確認できる情報
            ・プロセスの開始・終了日時 ：                   ログの日付
            ・プロセスを実行したユーザー名 ：            サブジェクト -> アカウント名
            ・プロセスを実行したユーザーのドメイン ：  サブジェクト -> アカウント ドメイン
            ・プロセスID：                                         プロセス情報 -> 新しいプロセスID
            ・プロセス実行時の権限昇格の有無 ：       プロセス情報 -> トークン昇格の種類
            ・プロセスの戻り値 ：                               プロセス情報 -> 終了状態

イベントID： 8222 （シャドウ コピーが作成されました）

      ・確認できる情報
            ・シャドウコピー名： シャドウ デバイス名

・備考
  ・通常は読み出せない C:\Windows\NTDS 配下のファイルをコピーしたログ（イベント4663）が成功していた場合、アクセスが成功していたと考えられる
    ログの出力内容は、コピーに使用されたソフトウェアに依存する。なお、イベント4663の出力には、オブジェクトアクセスの監査が必要

イベントID： 7036
      ・詳細タブ -> System\Provider\Name： "Service Control Manager"
      ・詳細タブ -> EventData\param1：        "Volume Shadow Copy"

      ・確認できる情報
            ・サービスの実行： 詳細タブ -> EventData\param2 （"実行中" ）

※ 既にVolume Shadow Copyサービスが動作している場合、出力されない

イベントID： 20001
      ・詳細タブ -> System\Provider\Name： "Microsoft-Windows-UserPnp"

      ・確認できる情報
            ・プロセスID：           System\Execution\ProcessID   ※ Sysmonログ中に出力される、drvinst.exeのプロセスIDと一致する
            ・スナップショット名： UserData\InstallDeviceID\DeviceInstanceID

※ 一度同様のスナップショットをマウントしたことがある場合、出力されない可能性がある

イベントID： 1 （Process Create）
                5 （Process Terminated）
      ・Image： "C:\Windows\System32\vssadmin.exe"

      ・確認できる情報
            ・プロセスの開始・終了日時（UTC） ：     UtcTime
            ・プロセスのコマンドライン ：                  CommandLine   ※ シャドウコピー作成対象のドライブなどが記録される
            ・実行ユーザ名 ：                                 User
            ・プロセスID ：                                      ProcessId

レジストリエントリ: HKEY_LOCAL_MACHINE\CurrentControlSet\Enum\STORAGE\VolumeSnapshot\HarddiskVolumeSnapshot[Snapshot番号]
  ・drvinst.exeが実行された場合、新規にキーが作成される

イベントログ

-

セキュリティ

イベントログ

-

システム

イベントログ

-

Sysmon

実行履歴

-

レジストリ

  凡例
・取得出来る情報
・イベントID・項目名
・フィールド名
・"フィールドの値"

追加
設定

必要

-

-

必要

-

<備考>

記載のもの以外で出力される

可能性のあるイベントログ

volsnap.inf にドライバのインストールが行われたことが差分として残る可能性がある (一度同様のスナップショットをマウントしたことがある場合、出力されない可能性がある)

54543.11.1. net user

<基本情報>

ツール

ツール名称

カテゴリ

ツール概要

netコマンド (net user)
ローカルユーザーの追加・削除、グループの追加・削除
端末内、又はドメイン上に、ユーザーアカウントを追加する

攻撃時における

想定利用例

権限

対象OS

ドメインへの参加

通信プロトコル

サービス
標準設定
追加設定

動作条件

ログから

得られる情報

実行成功時に確認できる痕跡

<確認ポイント>

侵入した端末にアカウントを作成し、追加のセッションを作成したり、他の端末と通信したりする

管理者ユーザー
Windows
不要
-
※ ドメインの管理者権限があれば、ドメインコントローラ上にアカウントを作成することも可能
-
・ユーザーが追加されたことが、ログに記録される
・"net user"コマンドで指定されたユーザー名及びパスワードが記録される（Sysmon）
イベントログに以下のログがある場合、ユーザが追加されたと考えられる

・イベントログ「セキュリティ」にイベントID 4720が記録されている

通信

ログの生成場所

ログ種別・名称

取得情報の詳細

ローカルユーザーの追加・削除、グループの追加・削除 > netコマンド (net user)

 凡例
・取得出来る情報
・イベントID・項目名
・フィールド名
・"フィールドの値"

イベントID： 4688 （新しいプロセスが作成されました）

 4689 （プロセスが終了しました）

・プロセス情報 -> プロセス名： "C:\Windows\System32\net.exe"

 "C:\Windows\System32\net1.exe"  ※ net.exeが実行された後、子プロセスとしてnet1.exeが実行される

・確認できる情報

・プロセスの開始・終了日時：
・プロセスを実行したユーザー名：
・プロセスを実行したユーザーのドメイン： サブジェクト -> アカウント ドメイン
・プロセス実行時の権限昇格の有無：
・プロセスの戻り値：

ログの日付
サブジェクト -> アカウント名

  プロセス情報 -> トークン昇格の種類   ※ 管理者権限が必要なため、1又は2となる
 プロセス情報 -> 終了状態

イベントログ

-

セキュリティ

イベントID： 4656 （SAM - オブジェクトに対するハンドルが要求されました）

 ・プロセス情報 -> プロセス名：           "C:\Windows\System32\lsass.exe"
・オブジェクト -> オブジェクトの種類： "SAM_DOMAIN"

・確認できる情報
・ハンドルID：
・要求された処理： アクセス要求情報 -> アクセス （"ReadPasswordParameters"・"CreateUser"・"LookupIDs"）
・成否：

　オブジェクト -> ハンドル ID   ※ 他ログとの関連付けに使用する

 キーワード （"成功の監査"）

-

端末

(Windows)

イベントID： 4720 （ユーザー アカウントが作成されました）

・新しいアカウント -> アカウント名： "net user"コマンドで指定したユーザー名

・確認できる情報

・ユーザーのグループ： 属性 -> プライマリ グループ ID

※ 実行した処理内容により、異なるイベント（4722, 4724, 4726, 4737, 4738 など）が記録される

イベントID： 1 （Process Create）

 5 （Process Terminated）

・Image： "C\Windows\System32\net.exe"

 "C:\Windows\System32\net1.exe"

・確認できる情報

・プロセスの開始・終了日時（UTC）： UtcTime
・プロセスのコマンドライン：

  CommandLine    ※ 引数内にユーザーを追加したこと（user /add）及び

ユーザー名とパスワード（引数に渡した場合）が記録される

・実行ユーザー名：
・プロセスID：

 User
 ProcessId

イベントログ

-

Sysmon

<備考>

記載のもの以外で出力される

可能性のあるイベントログ

グループへの追加などを実施している場合、それに関連するアクセス履歴が記録される

追加
設定

必要

必要

55553.12.1. net use

<基本情報>

ツール

動作条件

ログから

得られる情報

ツール名称

カテゴリ

ツール概要

攻撃時における

想定利用例

権限

対象OS

ドメインへの参加
通信プロトコル

サービス
標準設定

追加設定

netコマンド (net use)
ファイル共有
ネットワーク上で公開されている共有ポイントに接続する
共有ポイントを経由して攻撃中に使用するツールを送り込んだり、ファイルサーバーから情報を取得したりする
・接続元： netコマンド実行元
・接続先： netコマンドによってアクセスされた端末
標準ユーザー
Windows
不要
445/tcp
接続先： Server、接続元： Workstation
-
・接続元： 実行履歴（Sysmon・監査ポリシー）
・接続先： Windowsフィルターリング プラットフォームの記録は残るが、具体的に接続されたパスを確認するには読み取りに対する監査が必要

実行成功時に確認できる痕跡

<確認ポイント>

※共有に対して書き込みがされた場合は、書き込みに対する監査で記録される

・接続元： イベントログに以下のログがある場合、ファイル共有が行われた可能性がある

・イベントログ「セキュリティ」にnet.exeのイベントID 4689 （プロセスが終了しました）が記録され、実行結果（戻り値）が"0x0"となっている

通信

ログの生成場所

ログ種別・名称

取得情報の詳細

イベントID： 4688 （新しいプロセスが作成されました）

 4689 （プロセスが終了しました）

・プロセス情報 -> プロセス名： "C:\Windows\System32\net.exe"

・確認できる情報

・プロセスの開始・終了日時：
・プロセスを実行したユーザー名：
・プロセスを実行したユーザーのドメイン： サブジェクト -> アカウント ドメイン
・プロセス実行時の権限昇格の有無：
・プロセスの戻り値：

  プロセス情報 -> トークン昇格の種類
 プロセス情報 -> 終了状態

ログの日付
サブジェクト -> アカウント名

イベントログ

-

セキュリティ

接続元

イベントID： 5156 （Windows フィルターリング プラットフォームで、接続が許可されました）

 ・ネットワーク情報 -> 方向：                         "送信"
 ・ネットワーク情報 -> 宛先アドレス：              "[共有ポイントとして指定したホスト]"
・ネットワーク情報 -> 宛先ポート・プロトコル： "445"・"6"（TCP）

OS：Windows

ユーザー

↓

OS：Windows

ユーザー

実行履歴

-

Sysmon

・確認できる情報

・送信元ポート： ネットワーク情報 -> ソース ポート

イベントID： 1 （Process Create）

 5 （Process Terminated）

・Image： "C\Windows\System32\net.exe"

・確認できる情報

・プロセスの開始・終了日時（UTC）： UtcTime
・プロセスのコマンドライン：
・実行ユーザー名：
・プロセスID：

  CommandLine    ※ 引数内に接続先ホストと共有パスが記録される
 User
 ProcessId

接続先

イベントログ

-

セキュリティ

イベントID： 5156 （Windows フィルターリング プラットフォームで、接続が許可されました）

 ・ネットワーク情報 -> 方向：                             "着信"
 ・ネットワーク情報 -> 送信元アドレス：               "[ファイルサーバのIPアドレス]"
・ネットワーク情報 -> ソース ポート・プロトコル： "445"・"6"（TCP）

・確認できる情報

・接続元ホスト： ネットワーク情報 -> 宛先アドレス
・送信元ポート： ネットワーク情報 -> 宛先ポート   ※ 接続元における、送信元ポートと一致する

Active Directory

ドメイン コントローラ

イベントログ

-

セキュリティ

イベントID： 4624 （アカウントが正常にログオンしました）

・ログオン タイプ： "3"
・ネットワーク情報 -> ソース ネットワーク アドレス： "[イベント5156における、宛先アドレス]"
・ネットワーク情報 -> ソース ポート：

 "[イベント5156に記録された、宛先ポート]"

・確認できる情報

・使用されたユーザー： 新しいログオン -> アカウント名・アカウント ドメイン

<備考>

記載のもの以外で出力される

可能性のあるイベントログ

・読み取りアクセスを監査対象に含めると、接続された共有パスがイベント5140（ファイルの共有）に記録される
・共有に対して書き込みが発生した場合、オブジェクトアクセスの監査に記録される

ファイル共有 > netコマンド (net use)

 凡例
・取得出来る情報
・イベントID・項目名
・フィールド名
・"フィールドの値"

追加
設定

必要

必要

必要

必要

56563.12.2. net share

<基本情報>

ツール

動作条件

ログから

得られる情報

実行成功時に確認できる痕跡

<確認ポイント>

ツール名称

カテゴリ

ツール概要

netコマンド (net share)
ファイル共有
特定のフォルダを、ネットワーク経由で利用可能となるよう共有する

攻撃時における

想定利用例

権限

対象OS

ドメインへの参加
通信プロトコル

サービス
標準設定
追加設定

侵入したホスト上で共有パスを作成し、ファイルを読み書きする

管理者ユーザー
Windows
不要
- ※ 共有されたパスの利用はネットワーク経由でおこなうが、"net share"により共有を追加する際には端末内で完結する
Server
・レジストリ上に共有パスの情報が残る可能性がある   ※ ファイル共有が無効化されると値は消去される
・実行履歴（Sysmon・監査ポリシー）   ※ 共有されたパスと、使用された共有名が記録される
イベントログに以下のログがある場合、共有フォルダが作成されたと判断出来る

・イベントログ「セキュリティ」にイベントID 5142 が記録されている

通信

ログの生成場所

ログ種別・名称

取得情報の詳細

イベントID： 4688 （新しいプロセスが作成されました）

 4689 （プロセスが終了しました）

・プロセス情報 -> プロセス名： "C:\Windows\System32\net.exe"

 "C:\Windows\System32\net1.exe"    ※ net.exeが実行された後、子プロセスとしてnet1.exeが実行される

・確認できる情報

-

端末

(Windows)

イベントログ

-

セキュリティ

イベントログ

-

Sysmon

・プロセスの開始・終了日時：
・プロセスを実行したユーザー名：
・プロセスを実行したユーザーのドメイン： サブジェクト -> アカウント ドメイン
・プロセス実行時の権限昇格の有無：
・プロセスの戻り値：

ログの日付
サブジェクト -> アカウント名

  プロセス情報 -> トークン昇格の種類   ※ 管理者権限が必要なため、1又は2となる
 プロセス情報 -> 終了状態

イベントID： 5142 （ネットワーク共有オブジェクトが追加されました）

・確認できる情報

・共有名：
・共有に使用されたフォルダ： 共有パス

 共有情報 -> 共有名

イベントID： 1 （Process Create）

 5 （Process Terminated）

・Image： "C\Windows\System32\net.exe"

 "C:\Windows\System32\net1.exe"

・確認できる情報

・プロセスの開始・終了日時（UTC）： UtcTime
・プロセスのコマンドライン：
・実行ユーザー名：
・プロセスID：

  CommandLine    ※ 引数に、共有名や共有に使用されたフォルダが記録される
 User
 ProcessId

アクセス履歴

レジストリエントリ: HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\LanmanServer\Shares\Security\[共有名]$

-

レジストリ

※ ファイル共有が有効化されると作成される (無効化されると値は消去される)

共有が無効化されると値が消去されるため、常時レジストリを監視するような仕組みが無ければ検知は困難

<備考>

記載のもの以外で出力される

可能性のあるイベントログ

-

ファイル共有 > netコマンド (net share)

 凡例
・取得出来る情報
・イベントID・項目名
・フィールド名
・"フィールドの値"

追加
設定

必要

必要

-

57573.12.3. icacls

<基本情報>

ツール

動作条件

ログから

得られる情報

ツール名称

カテゴリ

ツール概要

icacls
ファイル共有
ファイルのアクセス権を変更する

攻撃時における

想定利用例

・使用されているアカウントで読み取れないファイルを、読み取れるように権限を変更する
・攻撃者が作成したファイルの内容が閲覧できなくなるよう、権限を剥奪する

権限

対象OS

ドメインへの参加
通信プロトコル

サービス
標準設定
追加設定

標準ユーザー
※ ACL変更時にはそのファイルに対する適切な権限が必要
Windows
不要
-
-
実行履歴（Prefetch）
実行履歴（Sysmon・監査ポリシー）
イベントログに以下のログがある場合、ファイルのアクセス権変更が行われたと考えられる

ファイル共有 > icacls

 凡例
・取得出来る情報
・イベントID・項目名
・フィールド名
・"フィールドの値"

実行成功時に確認できる痕跡

・イベントログ「セキュリティ」にicacls.exeに対するイベントID: 4688及び4689が記録されており、イベントID: 4689中の終了状態が"0x0"となっている

※ なお、イベントID: 4688・4689からは対象ファイルが判断出来ないため、対象の絞り込みにはsysmonのイベントID: 1よりicacls.exeのコマンドラインを併せて確認する必要がある

<確認ポイント>

通信

ログの生成場所

ログ種別・名称

取得情報の詳細

-

端末

(Windows)

イベントログ

-

セキュリティ

実行履歴

-

Sysmon

実行履歴

-

Prefetch

イベントID： 4688 （新しいプロセスが作成されました）

 4689 （プロセスが終了しました）

・プロセス情報 -> プロセス名： "C:\Windows\System32\icacls.exe"

・確認できる情報

・プロセスの開始・終了日時 ：
・プロセスを実行したユーザー名 ：
・プロセスを実行したユーザのドメイン ：  サブジェクト -> アカウント ドメイン
・プロセス実行時の権限昇格の有無 ：    プロセス情報 -> トークン昇格の種類
・プロセスの戻り値 ：

ログの日付
サブジェクト -> アカウント名

 プロセス情報 -> 終了状態

イベントID： 1 （Process Create）

 5 （Process Terminated）

・Image： "C:\Windows\System32\icacls.exe"

・確認できる情報

・プロセスの開始・終了日時（UTC）：  UtcTime
・プロセスのコマンドライン：
・実行ユーザー名：
・プロセスID：

 CommandLine   ※ 引数内に対象ファイルと設定された権限が記録される
 User
 ProcessId

ファイル名： C:\Windows\Prefetch\ICACLS.EXE-CCAC2A58.pf

・確認できる情報 (ツールを利用して下記を確認できる ツール：WinPrefetchView)

・最終実行日時：

 Last Run Time

<備考>

記載のもの以外で出力される

可能性のあるイベントログ

-

追加
設定

必要

必要

-

58583.13.1. sdelete

<基本情報>

ツール

ツール名称

カテゴリ

ツール概要

sdelete
痕跡の削除
ファイルを複数回上書きしてから削除する

攻撃時における

想定利用例

権限

対象OS

ドメインへの参加
通信プロトコル

サービス

標準設定

追加設定

動作条件

ログから

得られる情報

実行成功時に確認できる痕跡

<確認ポイント>

攻撃の過程において作成されたファイルを、復元不可な状態となるように削除する

標準ユーザー
Windows
不要
-
-
・実行履歴（Prefetch）
・sdeleteを使用した際の使用許諾契約に同意した旨がレジストリに記録される  ※ 過去に利用した事がある場合、標準設定で得られるレジストリ情報からは判断できない
・実行履歴（Sysmon・監査ポリシー）
・オブジェクトアクセスの監査による、削除対象ファイルを削除・上書きする動作の記録
・以下のような名前のファイルが繰り返し削除されている
      ・例： 削除対象が sdelete.txt の場合、sdeleAAAAAAAAAAAAAAAAAAAA.AAA、sdeleZZZZZZZZZZZZZZZZZZZZ.ZZZなど

通信

ログの生成場所

ログ種別・名称

取得情報の詳細

イベントID： 4688 （新しいプロセスが作成されました）
                4689 （プロセスが終了しました）
      ・プロセス情報 -> プロセス名： "[実行ファイル（sdelete.exe）]"

      ・確認できる情報
            ・プロセスの開始・終了日時：                   ログの日付
            ・プロセスを実行したユーザー名：           サブジェクト -> アカウント名
            ・プロセスを実行したユーザーのドメイン： サブジェクト -> アカウント ドメイン
            ・プロセス実行時の権限昇格の有無：       プロセス情報 -> トークン昇格の種類
            ・プロセスの戻り値：                              プロセス情報 -> 終了状態

イベントログ

-

セキュリティ

イベントID： 4656 （オブジェクトへのハンドルが要求されました）
                4663 （オブジェクトへのアクセスが試行されました）
                4658 （オブジェクトに対するハンドルが閉じました）
      ・プロセス情報 -> プロセス名： "[実行ファイル（sdelete.exe）]"

-

端末

(Windows)

      ・確認できる情報
            ・削除対象のファイル： オブジェクト -> オブジェクト名
                      ※ 上書き削除の過程で、sdeleteは削除対象ファイルの名前に、アルファベットを付与したファイルを作成し、削除する動作を繰り返す
                          （例： 削除対象が sdelete.txt の場合、sdeleAAAAAAAAAAAAAAAAAAAA.AAAなど）
            ・処理内容：               アクセス要求情報 -> アクセス
                      ※ 同一のオブジェクトに対して、"DELETE"や"WriteDataまたはAddFile"などが繰り返される
            ・成否：                      キーワード （"成功の監査"）

イベントID： 1 （Process Create）
                5 （Process Terminated）
      ・Image： "[実行ファイル（sdelete.exe）]"

      ・確認できる情報
            ・プロセスの開始・終了日時（UTC） ：     UtcTime
            ・プロセスのコマンドライン ：                  CommandLine  ※ 実行ファイルの他、上書き回数など、sdelete.exeに渡されたオプションが分かる
            ・実行ユーザ名 ：                                 User
            ・プロセスID ：                                      ProcessId

ファイル名： C:\Windows\Prefetch\[実行ファイル（SDELETE.EXE）]-[文字列].pf

      ・確認できる情報 (ツールを利用して下記を確認できる ツール：WinPrefetchView)
            ・最終実行日時 ：                            Last Run Time

イベントログ

-

Sysmon

実行履歴

-

Prefetch

実行履歴

-

レジストリ

レジストリエントリ: HKEY_USERS\[SID]\Software\Sysinternals\Sdelete
  ・初めて利用した場合、使用許諾契約に同意した旨が EulaAccepted に記録される
  ・過去に端末上でsdeleteを利用した事がある場合、この項目からは区別できない

<備考>

記載のもの以外で出力される

可能性のあるイベントログ

-

痕跡の削除 > sdelete

  凡例
・取得出来る情報
・イベントID・項目名
・フィールド名
・"フィールドの値"

追加
設定

必要

必要

-

-

59593.13.2. timestomp

ツール名称

カテゴリ

ツール概要

timestomp
痕跡の削除
ファイルのタイムスタンプを変更する

<基本情報>

ツール

動作条件

ログから

得られる情報

攻撃時における

想定利用例

権限

対象OS

ドメインへの参加
通信プロトコル

サービス
標準設定

追加設定

実行成功時に確認できる痕跡

<確認ポイント>

攻撃者が利用したことでタイムスタンプに変更が発生したファイルについて、タイムスタンプを戻すことで、ファイルに対してアクセスしたことを隠蔽する

標準ユーザー
Windows
不要
-
-
・実行履歴（Prefetch）
・実行履歴（Sysmon・監査ポリシー）
・ファイル作成日時に対する変更の監査
イベントログに以下のログがある場合、タイムスタンプが変更されたと考えられる

・イベントログ「セキュリティ」にイベントID 4663が記録されており、対象ファイルに対する"WriteAttributes"のキーワードが"成功の監査"となっている

通信

ログの生成場所

ログ種別・名称

取得情報の詳細

イベントID： 4688 （新しいプロセスが作成されました）

 4689 （プロセスが終了しました）

・プロセス情報 -> プロセス名：   "[検体（timestomp.exe）]"

・確認できる情報

・プロセスの開始・終了日時 ：
・プロセスを実行したユーザー名 ：
・プロセスを実行したユーザーのドメイン ：  サブジェクト -> アカウント ドメイン
・プロセス実行時の権限昇格の有無 ：
・プロセスの戻り値 ：

 プロセス情報 -> トークン昇格の種類
  プロセス情報 -> 終了状態

ログの日付
サブジェクト -> アカウント名

イベントID： 4656 （オブジェクトに対するハンドルが要求されました）

・プロセス情報 -> プロセス名： "[検体（timestomp.exe）]"

・確認できる情報

イベントログ

-

セキュリティ

・対象ファイル： オブジェクト -> オブジェクト名
・ハンドルID：    オブジェクト -> ハンドルID   ※ 他ログとの紐付けに使用する
・処理内容：
・成否：

  アクセス要求情報 -> アクセス （"SYNCHRONIZE"、"ReadAttributes"、"WriteAttributes"）
 キーワード （"成功の監査"）

イベントID： 4663 （オブジェクトへのアクセスが試行されました）
・プロセス情報 -> プロセス名： "[検体（timestomp.exe）]"

・確認できる情報

・対象ファイル： オブジェクト -> オブジェクト名
・ハンドルID：    オブジェクト -> ハンドルID   ※ 他ログとの紐付けに使用する
・処理内容：
・成否：

  アクセス要求情報 -> アクセス （"WriteAttributes"）
 キーワード （"成功の監査"）

イベントID： 4658 （オブジェクトに対するハンドルが閉じました）
・プロセス情報 -> プロセス名： "[検体（timestomp.exe）]"

-

端末

(Windows)

・確認できる情報

・ハンドルID： オブジェクト -> ハンドルID   ※ 先に出力される、イベント4663及び4656で記録されるハンドルIDと同じ

イベントID： 1 （Process Create）

 5 （Process Terminated）

・Image： "[検体（timestomp.exe）]"

・確認できる情報

・プロセスの開始・終了日時（UTC） ：
・プロセスのコマンドライン ：

 UtcTime
 CommandLine

・実行ユーザ名 ：

 User

※ コマンドライン内の引数に、対象ファイル、変更対象のプロパティ、変更後のタイムスタンプが記録される

イベントID： 2 （File creation time changed）

・Image： "[検体（timestomp.exe）]"

イベントログ

-

Sysmon

・確認できる情報

・変更が発生した日時（UTC）：
・変更されたファイル名：
・変更後のタイムスタンプ（UTC）： CreationUtcTime
・変更前のタイムスタンプ（UTC）： PreviousCreationUtcTime

 UtcTime
 TargetFilename

※ イベント2 はファイル作成日時の変更を示すが、変更されたタイムスタンプの種類（作成・変更・アクセス）に関わらず出力される

作成日時以外の項目を変更した場合、変更前後のタイムスタンプには同じ時間（元の日時）が記録される

※ 作成日時以外のタイムスタンプは、イベントログには記録されない

イベントID： 9 （RawAccessRead detected - ディスクの直接読み取りを検知）

・Image： "[検体（timestomp.exe）]"

・確認できる情報

・対象ファイルが存在するデバイス名： Device （"\Device\HarddiskVolume2"）

実行履歴

-

Prefetch

ファイル名： C:\Windows\Prefetch\[検体（TIMESTOMP.EXE）]-[文字列].pf

・確認できる情報 (ツールを利用して下記を確認できる ツール：WinPrefetchView)

・最終実行日時 ：

 Last Run Time

<備考>

記載のもの以外で出力される

可能性のあるイベントログ

-

痕跡の削除 > timestomp

 凡例
・取得出来る情報
・イベントID・項目名
・フィールド名
・"フィールドの値"

追加
設定

必要

必要

-

60603.14.1. wevtutil

<基本情報>

ツール

動作条件

ログから

得られる情報

ツール名称

カテゴリ

ツール概要

攻撃時における

想定利用例

権限

対象OS

ドメインへの参加
通信プロトコル

サービス
標準設定
追加設定

実行成功時に確認できる痕跡

<確認ポイント>

wevtutil
イベントログの削除
Windowsのイベントログを削除する
攻撃の痕跡を削除する
・接続元： wevtutilコマンド実行元
・接続先： wevtutilコマンドによってアクセスされた端末
管理者ユーザー
Windows
不要
135/tcp
Event Log
・イベントログが消去されたことが、消去されたホストの各ログに残る
・ログ消去に使用されたアカウントと、消去コマンドが実行されたホストが確認可能
・接続元： イベントログに以下のログがある場合、ログが消去されたこと考えられる
              ・各対象のイベントログにイベントID: 104 が記録されている

通信

ログの生成場所

ログ種別・名称

取得情報の詳細

OS：Windows

ユーザー

↓

OS：Windows

管理者ユーザー

接続元

接続先

イベントログ

-

セキュリティ

イベントログ

-

Sysmon

イベントログ

-

各対象ログ

イベントログ

-

セキュリティ

イベントID： 4688 （新しいプロセスが作成されました）
                4689 （プロセスが終了しました）
      ・プロセス情報 -> プロセス名：   "C:\Windows\System32\wevtutil.exe"

      ・確認できる情報
            ・プロセスの開始・終了日時 ：                   ログの日付
            ・プロセスを実行したユーザー名 ：            サブジェクト -> アカウント名
            ・プロセスを実行したユーザーのドメイン ：  サブジェクト -> アカウント ドメイン
            ・プロセス実行時の権限昇格の有無 ：       プロセス情報 -> トークン昇格の種類
            ・プロセスの戻り値 ：                               プロセス情報 -> 終了状態

イベントID： 4648 （明示的な資格情報を使用してログオンが試行されました）
      ・プロセス情報 -> プロセス名： "C:\Windows\System32\wevtutil.exe"
      ・プロセス情報 -> プロセスID： イベント4688で記録されたプロセスIDと同じ

      ・確認できる情報
            ・ローカルアカウント：                 サブジェクト -> アカウント名・アカウント ドメイン
            ・接続先で使用されたアカウント： 資格情報が使用されたアカウント -> アカウント名・アカウント ドメイン
            ・接続先ホスト：                         ターゲット サーバー -> ターゲット サーバー名

イベントID： 1 （Process Create）
                5 （Process Terminated）
      ・Image： "C:\Windows\System32\wevtutil.exe"

      ・確認できる情報
            ・プロセスの開始・終了日時（UTC） ：     UtcTime
            ・プロセスのコマンドライン ：                  CommandLine
            ・実行ユーザ名 ：                                 User
            ・プロセスID ：                                      ProcessId

イベントID： 104 （[対象] ログ ファイルが消去されました）

      ・確認できる情報
            ・実行したユーザー： 詳細タブ -> UserData\SubjectUserName・SubjectDomainName
            ・対象ログ名：           詳細タブ -> UserData\Channel

イベントID： 4672 （新しいログオンに特権が割り当てられました）

      ・確認できる情報
            ・権限が昇格したアカウント： サブジェクト -> アカウント名・アカウント ドメイン
            ・利用可能な特権：              特権 （"SeSecurityPrivilege"・"SeRestorePrivilege"・"SeTakeOwnershipPrivilege"・"SeDebugPrivilege"・
                                         "SeSystemEnvironmentPrivilege"・"SeLoadDriverPrivilege"・"SeImpersonatePrivilege"・"SeEnableDelegationPrivilege"）

イベントID： 4624 （アカウントが正常にログオンしました）
      ・ログオン タイプ： "3"

      ・確認できる情報
            ・使用されたセキュリティID： 新しいログオン -> セキュリティID
            ・アカウント：                      アカウント名・アカウント ドメイン
            ・ログオンを要求したホスト： ネットワーク情報 -> ソース ネットワーク アドレス

<備考>

記載のもの以外で出力される

可能性のあるイベントログ

-

イベントログの削除 > wevtutil

  凡例
・取得出来る情報
・イベントID・項目名
・フィールド名
・"フィールドの値"

追加
設定

必要

必要

-

必要

61613.15.1. csvde

<基本情報>

ツール

ツール名称

カテゴリ

ツール概要

攻撃時における

想定利用例

権限

対象OS

動作条件

ドメインへの参加

通信プロトコル

サービス
標準設定

追加設定

ログから

得られる情報

実行成功時に確認できる痕跡

<確認ポイント>

csvde
アカウント情報の取得
Active Directory上のアカウント情報をCSV形式で出力する
存在するアカウントの情報を抽出し、攻撃対象として利用可能なユーザーやクライアントを選択する
・接続元： csvdeコマンド実行元
・接続先： csvdeコマンドによって情報が収集された端末
標準ユーザー
Windows
不要
※ 正しい認証情報を入力すれば、ドメインに参加していない端末からリモートで情報を取得することも可能
389/tcp
Active Directory Domain Services
・接続元： 実行履歴（Prefetch）
・接続元： csvde.exeにより、CSVファイルが作成されたこと
             CSVファイル作成時の一時ファイルとして、"C:\Users\[ユーザー名]\AppData\Local\Temp\csv[ランダム数字].tmp"が作成されたこと
・接続先： 389/tcpの着信と、Kerberosによるログインが記録される
・接続元： csvde.exeが実行されており、"-f"オプションで指定されたファイルが作成されている
             ・"C:\Users\[ユーザー名]\AppData\Local\Temp\csv[ランダム数字].tmp"が作成、削除されている

通信

ログの生成場所

ログ種別・名称

取得情報の詳細

イベントID： 4688 （新しいプロセスが作成されました）
                4689 （プロセスが終了しました）
      ・プロセス情報 -> プロセス名： "[実行ファイル（csvde.exe）]"

      ・確認できる情報
            ・プロセスの開始・終了日時 ：                ログの日付
            ・プロセスを実行したユーザー名 ：         サブジェクト -> アカウント名
            ・プロセスを実行したユーザのドメイン ：  サブジェクト -> アカウント ドメイン
            ・プロセス実行時の権限昇格の有無 ：    プロセス情報 -> トークン昇格の種類
            ・プロセスの戻り値 ：                            プロセス情報 -> 終了状態

イベントID： 5156 （Windows フィルターリング プラットフォームで、接続が許可されました）
      ・アプリケーション情報 -> アプリケーション名： "[実行ファイル（csvde.exe）]"
      ・ネットワーク情報 -> 方向：                          "送信"
      ・ネットワーク情報 -> 宛先アドレス：               "[ドメインコントローラのIPアドレス]"
      ・ネットワーク情報 -> 宛先ポート・プロトコル：  "389"・"6"（TCP）

      ・確認できる情報
            ・接続元ポート： ソース ポート  ※ ドメインコントローラ側ログとの紐付けに使用する

イベントID： 4663 （オブジェクトへのアクセスが試行されました）
                4656 （オブジェクトへのハンドルが要求されました）
                4658 （オブジェクトに対するハンドルが閉じました）
      ・プロセス情報 -> プロセス名： "[実行ファイル（csvde.exe）]"

OS：Windows

ユーザー

↓

OS：Windows

Server

ドメインユーザー

イベントログ

-

セキュリティ

      ・確認できる情報
            ・対象のファイル：                                      オブジェクト -> オブジェクト名 （"C:\Users\[ユーザー名]\AppData\Local\Temp\
                                                                                                                                                                 csv[ランダム数字].tmp"）
            ・ハンドルID（他ログとの紐付けに使用する）： オブジェクト -> ハンドルID
            ・処理内容：                                              アクセス要求情報 -> アクセス （"SYNCHRONIZE"・"WriteData (またはAddFile)"・
                                                                           "AppendData (またはAddSubdirectoryまたはCreatePipeInstance)・"WriteEA"・
            ・成否：                                                    キーワード （"成功の監査"）

接続元

イベントID： 4663 （オブジェクトへのアクセスが試行されました）
                4656 （オブジェクトへのハンドルが要求されました）
                4658 （オブジェクトに対するハンドルが閉じました）
      ・プロセス情報 -> プロセス名：    "[実行ファイル（csvde.exe）]"
      ・オブジェクト -> オブジェクト名： "[csvde.exe 実行時に "-f" オプションで指定したファイル]"

      ・確認できる情報
            ・ハンドルID（他ログとの紐付けに使用する）： オブジェクト -> ハンドルID
            ・処理内容：                                              アクセス要求情報 -> アクセス （"WriteDataまたはAddFile"・"AppendDataまたは
                                                                                                                         AddSubdirectoryまたはCreatePipeInstance"）
            ・成否：                                                    キーワード （"成功の監査"）

イベントID： 4663 （オブジェクトへのアクセスが試行されました）
                4656 （オブジェクトへのハンドルが要求されました）
                4658 （オブジェクトに対するハンドルが閉じました）
      ・プロセス情報 -> プロセス名：    "[実行ファイル（csvde.exe）]"
      ・オブジェクト -> オブジェクト名 （"C:\Users\[ユーザー名]\AppData\Local\Temp\csv[ランダム数字].tmp"）

      ・確認できる情報
            ・ハンドルID： オブジェクト -> ハンドルID   ※ 他のログとの紐付けに使用する
            ・処理内容：  アクセス要求情報 -> アクセス （"DELETE"）
            ・成否：         キーワード （"成功の監査"）

イベントID： 1 （Process Create）
                5 （Process Terminated）
      ・Image： "[実行ファイル（csvde.exe）]"

      ・確認できる情報
            ・プロセスの開始・終了日時（UTC）： UtcTime
            ・プロセスのコマンドライン：             CommandLine   ※ ユーザやファイル名を指定した場合、引数が記録される
            ・実行ユーザー名：                        User
            ・プロセスID：                                ProcessId

ファイル名： C:\Windows\Prefetch\[実行ファイル（CSVDE.EXE）]-[文字列].pf

      ・確認できる情報 (ツールを利用して下記を確認できる ツール：WinPrefetchView)
            ・最終実行日時：                             Last Run Time

イベントID： 5156 （Windows フィルターリング プラットフォームで、接続が許可されました）
      ・アプリケーション情報 -> アプリケーション名：   "\device\harddiskvolume2\windows\system32\lsass.exe"
      ・ネットワーク情報 -> 方向：                             "着信"
      ・ネットワーク情報 -> ソース ポート・プロトコル： "389"・"6"（TCP）
      ・ネットワーク情報 -> 宛先ポート：                     "[csvde.exe を実行したクライアントで記録されたソース ポート]"

      ・確認できる情報
            ・接続元ホスト： 宛先ポート

イベントID： 4624 （アカウントが正常にログオンしました）
                4634 （アカウントがログオフしました）
      ・ログオン タイプ： "3"
      ・ネットワーク情報 -> ソース ネットワーク アドレス： "[イベント5156における、宛先アドレス]"
      ・ネットワーク情報 -> ソース ポート：                      "[イベント5156に記録された、宛先ポート]"

      ・確認できる情報
            ・使用されたユーザー： 新しいログオン -> アカウント名・アカウント ドメイン
            ・新しいログオンID：      新しいログオン -> ログオンID   ※ 他のログとの紐付けに使用する

イベントログ

-

Sysmon

実行履歴

-

Prefetch

接続先

イベントログ

-

セキュリティ

アカウント情報の取得 > csvde

  凡例
・取得出来る情報
・イベントID・項目名
・フィールド名
・"フィールドの値"

追加
設定

必要

必要

-

必要

6262<備考>

記載のもの以外で出力される

可能性のあるイベントログ

-

アカウント情報の取得 > csvde

63633.15.2. ldifde

<基本情報>

ツール

ツール名称

カテゴリ

ツール概要

攻撃時における

想定利用例

権限

対象OS

動作条件

ドメインへの参加

ログから

得られる情報

通信プロトコル

サービス
標準設定

追加設定

実行成功時に確認できる痕跡

<確認ポイント>

ldifde
アカウント情報の取得
AD上のアカウント情報をLDIF形式で出力する
存在するアカウントの情報を抽出し、攻撃対象として利用可能なユーザーやクライアントを選択する
・接続元： ldifdeコマンド実行元
・接続先： ldifdeコマンドによって情報が収集された端末
標準ユーザー
Windows
不要
※正しい認証情報を入力すれば、ドメインに参加していない端末からリモートで情報を取得することも可能
389/tcp
Active Directory Domain Services
・接続元： 実行履歴（Prefetch）
・接続元： ldifde.exeにより、LDIFファイルが作成されたことが記録される
・接続先： 389/tcpの着信と、Kerberosによるログインが記録される
・接続元： ldifde.exeが実行されており、"-f"オプションで指定されたファイルが作成されている

通信

ログの生成場所

ログ種別・名称

取得情報の詳細

イベントID： 4688 （新しいプロセスが作成されました）
                4689 （プロセスが終了しました）
      ・プロセス情報 -> プロセス名： "[実行ファイル（ldifde.exe）]"

      ・確認できる情報
            ・プロセスの開始・終了日時 ：                ログの日付
            ・プロセスを実行したユーザー名 ：         サブジェクト -> アカウント名
            ・プロセスを実行したユーザのドメイン ：  サブジェクト -> アカウント ドメイン
            ・プロセス実行時の権限昇格の有無 ：    プロセス情報 -> トークン昇格の種類
            ・プロセスの戻り値 ：                            プロセス情報 -> 終了状態

イベントID： 5156 （Windows フィルターリング プラットフォームで、接続が許可されました）
      ・アプリケーション情報 -> アプリケーション名： "[実行ファイル（ldifde.exe）]"
      ・ネットワーク情報 -> 方向：                           "送信"
      ・ネットワーク情報 -> 宛先アドレス：                "[ドメインコントローラのIPアドレス]"
      ・ネットワーク情報 -> 宛先ポート・プロトコル：   "389"・"6"（TCP）

イベントログ

-

セキュリティ

      ・確認できる情報
            ・接続元ポート： ソース ポート   ※ ドメインコントローラ側ログとの紐付けに使用する

接続元

イベントID： 4656 （オブジェクトへのハンドルが要求されました）
                4663 （オブジェクトへのアクセスが試行されました）
                4658 （オブジェクトに対するハンドルが閉じました）
      ・プロセス情報 -> プロセス名：    "[実行ファイル（ldifde.exe）]"
      ・オブジェクト -> オブジェクト名： "[ldifde.exe 実行時に "-f" オプションで指定したファイル]"

      ・確認できる情報
            ・ハンドルID： オブジェクト -> ハンドルID  ※ 他ログとの紐付けに使用する
            ・処理内容：   アクセス要求情報 -> アクセス （"WriteDataまたはAddFile"・"AppendDataまたはAddSubdirectoryまたはCreatePipeInstance"）
            ・成否：         キーワード （"成功の監査"）

OS：Windows

ユーザー

↓

OS：Windows

Server

ドメインユーザー

イベントログ

-

Sysmon

実行履歴

-

Prefetch

接続先

イベントログ

-

セキュリティ

イベントID： 1 （Process Create）
                5 （Process Terminated）
      ・Image： "[実行ファイル（ldifde.exe）]"

      ・確認できる情報
            ・プロセスの開始・終了日時（UTC） ：     UtcTime
            ・プロセスのコマンドライン ：                  CommandLine  ※ ユーザーやファイル名を指定した場合、引数が記録される
            ・実行ユーザ名 ：                                 User
            ・プロセスID ：                                      ProcessId

ファイル名： C:\Windows\Prefetch\[実行ファイル（LDIFDE.EXE）]-[文字列].pf

      ・確認できる情報 (ツールを利用して下記を確認できる ツール：WinPrefetchView)
            ・最終実行日時 ：                            Last Run Time

イベントID： 5156 （Windows フィルターリング プラットフォームで、接続が許可されました）
      ・アプリケーション情報 -> アプリケーション名：    "\device\harddiskvolume2\windows\system32\lsass.exe"
      ・ネットワーク情報 -> 方向：                              "着信"
      ・ネットワーク情報 -> ソース ポート・プロトコル： "389"・"6"（TCP）
      ・ネットワーク情報 -> 宛先ポート：                     "[ldifde.exe を実行したクライアントで記録されたソース ポート]"

      ・確認できる情報
            ・接続元ホスト： 宛先ポート
            ・成否：            キーワード

イベントID： 4624 （アカウントが正常にログオンしました）
      ・ログオン タイプ：                                                "3"
      ・ネットワーク情報 -> ソース ネットワーク アドレス： "[イベント5156における、宛先アドレス]"
      ・ネットワーク情報 -> ソース ポート：                      "[イベント5156に記録された、宛先ポート]"

      ・確認できる情報
            ・使用されたユーザ： 新しいログオン -> アカウント名・アカウント ドメイン
            ・新しいログオンID：   新しいログオン -> ログオンID  ※ 他ログとの紐付けに使用

イベントID： 4634 （アカウントがログオフしました）
      ・サブジェクト -> アカウント名・アカウント ドメイン・ログオンID： "[イベント4624で記録されたものと同じ]"

<備考>

記載のもの以外で出力される

可能性のあるイベントログ

-

アカウント情報の取得 > ldifde

  凡例
・取得出来る情報
・イベントID・項目名
・フィールド名
・"フィールドの値"

追加
設定

-

必要

-

必要

64643.15.3. dsquery

<基本情報>

ツール

動作条件

ログから

得られる情報

実行成功時に確認できる痕跡

<確認ポイント>

ツール名称

カテゴリ

ツール概要

攻撃時における

想定利用例

権限

対象OS

dsquery
アカウント情報の取得
ディレクトリサービスより、ユーザーやグループなどの情報を取得する
存在するアカウントの情報を抽出し、攻撃対象として利用可能なユーザーやクライアントを選択する
・接続元： dsqueryコマンド実行元
・接続先： dsqueryコマンドによって情報が収集された端末
標準ユーザー
※ACLの設定によって、標準ユーザー権限では取得出来ない情報が存在する
Windows
不要

ドメインへの参加 ※ 本調査はドメインコントローラ上で実施

通信プロトコル

サービス
標準設定

追加設定

    正しい認証情報を入力すれば、ドメインに参加していない端末からリモートで情報を取得することも可能
389/tcp
Active Directory Domain Services
・接続元： 実行履歴（Prefetch）
・接続元： 実行履歴（Sysmon・監査ポリシー）
・接続先： 389/tcpの着信と、Kerberosによるログインが記録される
イベントログ、実行履歴等では判断できない   ※ 抽出したアカウント情報が保存されている場合は、成功したと判断できる

アカウント情報の取得 > dsquery

  凡例
・取得出来る情報
・イベントID・項目名
・フィールド名
・"フィールドの値"

通信

ログの生成場所

ログ種別・名称

取得情報の詳細

イベントID： 4688 （新しいプロセスが作成されました）
                4689 （プロセスが終了しました）
      ・プロセス情報 -> プロセス名： "[実行ファイル（dsquery.exe）]"

      ・確認できる情報
            ・プロセスの開始・終了日時 ：                ログの日付
            ・プロセスを実行したユーザー名 ：         サブジェクト -> アカウント名
            ・プロセスを実行したユーザのドメイン ：  サブジェクト -> アカウント ドメイン
            ・プロセス実行時の権限昇格の有無 ：    プロセス情報 -> トークン昇格の種類
            ・プロセスの戻り値 ：                            プロセス情報 -> 終了状態

イベントログ

-

セキュリティ

イベントID： 5156 （Windows フィルターリング プラットフォームで、接続が許可されました）
      ・アプリケーション情報 -> アプリケーション名： "[実行ファイル（dsquery.exe）]]"
      ・ネットワーク情報 -> 方向：                          "送信"
      ・ネットワーク情報 -> 宛先アドレス：               "[ドメインコントローラのIPアドレス]"
      ・ネットワーク情報 -> 宛先ポート・プロトコル：  "389"・"6"（TCP）

      ・確認できる情報
            ・接続元ポート： ソース ポート  ※ ドメインコントローラ側ログとの紐付けに使用する

OS：Windows

ユーザー

↓

OS：Windows

Server

ユーザー

接続元

イベントID： 4663 （オブジェクトへのアクセスが試行されました）
                4656 （オブジェクトへのハンドルが要求されました）
                4658 （オブジェクトに対するハンドルが閉じました）
      ・プロセス情報 -> プロセス名：    "[実行ファイル（dsquery.exe）]"
      ・オブジェクト -> オブジェクト名： "C:\Users\[ユーザー名]\AppData\Local\Mirosoft\Windows\SchCache\[ドメイン名].sch"

      ・確認できる情報
            ・ハンドルID： オブジェクト内、ハンドルID   ※ 他ログとの紐付けに使用する
            ・処理内容：  アクセス要求情報内、アクセス （"WriteDataまたはAddFile"・"AppendDataまたはAddSubdirectoryまたはCreatePipeInstance"）
            ・成否：        キーワード （"成功の監査"）

※ イベントID 4656・4663・4658は、既に有効なschファイルが存在する場合は出力されない可能性がある

イベントID： 1 （Process Create）
                5 （Process Terminated）
      ・Image： "[実行ファイル（dsquery.exe）]"

      ・確認できる情報
            ・プロセスの開始・終了日時（UTC）： UtcTime
            ・プロセスのコマンドライン：             CommandLine   ※ ユーザやファイル名を指定した場合、引数が記録される
            ・実行ユーザー名：                        User
            ・プロセスID：                                ProcessId

ファイル名： C:\Windows\Prefetch\[実行ファイル（DSQUERY.EXE）]-[文字列].pf

      ・確認できる情報 (ツールを利用して下記を確認できる ツール：WinPrefetchView)
            ・最終実行日時：                             Last Run Time

イベントログ

-

Sysmon

実行履歴

-

Prefetch

接続先

イベントログ

-

セキュリティ

イベントID： 5156 （Windows フィルターリング プラットフォームで、接続が許可されました）
      ・アプリケーション情報 -> アプリケーション名：   "\device\harddiskvolume2\windows\system32\lsass.exe"
      ・ネットワーク情報 -> 方向：                             "着信"
      ・ネットワーク情報 -> ソース ポート・プロトコル： "389"・"6"（TCP）
      ・ネットワーク情報 -> 宛先ポート：                     "[dsquery.exe を実行したクライアントで記録されたソース ポート]"

      ・確認できる情報
            ・接続元ホスト： 宛先ポート

イベントID： 4624 （アカウントが正常にログオンしました）
                4634 （アカウントがログオフしました）
      ・ログオン タイプ： "3"
      ・ネットワーク情報 -> ソース ネットワーク アドレス： "[イベント5156における、宛先アドレス]"
      ・ネットワーク情報 -> ソース ポート：                      "[イベント5156に記録された、宛先ポート]"

      ・確認できる情報
            ・使用されたユーザー： 新しいログオン -> アカウント名・アカウント ドメイン
            ・新しいログオンID：      新しいログオン -> ログオンID   ※ 他のログとの紐付けに使用する

<備考>

記載のもの以外で出力される

可能性のあるイベントログ

-

追加
設定

必要

必要

-

必要

65653.16. ツールおよびコマンドの実行成功時に見られる痕跡

下表は、ツールおよびコマンドが実行され、攻撃が成功したことを確認する判断基準を記載する。
なお、ログの詳細に関しては、各シートに記載している。

区分

調査対象

成否の判断

PsExec

以下が確認できた場合、PsExecが実行された可能性がある
・接続元： イベントログに以下のログがある場合

・イベントログ「セキュリティ」にpsexec.exeのイベントID 4689 （プロセスが終了しました）が記録され、実行結果（戻り値）が"0x0"となっている

・接続先： PSEXESVC.exeがインストールされている

「接続元」「接続先」において、同時刻に以下のログが確認できる場合、リモート接続が行われた可能性がある
・接続元： イベントログに以下のログがある場合

wmic

・イベントログ「セキュリティ」にWMIC.exeのイベントID 4689 （プロセスが終了しました）が記録され、実行結果（戻り値）が"0x0"となっている

・接続先： Sysmonに以下のログがある場合

・イベントログ「Sysmon」でイベントID 1、5でWmiPrvSE.exeが実行されたことが記録されている

以下のログが同じ時刻に確認できた場合、リモートコマンド実行が行われた可能性がある  ※ Prefetchの場合も同様
・接続元： イベントログに以下のログがある場合

PowerShell

・イベントログ「セキュリティ」にPowerShellのイベントID 4689 （プロセスが終了しました）が記録され、実行結果（戻り値）が"0x0"となっている

・接続先： イベントログに以下のログがある場合

・イベントログ「セキュリティ」にwsmprovhost.exeのイベントID 4689 （プロセスが終了しました）が記録され、実行結果（戻り値）が"0x0"となっている

コマンド実行

wmiexec.vbs

・接続先： "WMI_SHARE"共有が作成され、削除されている

BeginX

WinRM

WinRS

at

BITS

・接続元： 接続先で意図せず許可されているポートと通信をしたことが記録されている
・接続先： 意図しない通信がWindows Firewallで許可されており、該当のポートでリッスンしている検体が存在する

・接続元： 以下のログがある場合、WinRMが実行された可能性がある

・イベントログ「Sysmon」のイベントID:1、5でcscript.exeが接続先にアクセスしたログが記録されている

・イベントログ「アプリケーションとサービス\Microsoft\Windows\Windows Remote Management\Operational」に、WinRSの実行が記録されている

・接続元： イベントログに以下のログがある場合、タスクが登録されたと考えられる

・イベントログ「セキュリティ」にat.exeのイベントID 4689 （プロセスが終了しました）が記録され、実行結果（戻り値）が"0x0"となっている

・接続先： イベントログに以下のログがある場合、タスクが実行されていると考えられる

・イベントログ「\Microsoft\Windows\TaskScheduler\Operational」にイベントID 106（タスクが登録されました）が記録されている
・イベントログ「\Microsoft\Windows\TaskScheduler\Operational」にイベントID 200（開始された操作）、201（操作が完了しました）が記録され、

イベントID 201における戻り値が成功となっている

イベントログに以下のログがある場合、ファイルの転送が行われたと考えられる

・イベントログ「アプリケーションとサービスログ\Microsoft\Windows\Bits-Client」にイベントID: 60が記録されており、状態コードが"0x0"となっている

PWDump7

-

PWDumpX

・接続元： "[検体のパス]\[宛先アドレス]-PWHashes.txt"が作成されている場合、実行が成功したものと考えられる

Quarks PwDump

・一時ファイル（"SAM-[ランダム数字].dmp"）が作成され、削除されている

mimikatz

(パスワードハッシュ入手)

-

mimikatz

(チケット入手)

・チケットを出力したファイルが生成された場合、処理が成功したものと考えられる

WCE

・"C:\Users\[ユーザー名]\AppData\Local\Temp\wceaux.dll"ファイルが作成、削除されている

パスワード、

ハッシュの入手

gsecdump

lslsass

-

-

Find-GPOPasswords.ps1

・パスワードをダンプした結果のファイル（GPPDataReport-[ドメイン名]-[日時].csv）が出力されている

Mail PassView

※ 抽出したパスワードが保存されている場合は、成功したと判断できる

WebBrowserPassView

※ 抽出したパスワードが保存されている場合は、成功したと判断できる

Remote Desktop PassView

※ 抽出したパスワードが保存されている場合は、成功したと判断できる

通信の不正中継

（パケットトンネリング）

リモートログイン

Pass-the-hash,
Pass-the-ticket

SYSTEM権限に昇格

Htran

・接続元： イベントログに以下のログがある場合、通信した可能性がある

・イベントログ「セキュリティ」にイベントID 5156でトンネルホスト・トンネル先ホストとそれぞれ通信したことが記録されている

Fake wpad

・接続元： 本来プロキシやHTTPサーバーで無いはずのホストと、80/tcp及び8888/tcpによる通信をおこなっている
・接続先： 本来プロキシやHTTPサーバーで無いはずのホストが、80/tcp及び8888/tcpをリッスンしている

wpad.dat、proxy.logが作成されている

RDP

WCE

・接続先： イベントログに以下のログがある場合、接続が成功していると考えられる

・イベントログ「セキュリティ」にイベントID: 4624が記録されている
・イベントログ「Microsoft\Windows\TerminalServices-LocalSessionManager\Operational」にイベントID：21、24が記録されている

・接続元： WCESERVICEがインストール・実行されたことが記録されている
・接続先： リモートホストからログオンしたことが記録されている
・両側：

 WMIを用いて通信したことが記録されている

mimikatz

・接続先： イベントログに以下のログがある場合、リモートからログインされていると考えられる

・イベントログ「セキュリティ」にイベントID 4624が記録され、意図しない接続元からアクセスされている

MS14-058 Exploit

・イベント: 4688においてSYSTEM権限で実行されているプロセスにおいて、親プロセスが検体やそのプロセスの親となり得ないものとなっている

MS15-078 Exploit

・イベント: 4688においてSYSTEM権限で実行されているプロセスにおいて、親プロセスが検体やそのプロセスの親となり得ないものとなっている

権限昇格

SDB UAC Bypass

・親プロセス名に、本来は親プロセスとならないことが想定されるアプリケーションを含む、プロセスが実行されたことが記録されている

MS14-068 Exploit

・接続先： イベントログ「セキュリティ」のイベントID 4672において、標準ユーザーに対して上位の特権が認可されている

ドメイン管理者権限、

アカウントの奪取

Golden Ticket

(mimikatz)

Silver Ticket

(mimikatz)

・接続先： イベントログに以下のログがある場合、不正ログオンが実行されていると考えられる

・イベントログ「セキュリティ」のイベントID 4672、4624、4634で、不正なドメインを持つアカウントによるログオンが記録されている

・接続先： イベントログに以下のログがある場合、不正ログオンが実行されていると考えられる

・イベントログ「セキュリティ」のイベントID 4672、4624、4634で、不正なドメインを持つアカウントによるログオンが記録されている

Active Directory

データベースの奪取

（ドメイン管理者ユーザー

の作成、もしくは

管理者グループに追加）

以下が確認できた場合、情報収集が行われている可能性がある
・ntdsutil.exeが実行され、イベントログに以下のログがある場合

ntdsutil

・イベントログ「セキュリティ」にイベントID: 8222が記録されている

・オブジェクト "[システムドライブ]\SNAP_[日時]_VOLUME[ドライブレター]$" に対するハンドルの要求が成功している

※ さらに、通常は読み出せない C:\Windows\NTDS 配下のファイルをコピーしたログ（イベントID: 4663）が記録されている場合、シャドウコピーを利用されている可能性がある

vssadmin

・イベントログ「セキュリティ」にイベントID: 8222が記録されている

イベントログに以下のログがある場合、シャドウコピーが作成されたと考えられる

※ さらに、通常は読み出せない C:\Windows\NTDS 配下のファイルをコピーしたログ（イベントID: 4663）が記録されている場合、シャドウコピーを利用されている可能性がある

6666区分

ローカルユーザー

・グループの
追加・削除

調査対象

net user

net use

・イベントログ「セキュリティ」にイベントID 4720が記録されている

成否の判断

・接続元： イベントログに以下のログがある場合、ファイル共有が行われた可能性がある

・イベントログ「セキュリティ」にnet.exeのイベントID 4689 （プロセスが終了しました）が記録され、実行結果（戻り値）が"0x0"となっている

ファイル共有

net share

・イベントログ「セキュリティ」にイベントID 5142 が記録されている

icacls

sdelete

痕跡の削除

・イベントログ「セキュリティ」にicacls.exeに対するイベントID: 4688及び4689が記録されており、イベントID: 4689中の終了状態が"0x0"となっている

※ イベントID: 4688・4689からは対象ファイルが判断出来ないため、対象の絞り込みにはsysmonのイベントID: 1よりicacls.exeのコマンドラインを併せて確認する必要がある

・以下のような名前のファイルが繰り返し削除されている

・例： 削除対象が sdelete.txt の場合、sdeleAAAAAAAAAAAAAAAAAAAA.AAA、sdeleZZZZZZZZZZZZZZZZZZZZ.ZZZなど

timestomp

・イベントログ「セキュリティ」にイベントID 4663が記録されており、対象ファイルに対する"WriteAttributes"のキーワードが"成功の監査"となっている

イベントログの削除

wevtutil

・各対象のイベントログにイベントID: 104 が記録されている

アカウント情報の取得

csvde

ldifde

・接続元： csvde.exeが実行されており、"-f"オプションで指定されたファイルが作成されている

・"C:\Users\[ユーザー名]\AppData\Local\Temp\csv[ランダム数字].tmp"が作成、削除されている

・接続元： ldifde.exeが実行されており、"-f"オプションで指定されたファイルが作成されている

dsquery

※ 抽出した情報が保存されている場合は、成功したと判断できる

6767インシデント調査のための攻撃ツール等の実行痕跡調査に関する報告書

4. 追加ログ取得について

本章では、3 章に記載した調査結果から分かったデフォルト設定では取得できない詳細ログ取得

の重要性および、追加ログ取得を行うことで考慮すべき事項について説明する。

4.1.  追加ログ取得の重要性

今回の調査で、Windows で標準的に搭載されているツールについては、実行された痕跡がイベン
トログに残るが、Windows に搭載されていないツールのほとんどについては、実行された痕跡がど
こにも残らないことが今回の調査で分かった。例えば、リモートログインのためのツール  RDP
（Remote Desktop Protocol）の場合にはイベントログ「Microsoft¥Windows¥TerminalServices-
LocalSessionManager¥Operational 」 に 、 タ ス ク登 録 用 の ツ ー ル  at  の 場 合 に は イ ベ ン ト ロ グ
「Microsoft¥Windows¥TaskScheduler¥Operational」に、それぞれ実行されたことを示す痕跡が残る。 

それに対して、追加ログ取得のために監査ポリシーの有効化および Sysmon のインストールをし
た環境では、大多数のツールの実行痕跡を取得することが可能であった。例えば、監査ポリシーの

設定をすることによって、一時的なファイルが作成されたことをイベントログに記録することがで
きる。そうすると、csvde を利用して、アカウント情報を収集しようとした際に作成された一時フ
ァイル「C:¥Users¥[ユーザー名]¥AppData¥Local¥Temp¥csv[ランダム数字].tmp」がイベントログに
記録される。ツールが実行されたことを調査する場合は、詳細なログを取得するために、こうした

設定を事前に行っておく必要がある。

なお、詳細なログの取得は、監査ポリシーの有効化および Sysmon のインストールによらずとも、
監査ソフトウエア（資産管理ソフトなど）でも可能な場合がある。それらのソフトウエアで、次の
Windows OS の動作を監視している場合は、監査ポリシーの有効化や Sysmon のインストールをし
た環境と同様の記録が残る可能性がある。

 プロセスの実行

 ファイルの書込み

4.2.  追加ログ取得設定の影響 

追加ログ取得を行う際に事前に考慮しておく必要がある項目として、ログ量の増加が挙げられる。

監査ポリシーを有効化するとログの量が増加するため、ログのローテーションが早くなり古いログ

が残りにくくなる。そのため、監査ポリシーを有効化する場合は、イベントログの最大サイズの変

更もあわせて検討していただきたい。イベントログの最大サイズの変更は、イベントビューアーま
たは wevtutil コマンドで変更可能である。 

なお、イベントログの最大サイズを変更することで、記憶領域を圧迫する恐れがある。イベントロ

グの最大サイズを変更する場合は、検証した上で実施することを推奨する。

6868インシデント調査のための攻撃ツール等の実行痕跡調査に関する報告書

5. インシデント調査における本報告書の活用方法

本章では、本調査報告書の第 3 章を活用したインシデント調査の事例を通じて、インシデント調査

の現場における本調査報告書の利用イメージを述べる。

5.1.  本報告書を使用したインシデント調査 

第 3 章は、インシデント調査時にどのようなツールが実行された可能性があるのかを調査する際
に活用されることを想定して作成した。インシデント調査時に確認された特徴的なイベントログの
イベント ID やファイル名、レジストリエントリなどをキーに検索することで、実行された可能性が
あるツールを探し出すことができる。

インシデント調査時にはイベントログ「セキュリティ」に何か不振なログがないか確認するとこ
ろから着手することが多い。その確認で、例えば「イベント ID:  4663（オブジェクトへのアクセス
が試行されました）」が見つかり、「192.168.100.100-PWHashes.txt」というファイルが一時的に作
成された痕跡があったとする（監査ポリシーを有効化している場合、記録される）。この特徴的な
「PWHashes.txt」という文字列で第 3 章を検索すると、PWDumpX を実行した際に作成されるファ
イルであることが分かる。

さらに、3.3.2 節を参照しつつ調査を進めることにより、PWDumpX は攻撃者がパスワードハッシ
ュを入手するために実行するコマンドであり、また、「[宛先アドレス]-PWHashes.txt」という名前の
一時ファイルが作成されていたことから、IP アドレス 192.168.100.100 のサーバ上のパスワードハ
ッシュを入手すると言う目的を攻撃者が完遂したと推測されることが分かる。

IP アドレス 192.168.100.100 のサーバを、調査すると「C:¥Windows¥System32¥DumpSvc.exe」
というファイルが作成および実行されており、さらにサービス「PWDumpX Service」がインストー
ルされていることが「イベント ID: 7045（サービスがシステムにインストールされました）」として
記録されていることを確認することができる。このことから、IP アドレス 192.168.100.100 のパス
ワードハッシュが攻撃者に入手されていると断定することができる。

3.16 節には各ツールが実行されたことを確認するための方法をまとめている。各ツールで記録さ
れる情報を一覧できるので、インシデントの調査に着手するのに先立って、調査戦略を立てるため

の参考にして欲しい。

6969インシデント調査のための攻撃ツール等の実行痕跡調査に関する報告書 

6.  おわりに 

近年、標的型攻撃によって多くの組織が被害にあっていたことが明るみになる中、その被害の詳

細を調べるインシデント調査は重要度を増しつつある。本報告書では、そのようなインシデント調

査において鍵となる、ツールが実行されたことを示す痕跡情報とツールとの対応関係を整理して示
した。 

Windows のデフォルト設定のままでは、多くのツールについて実行の痕跡が残らず、インシデン
ト調査も迷宮入りしかねない。攻撃者が何をしたのかをより詳細に分析するためには、デフォルト
設定で取得できる以上のログを収集できる環境を事前に整備しておくことが必要である。 

ネットワーク内部への侵入を阻止するのが難しい現状においては、インシデント発生後の被害状

況調査のためにログの取得方法について日頃から検討し、改善しておくことは、被害拡散防止や事
後のセキュリティ対策を検討する上でも重要である。本書で示した Windows の標準機能を利用した
追加ログ取得方法に限らず、監査アプリケーションを使用する方法など組織に合わせた対応を検討

して備えを固めるとともに、インシデントの発生が疑われる場合には、攻撃者によるツール等の実

行痕跡を洗い出すために本報告書を活用していただきたい。深刻化する標的型攻撃を早期に発見し
的確に対処するために本報告書が一助となれば幸いである。 

 
 

7070インシデント調査のための攻撃ツール等の実行痕跡調査に関する報告書 

7.  付録  A 

本章では、Sysmon のインストール方法および監査ポリシーの有効化方法について記載する。な
お、監査ポリシーの設定および Sysmon のインストールを行うことで、イベントログの量が増大す
ることを確認している。実際に行う場合は、事前に検証することを推奨する。 

7.1. 

Sysmon のインストール方法 

1.  以下のサイトから Sysmon をダウンロードする。 

https://technet.microsoft.com/ja-jp/sysinternals/dn798348 

2.  管理者権限でコマンド  プロンプトを実行し、以下のコマンドを実行する。 

> Sysmon.exe -i 

※  オプション「-n」を追加することで、通信のログを取得できるようになるが、通信に関しては

監査ポリシーで対応する。 

7.2.  監査ポリシーの有効化方法 

以下では、ローカル  コンピュータに対して監査ポリシーを有効にする方法を説明する。なお、以

降の設定方法は Windows 10 で設定を行った場合を示す。 

1.  ローカル  グループ  ポリシー  エディター  を開く。（[検索]  ボックスに「gpedit.msc」と入力

し、実行する。） 

2. 

[コンピューターの構成]→[Windows の設定]→[セキュリティの設定]  →[ローカル  ポリシー]
→[監査ポリシー]を選択し、各ポリシーの「成功」「失敗」を有効にする。 

 

 
 

7171インシデント調査のための攻撃ツール等の実行痕跡調査に関する報告書

3.

[ローカル  ディスク(C:)]→[プロパティ]→[セキュリティ]タブ→[詳細設定]を選択する。

4.

[監査]タブから監査対象のオブジェクトを追加する。

7272インシデント調査のための攻撃ツール等の実行痕跡調査に関する報告書

5. 以下のように監査対象のユーザおよび、監査するアクセス方法を選択する。

今回設定した「アクセス許可」は以下の通り。（ファイルの読み取りも記録することで、より詳細

な調査が可能になるが、ログの量が増大するため、対象外にしている。）

 ファイルの作成/データ書き込み
 フォルダーの作成/データの追加
 属性の書き込み

 拡張属性の書き込み

 サブフォルダ―とファイルの削除

 削除

 アクセス許可の変更

 所有権の取得

7373インシデント調査のための攻撃ツール等の実行痕跡調査に関する報告書

上記設定を行うことで、以下のエラーが多数表示されるが、「続行」する。

74748. 付録 B

本一覧には、「初期設定で記録されるログ」および「監査ポリシーの設定およびSysmonのインストールを行うことで追加設定することで記録されるログ」を記載する。
なお、すべての取得可能なログを記載するわけではなく、インシデント調査に活用できるログを抜粋して記載している。

対象

ログ

入手方法

設定箇所

識別子

イベント名

概要

取得可能なログ

セキュリティ

システム

104 ログの消去

7036 サービスの状態が移行しました

ログの消去
サービス状態の変動
(実行・停止共に同じイベントID)

7045

サービスがシステムにインストールされ
ました

サービスのインストール

Windowsの初期設定で記録される

20001 デバイスのインストール

デバイスドライバーのインストール

8222 シャドウ コピーが作成されました

シャドウコピーの作成

4624 アカウントが正常にログオンしました アカウントのログオン

ログオン/ログオフ
> ログオンの監査

4634 アカウントがログオフしました

アカウントのログオフ

取得可能な主な情報

・消去されたログのチャンネル
・サービス名
・状態
・サービス名
・実行ファイル名
・サービスの種類
・起動タイプ
・サービスアカウント
・デバイス インスタンスID
・ドライバー名
・成否
・アカウント名・ドメイン
・シャドウコピーのUUID
・コンピューター名
・シャドウコピーの作成元
・作成されたシャドウデバイス名
・セキュリティID
・アカウント名・ドメイン
・ログオンID

他イベントログとの紐付けに使用する

・ログオン タイプ

主要なものでは、2 = ローカル対話型、3

= ネット

ワーク、10 = リモート対話型 など

・プロセスID
・プロセス名
・ログイン元： ワークステーション名・
ソース ネット

ワーク アドレス・ソース ポート

・認証の手法： 認証パッケージ
・セキュリティID
・アカウント名・ドメイン
・ログオンID
・ログオン タイプ
・実行アカウントの情報： サブジェクト内

・セキュリティID
・アカウント名・ドメイン
・ログオンID

・資格情報が使用されたアカウント

・アカウント名・ドメイン

4648

明示的な資格情報を使用してログオンが
試行されました

特定のアカウントが指定されたログ
オン試行

・ターゲットサーバー

・ターゲットサーバー名

4656

オブジェクトに対するハンドルが要求さ
れました

オブジェクトの読み書きを目的とし
たハンドル要求

オブジェクト アクセス
> ハンドル操作の監査

4658

オブジェクトに対するハンドルが閉じま
した

ハンドルの利用の終了および開放

全体に共通

Windowsログ

オブジェクト アクセス

4690

オブジェクトに対するハンドルの複製が
試行されました

既存のハンドルが、他のプロセスで
利用可能なように複製された

4660 オブジェクトが削除されました

オブジェクトの削除

4663

オブジェクトへのアクセスが試行されま
した

オブジェクトに対するアクセスの発
生

セキュリティ

（監査ポリシー）

各監査を有効化する。ファイ
ルシステムに対する監査につ
いては、SACLの設定も必要。
各ログは、「Windowsログ >
セキュリティ」内に保存され

る。

オブジェクト アクセス
> SAMの監査

4661

SAM - A handle to an object was
requested

SAMに対するハンドル要求
(取得可能な情報はイベント4656と
同様)

特権の使用

詳細追跡
> プロセス作成の監査

詳細追跡
> プロセス終了の監査

アカウントの管理
> ユーザー アカウントの
管理の監査

アカウントの管理
> セキュリティ グループ
の管理の監査

4672

新しいログオンに特権が割り当てられま
した

特定のログオンインスタンスに対す
る特権の割り当て

4673 特権のあるサービスが呼び出されました 特定の特権が必要な処理の実行

4688 新しいプロセスが作成されました

プロセスの起動

4689 プロセスが終了しました

プロセスの終了

4720 ユーザー アカウントが作成されました アカウントの作成

4726 ユーザー アカウントが削除されました アカウントの削除

4728

セキュリティが有効なグローバル グ
ループにメンバーが追加されました

グループへのメンバー追加
(ドメイン上のグループに追加され
た場合に使用される)

4729

セキュリティが有効なグローバル グ
ループにメンバーが削除されました

グループからのメンバー削除
(ドメイン上のグループから削除さ
れた場合に使用される)

・プロセス情報
・プロセスID
・プロセス名

・ネットワーク情報

・ネットワーク アドレス
・ポート

・アカウント名・ドメイン
・ハンドルの対象： オブジェクト名
・ハンドルID

他イベントログとの紐付けに使用する

・プロセスID
・プロセス名
・アカウント名・ドメイン
・ハンドルID
・プロセスID
・プロセス名
・アカウント名・ドメイン
・複製元ハンドルID
・複製元プロセスID
・複製先ハンドルID
・複製先プロセスID
・アカウント名・ドメイン
・ハンドルID
・プロセスID
・プロセス名
・アカウント名・ドメイン
・ログオンID
・オブジェクト名
・ハンドルID
・プロセス名
・プロセスID
・要求された処理
・アカウント名・ドメイン
・ハンドルの対象： オブジェクト名
・ハンドルID

他イベントログとの紐付けに使用する

・プロセスID
・プロセス名
・セキュリティID
・実行アカウント名・ドメイン
・ログオンID
・割り当てられた特権
・セキュリティID
・アカウント名・ドメイン
・サービス名
・プロセスID
・プロセス名
・使用された特権
・アカウント名・ドメイン
・プロセスID
・プロセス名
・権限昇格の有無： トークン昇格の種類
・親プロセスID： クリエーター プロセスID
・アカウント名・ドメイン
・プロセスID
・プロセス名
・戻り値： 終了状態
・実行アカウントの情報： サブジェクト内

・セキュリティID
・アカウント名・ドメイン
・ログオンID

・追加対象アカウントの情報： 新しいアカ
ウント内

・セキュリティID
・アカウント名・ドメイン

・その他の属性情報
・実行アカウントの情報： サブジェクト内

・セキュリティID
・アカウント名・ドメイン
・ログオンID

・削除対象アカウントの情報： ターゲット
アカウント内

・セキュリティID
・アカウント名・ドメイン

・実行アカウントの情報： サブジェクト内

・セキュリティID
・アカウント名・ドメイン
・ログオンID

・対象ユーザー： メンバー内

・セキュリティID
・アカウント名

・対象グループ： グループ内

・セキュリティID
・グループ名
・グループ ドメイン

・実行アカウントの情報： サブジェクト内

・セキュリティID
・アカウント名・ドメイン
・ログオンID

・対象ユーザー： メンバー内

・セキュリティID
・アカウント名

・対象グループ： グループ内

・セキュリティID
・グループ名
・グループ ドメイン

7575対象

ログ

入手方法

設定箇所

識別子

イベント名

概要

取得可能なログ

Windowsログ

（続）

セキュリティ

（監査ポリシー）

（続）

〃

全体に共通

（続）

4768

Kerberos認証チケット（TGT）が要求さ
れました

アカウントに関する認証の要求

4769

Kerberosサービスチケットが要求されま
した

アカウントに関するアクセスの認可
要求

4946

Windows ファイアウォールの例外の一覧
が変更されました

Windowsファイアウォールのルール
追加

・プロファイル
・対象のルール名

アカウント ログオン
> Kerberos 認証サービス
の監査

アカウント ログオン
> Kerberos サービス チ
ケット操作の監査

ポリシーの変更
> MPSSVC ルールレベル
ポリシーの変更の監査

オブジェクト アクセス
> ファイル共有の監査

5140

ネットワーク共有オブジェクトにアクセ
スしました

ネットワーク共有へのアクセス

5142

ネットワーク共有オブジェクトが追加さ
れました

ネットワーク共有を新規に作成

5144

ネットワーク共有オブジェクトが削除さ
れました

ネットワーク共有の削除

オブジェクト アクセス
> 詳細なファイル共有の
監査

5145

5154

ネットワーク共有オブジェクトに対す
る、クライアントのアクセス権をチェッ
クしました

ファイル共有ポイントの利用可否の
確認

Windows フィルターリング プラット
フォームで、アプリケーションまたは
サービスによるポートでの着信接続の
リッスンが許可されました

アプリケーション又はサービスによ
るポートリッスン

オブジェクト アクセス
> フィルタリング プラッ
トフォームの接続の監査

5156

Windowsフィルターリング プラット
フォームで、接続が許可されました

Windowsフィルターリング プラット
フォーム（Windowsファイアウォー
ル）による接続の許可
(拒否の場合は異なるイベントID
（5152）が記録される)

取得可能な主な情報

・アカウント名・ドメイン
・セキュリティID
・送信元アドレス・ソースポート
・チケットオプション
・戻り値
・アカウント名・ドメイン・ログオンID
・サービス名・サービスID
・クライアントアドレス・ポート
・チケットオプション

・セキュリティID
・アカウント名・ドメイン
・ログオンID
・送信元アドレス・ソースポート
・共有名
・共有パス
・要求された処理
・セキュリティID
・アカウント名・ドメイン
・共有名
・共有パス
・セキュリティID
・アカウント名・ドメイン
・共有名
・共有パス
・セキュリティID
・アカウント名・ドメイン
・ログオンID
・送信元アドレス・ソースポート
・共有名
・共有パス・相対ターゲット名
・プロセスID
・プロセス名
・アドレス・ポート
・プロトコル番号
・プロセスID
・プロセス名
・方向（送信・着信）
・送信元アドレス・ソースポート

送信時は自身、着信時は接続元の情報とな

る
・宛先アドレス・宛先ポート

送信時は接続先・着信時は自身の情報とな

る
・プロトコル番号
・プロセスの開始日時： UtcTime
・プロセスのコマンドライン： CommandLine
実行ファイルに渡されたオプションが記録

される。

オプション内で他ホストのIPアドレスや

・プロセスの終了日時： UtcTime
・プロセスID： ProcessId
・スレッドの作成日時： UtcTime
・呼出元プロセスID： SourceProcessId
・呼出元プロセス名： SourceImage
・呼出先プロセスID： TargetProcessId
・呼出先プロセス名： TargetImage
・実行アカウント名・ドメイン
・作成したタスク名
・タスク名
・実行した操作
・タスク名
・プロセスID
・実行されたプロセス
・タスク名
・終了したプロセス
・戻り値
・実行アカウント名・ドメイン
・タスク名

Sysmon

Microsoft社のサイトからダウ
ンロード
https://technet.microsoft.c
om/ja-
jp/sysinternals/bb842062

アプリケーションとサー
ビスログ
> Microsoft
> Windows
> Sysmon
> Operational

1

5

8

Process Create

プロセスの起動

Process Terminated

プロセスの終了

CreateRemoteThread detected

他のプロセスからスレッドを新規に
作成

at

アプリケー

ション

とサービス

Microsoft
> Windows

> TaskScheduler

> Operational

WinRM・WinRS

RDP

 Microsoft >

Windows

> Windows Remote

Management >
Operational

Microsoft > Windows
> TerminalServices

>

LocalSessionManager

> Operational

106 タスクが登録されました

タスクの新規登録

200 開始された操作

タスクの実行

129 タスクのプロセスが作成されました

タスク内でのプロセス実行

201 操作が完了しました

タスク内で実行されたプロセスの終
了

102 タスクが完了しました

タスクの終了

Windowsの初期設定で記録される

6

WSManセッションを作成しています

新規のセッション作成

・接続先ホスト名

169

ユーザーの認証： 正常に認証されまし
た

ユーザー認証

21

24

リモートデスクトップサービスのセッ
ション ログオンに成功しました

RDPで新規にログオン

リモートデスクトップサービスのセッ
ションが切断されました

RDPセッションの切断

・ユーザー名・ドメイン

・セッションの接続開始日時
・実行アカウント名・ドメイン
・ソースネットワークアドレス
・セッションの接続開始日時
・実行アカウント名・ドメイン
・ソースネットワークアドレス

7676インシデント調査のための攻撃ツール等の実行痕跡調査に関する報告書

索引 

A 

N 

at  ........................................................................... 22 

net share ................................................................. 57 

B 

net use ..................................................................... 56 

net user ................................................................... 55 

BeginX .................................................................... 17 

ntdsutil ..................................................................... 53 

BITS ........................................................................ 24 

C 

P 

PowerShell .............................................................. 14 

csvde ...................................................................... 62 

PsExec .................................................................... 11 

D 

PWDump7 ............................................................... 25 

PWDumpX ............................................................... 26 

dsquery ................................................................... 65 

F 

Q 

Quarks PwDump ..................................................... 28 

Fake wpad .............................................................. 39 

Find-GPOPasswords.ps1 ....................................... 34 

R 

G 

RDP ......................................................................... 41 

Remote Desktop PassView ..................................... 37 

gsecdump ............................................................... 32 

H 

S 

SDB UAC Bypass .................................................... 47 

Htran ....................................................................... 38 

sdelete ..................................................................... 59 

I 

T 

icacls ....................................................................... 58 

timestomp ................................................................ 60 

L 

V 

ldifde ....................................................................... 64 

vssadmin ................................................................. 54 

lslsass ..................................................................... 33 

M 

W 

WCE .................................................................. 31, 42 

Mail PassView......................................................... 35 

WebBrowserPassView ............................................ 36 

Mimikatz .......................................... 29, 30, 44, 51, 52 

wevtutil .................................................................... 61 

MS14-058 Exploit ................................................... 45 

WinRM ..................................................................... 18 

MS14-068 Exploit ................................................... 49 

WinRS ..................................................................... 20 

MS15-078 Exploit ................................................... 46 

wmic ........................................................................ 13 

wmiexec.vbs ............................................................ 15 

7777本文書内に記載されている情報により生じるいかなる損失または損害に対して、JPCERT/CC は
責任を負うものではありません。 

7878